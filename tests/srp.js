
// Vectors from https://wiki.mozilla.org/Identity/AttachedServices/KeyServerProtocol
tests.test_srp = function(callback, test)
{
    var user = lib.getArg("-user", 'andr√©@example.org');
    var secret = lib.getArg("-secret") || Buffer.from('00f9b71800ab5337d51177d8fbc682a3653fa6dae5b87628eeec43a18af59a9d', "hex");
    var salt = lib.getArg("-salt", '00f1000000000000000000000000000000000000000000000000000000000179');
    var a = lib.getArg("-a", "f2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d3d7");
    var b = lib.getArg("-b", "f3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f");
    var k = lib.getArg("-k", "5b9e8ef059c6b32ea59fc1d322d37f04aa30bae5aa9003b8321e21ddb04e300");
    var v = lib.getArg("-v", "173ffa0263e63ccfd6791b8ee2a40f048ec94cd95aa8a3125726f9805e0c8283c658dc0b607fbb25db68e68e93f2658483049c68af7e8214c49fde2712a775b63e545160d64b00189a86708c69657da7a1678eda0cd79f86b8560ebdb1ffc221db360eab901d643a75bf1205070a5791230ae56466b8c3c1eb656e19b794f1ea0d2a077b3a755350208ea0118fec8c4b2ec344a05c66ae1449b32609ca7189451c259d65bd15b34d8729afdb5faff8af1f3437bbdc0c3d0b069a8ab2a959c90c5a43d42082c77490f3afcc10ef5648625c0605cdaace6c6fdc9e9a7e6635d619f50af7734522470502cab26a52a198f5b00a279858916507b0b4e9ef9524d6");
    var B = lib.getArg("-B", "22ce5a7b9d81277172caa20b0f1efb4643b3becc53566473959b07b790d3c3f08650d5531c19ad30ebb67bdb481d1d9cf61bf272f8439848fdda58a4e6abc5abb2ac496da5098d5cbf90e29b4b110e4e2c033c70af73925fa37457ee13ea3e8fde4ab516dff1c2ae8e57a6b264fb9db637eeeae9b5e43dfaba9b329d3b8770ce89888709e026270e474eef822436e6397562f284778673a1a7bc12b6883d1c21fbc27ffb3dbeb85efda279a69a19414969113f10451603065f0a012666645651dde44a52f4d8de113e2131321df1bf4369d2585364f9e536c39a4dce33221be57d50ddccb4384e3612bbfd03a268a36e4f7e01de651401e108cc247db50392");
    var A = lib.getArg("-A", "7da76cb7e77af5ab61f334dbd5a958513afcdf0f47ab99271fc5f7860fe2132e5802ca79d2e5c064bb80a38ee08771c98a937696698d878d78571568c98a1c40cc6e7cb101988a2f9ba3d65679027d4d9068cb8aad6ebff0101bab6d52b5fdfa81d2ed48bba119d4ecdb7f3f478bd236d5749f2275e9484f2d0a9259d05e49d78a23dd26c60bfba04fd346e5146469a8c3f010a627be81c58ded1caaef2363635a45f97ca0d895cc92ace1d09a99d6beb6b0dc0829535c857a419e834db12864cd6ee8a843563b0240520ff0195735cd9d316842d5d3f8ef7209a0bb4b54ad7374d73e79be2c3975632de562c596470bb27bad79c3e2fcddf194e1666cb9fc");
    var x = lib.getArg("-x", "b5200337cc3f3f926cdddae0b2d31029c069936a844aff58779a545be89d0abe");
    var K = lib.getArg("-K", "e68fd0112bfa31dcffc8e9c96a1cbadb4c3145978ff35c73e5bf8d30bbc7499a");
    var M = lib.getArg("-M", "27949ec1e0f1625633436865edb037e23eb6bf5cb91873f2a2729373c2039008");
    var S = lib.getArg("-S", "92aaf0f527906aa5e8601f5d707907a03137e1b601e04b5a1deb02a981f4be037b39829a27dba50f1b27545ff2e28729c2b79dcbdd32c9d6b20d340affab91a626a8075806c26fe39df91d0ad979f9b2ee8aad1bc783e7097407b63bfe58d9118b9b0b2a7c5c4cdebaf8e9a460f4bf6247b0da34b760a59fac891757ddedcaf08eed823b090586c63009b2d740cc9f5397be89a2c32cdcfe6d6251ce11e44e6ecbdd9b6d93f30e90896d2527564c7eb9ff70aa91acc0bac1740a11cd184ffb989554ab58117c2196b353d70c356160100ef5f4c28d19f6e59ea2508e8e8aac6001497c27f362edbafb25e0f045bfdf9fb02db9c908f10340a639fe84c31b27");
    var u = lib.getArg("-u", "b284aa1064e8775150da6b5e2147b47ca7df505bed94a6f4bb2ad873332ad732");

    auth.srp.init();
    logger.info("user:", user, secret, "salt:", salt, "k:", auth.srp.k.toString(16) == k);

    var r = auth.srp.verifier(user, secret, salt);
    logger.info("r:", r, "v:", r[1] == v, "x:", r[2] == x);

    var c1 = auth.srp.client1(a)
    logger.info("c1:", c1, "A:", c1[1] == A);

    var s1 = auth.srp.server1(r[1], b);
    logger.info("s1:", s1, "B:", s1[1] == B)

    var c2 = auth.srp.client2(user, secret, r[0], c1[0], s1[1])
    logger.info("c2:", c2, "K:", c2[0] == K, "M:", c2[1] == M, "S:", c2[2] == S, "u:", c2[3] == u, "x:", c2[4] == x, "A:", c2[5] == A);

    var s2 = auth.srp.server2(user, r[1], s1[0], c1[1], c2[1])
    logger.info("s2:", s2, "S:", s2[1] == S, "u:", s2[2] == u)

    var c3 = auth.srp.client3(c1[1], c2[1], c2[0], s2[0])
    logger.info("c3:", c3)

    callback();
}

