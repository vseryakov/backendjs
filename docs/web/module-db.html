<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>db - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Counter.html">Counter</a><ul class='typedefs'></ul></li><li><a href="Pool.html">Pool</a><ul class='typedefs'></ul></li><li><a href="WebpushClient.html">WebpushClient</a><ul class='typedefs'></ul></li><li><a href="module-Fetch.FetchRequest.html">FetchRequest</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-Fetch.FetchRequest.html#parseCookies">parseCookies</a></li><li data-type='method' style='display: none;'><a href="module-Fetch.FetchRequest.html#toJSON">toJSON</a></li></ul><ul class='typedefs'></ul></li><li><a href="module-cache.CacheClient.html">CacheClient</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-cache.CacheClient.html#get">get</a></li><li data-type='method' style='display: none;'><a href="module-cache.CacheClient.html#limiter">limiter</a></li></ul><ul class='typedefs'></ul></li><li><a href="module-cache.LocalClient.html">LocalClient</a><ul class='typedefs'></ul></li><li><a href="module-cache.RedisClient.html">RedisClient</a><ul class='typedefs'></ul></li><li><a href="module-cache.WorkerClient.html">WorkerClient</a><ul class='typedefs'></ul></li><li><a href="module-db.db.Pool.html">db.Pool</a><ul class='typedefs'></ul></li><li><a href="module-db.db.SqlPool.html">db.SqlPool</a><ul class='typedefs'></ul></li><li><a href="module-db_elasticsearch.ElasticsearchPool.html">ElasticsearchPool</a><ul class='typedefs'></ul></li><li><a href="module-queue.EventBridgeClient.html">EventBridgeClient</a><ul class='typedefs'></ul></li><li><a href="module-queue.JSONClient.html">JSONClient</a><ul class='typedefs'></ul></li><li><a href="module-queue.LocalClient.html">LocalClient</a><ul class='typedefs'></ul></li><li><a href="module-queue.NatsClient.html">NatsClient</a><ul class='typedefs'></ul></li><li><a href="module-queue.QueueClient.html">QueueClient</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-queue.QueueClient.html#channel">channel</a></li><li data-type='method' style='display: none;'><a href="module-queue.QueueClient.html#monitor">monitor</a></li><li data-type='method' style='display: none;'><a href="module-queue.QueueClient.html#schedule">schedule</a></li></ul><ul class='typedefs'></ul></li><li><a href="module-queue.RedisClient.html">RedisClient</a><ul class='typedefs'></ul></li><li><a href="module-queue.SNSClient.html">SNSClient</a><ul class='typedefs'></ul></li><li><a href="module-queue.SQSClient.html">SQSClient</a><ul class='typedefs'></ul></li><li><a href="module-queue.WorkerClient.html">WorkerClient</a><ul class='typedefs'></ul></li></ul><h3>Modules</h3><ul><li><a href="module-Fetch.html">Fetch</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-Fetch.html#~Fetch">Fetch</a></li></ul><ul class='typedefs'></ul></li><li><a href="module-api.html">api</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api.html#.api.checkProxy">api.checkProxy</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.checkRateLimits">api.checkRateLimits</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.checkRedirectPlaceholders">api.checkRedirectPlaceholders</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.cleanupHeaders">api.cleanupHeaders</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.cleanupResult">api.cleanupResult</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.createServer">api.createServer</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.getResultPage">api.getResultPage</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.getTokenSecret">api.getTokenSecret</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.handleBody">api.handleBody</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.handleCleanup">api.handleCleanup</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.handleMetrics">api.handleMetrics</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.handleMultipart">api.handleMultipart</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.init">api.init</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.prepareOptions">api.prepareOptions</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.prepareRequest">api.prepareRequest</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.registerPreHeaders">api.registerPreHeaders</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.registerRateLimits">api.registerRateLimits</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.sendFile">api.sendFile</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.sendFormatted">api.sendFormatted</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.sendJSON">api.sendJSON</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.sendReply">api.sendReply</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.sendStatus">api.sendStatus</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.shutdown">api.shutdown</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.startMetrics">api.startMetrics</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.toParams">api.toParams</a></li></ul><ul class='typedefs'></ul></li><li><a href="module-app.html">app</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-app.html#.app.addModule">app.addModule</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.checkConfig">app.checkConfig</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.createRepl">app.createRepl</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.fetch">app.fetch</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.init">app.init</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.isOk">app.isOk</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.killBackend">app.killBackend</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.loadModules">app.loadModules</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.loadPackages">app.loadPackages</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.parseArgs">app.parseArgs</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.parseConfig">app.parseConfig</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.processArg">app.processArg</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.processArgs">app.processArgs</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.processEnvArgs">app.processEnvArgs</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.processName">app.processName</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.runMethods">app.runMethods</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.setHome">app.setHome</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.setHost">app.setHost</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.setLogInspect">app.setLogInspect</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.showHelp">app.showHelp</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.shutdown">app.shutdown</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.sortModules">app.sortModules</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.start">app.start</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.startRepl">app.startRepl</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.watchTmp">app.watchTmp</a></li></ul><ul class='typedefs'></ul></li><li><a href="module-aws.html">aws</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.cwGetMetricData">aws.cwGetMetricData</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.cwListMetrics">aws.cwListMetrics</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.cwPutLogEvents">aws.cwPutLogEvents</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.cwPutMetricAlarm">aws.cwPutMetricAlarm</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.cwPutMetricData">aws.cwPutMetricData</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.cwlFilterLogEvents">aws.cwlFilterLogEvents</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.ddbBatchGetItem">aws.ddbBatchGetItem</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.ddbBatchWriteItem">aws.ddbBatchWriteItem</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.ddbCreateTable">aws.ddbCreateTable</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.ddbDeleteItem">aws.ddbDeleteItem</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.ddbDeleteTable">aws.ddbDeleteTable</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.ddbDescribeTable">aws.ddbDescribeTable</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.ddbGetItem">aws.ddbGetItem</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.ddbPutItem">aws.ddbPutItem</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.ddbQueryTable">aws.ddbQueryTable</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.ddbScanTable">aws.ddbScanTable</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.ddbTransactWriteItems">aws.ddbTransactWriteItems</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.ddbUpdateItem">aws.ddbUpdateItem</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.ddbUpdateTable">aws.ddbUpdateTable</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.ddbUpdateTimeToLive">aws.ddbUpdateTimeToLive</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.ddbWaitForTable">aws.ddbWaitForTable</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.queryCW">aws.queryCW</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.queryCWL">aws.queryCWL</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.querySQS">aws.querySQS</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.sqsReceiveMessage">aws.sqsReceiveMessage</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.sqsSendMessage">aws.sqsSendMessage</a></li></ul><ul class='typedefs'></ul></li><li><a href="module-cache.html">cache</a><ul class='typedefs'></ul></li><li><a href="module-db.html">db</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-db.html#.aquery">aquery</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.add">db.add</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.batch">db.batch</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.bulk">db.bulk</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.cacheColumns">db.cacheColumns</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.configTypes">db.configTypes</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.copy">db.copy</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.create">db.create</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.createTables">db.createTables</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.del">db.del</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.delAll">db.delAll</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.describeTables">db.describeTables</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.drop">db.drop</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.dropTables">db.dropTables</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.get">db.get</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.getPool">db.getPool</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.incr">db.incr</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.init">db.init</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.initColumns">db.initColumns</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.initConfig">db.initConfig</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.initTables">db.initTables</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.join">db.join</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.list">db.list</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.prepare">db.prepare</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.prepareColumn">db.prepareColumn</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.prepareForUpdate">db.prepareForUpdate</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.prepareReq">db.prepareReq</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.put">db.put</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.queryProcessSync">db.queryProcessSync</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.refreshColumns">db.refreshColumns</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.scan">db.scan</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.search">db.search</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.select">db.select</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.setConfig">db.setConfig</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.sql">db.sql</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.sqlCreate">db.sqlCreate</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.sqlExpr">db.sqlExpr</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.sqlWhere">db.sqlWhere</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.transaction">db.transaction</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.update">db.update</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.updateAll">db.updateAll</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.db.upgrade">db.upgrade</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.query">query</a></li></ul><ul class='typedefs'><li data-type='typedef' style='display: none;'><a href="module-db.html#~DBRequest">DBRequest</a></li><li data-type='typedef' style='display: none;'><a href="module-db.html#~DBRequestOptions">DBRequestOptions</a></li><li data-type='typedef' style='display: none;'><a href="module-db.html#~DBResultCallback">DBResultCallback</a></li></ul></li><li><a href="module-db_elasticsearch.html">db/elasticsearch</a><ul class='typedefs'></ul></li><li><a href="module-events.html">events</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-events.html#.events.putEvent">events.putEvent</a></li></ul><ul class='typedefs'></ul></li><li><a href="module-ipc.html">ipc</a><ul class='typedefs'></ul></li><li><a href="module-jobs.html">jobs</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-jobs.html#~_badJob">_badJob</a></li></ul><ul class='typedefs'></ul></li><li><a href="module-lib.html">lib</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-lib.html#.lib.configParse">lib.configParse</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.lib.jsonParse">lib.jsonParse</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.lib.xmlParse">lib.xmlParse</a></li></ul><ul class='typedefs'></ul></li><li><a href="module-logger.html">logger</a><ul class='typedefs'></ul></li><li><a href="module-logwatcher.html">logwatcher</a><ul class='typedefs'></ul></li><li><a href="module-metrics.html">metrics</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-metrics.html#.toJSON">toJSON</a></li></ul><ul class='typedefs'></ul></li><li><a href="module-push.html">push</a><ul class='typedefs'></ul></li><li><a href="module-queue.html">queue</a><ul class='typedefs'></ul></li><li><a href="module-sendmail.html">sendmail</a><ul class='typedefs'></ul></li><li><a href="module-stats.html">stats</a><ul class='typedefs'></ul></li><li><a href="module-ws.html">ws</a><ul class='typedefs'></ul></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-README.html">README</a><ul class='typedefs'></ul></li><li><a href="tutorial-configureModules.html">configureModules</a><ul class='typedefs'></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#ExponentiallyMovingWeightedAverage">ExponentiallyMovingWeightedAverage</a></li><li><a href="global.html#Meter">Meter</a></li><li><a href="global.html#_skip32table">_skip32table</a></li><li><a href="global.html#lib">lib</a></li><li><a href="global.html#mod">mod</a></li><li><a href="global.html#net">net</a></li><li><a href="global.html#perf_hooks">perf_hooks</a></li><li><a href="global.html#runMethod">runMethod</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">db</h1>
    

    




<section>

<header>
    
        
            
        
    
</header>

<article>
    
        <div class="container-overview">
        
            

            
                

    

    <h4 class="name" id="module:db"><span class="type-signature"></span>module:db<span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>The Database API, a thin abstraction layer on top of SQLite, PostgreSQL, DynamoDB, Elasticsearch.</p>
<p>The idea is to not introduce a new abstraction layer on top of all databases but to make
the API usable for common use cases.</p>
<p>On the source code level access to all databases will be possible using
this API but any specific usage like SQL queries syntax or data types available only for some databases will not be
unified or automatically converted. Instead it is passed to the database directly.</p>
<p>Only conversion between JavaScript types and
database types is unified to some degree meaning JavaScript data type will be converted into the corresponding
data type supported by any particular database and vice versa.</p>
<p>Basic CRUD operations are supported for all database and modelled after NoSQL usage, this means no SQL joins are supported
by the API, only single table access. SQL joins can be passed as SQL statements directly to the database using low level
<a href="module-db.html#.query">module:db.query</a> API call, all high level operations like add/put/del perform SQL generation for single table on the fly.</p>
<p>The common convention is to pass options object with flags that are common for all drivers along with specific,
this options object can be modified with new properties but all driver should try not to
modify or delete existing properties, so the same options object can be reused in subsequent operations.</p>
<p>All queries and update operations ignore properties that starts with underscore.</p>
<p>Before the DB functions can be used the <code>app.init</code> MUST be called first, the typical usage:</p>
<pre class="prettyprint source lang-js"><code>const { core, db } = require(&quot;backendjs&quot;);
app.init((err) => {
  db.add(...
  ...
});
</code></pre>
<p>All database methods can use default db pool or any other available db pool by using <code>pool: name</code> in the options. If not specified,
then default db pool is used, <code>none</code> is default if no -db-pool config parameter specified in the command line or the config file.</p>
<p>Even if the specified pool does not exist, the default pool will be returned, this allows to pre-confgure the app with different pools
in the code and enable or disable any particular pool at any time.</p>
<p>To use PostgreSQL db pool to get a record and update the current pool:</p>
<pre class="prettyprint source lang-js"><code>db.get(&quot;bk_user&quot;, { login: &quot;123&quot; }, { pool: &quot;pg&quot; }, (err, row) => {
  if (row) db.update(&quot;bk_user&quot;, row);
});
const user = await db.aget(&quot;bk_user&quot;, { login: &quot;123&quot; });
</code></pre>
<p>Most database pools can be configured with options <code>min</code> and <code>max</code> for number of connections to be maintained, so no overload will happen and keep warm connection for
faster responses. Even for DynamoDB which uses HTTPS this can be configured without hitting provisioned limits which will return an error but
put extra requests into the waiting queue and execute once some requests finished.</p>
<pre class="prettyprint source"><code>db-pg-pool-max = 100
db-dynamodb-pool-max = 100
</code></pre>
<p>Also, to spread functionality between different databases it is possible to assign some tables to the specific pools using <code>db-X-pool-tables</code> parameters
thus redirecting the requests to one or another databases depending on the table, this for example can be useful when using fast but expensive
database like DynamoDB for real-time requests and slower SQL database running on some slow instance for rare requests, reports or statistics processing.</p>
<p>To run the backend with default PostgreSQL database but keep all config parametrs in the DynamoDB table for availability:</p>
<pre class="prettyprint source"><code>db-pool = pg
db-dynamodb-pool = default
db-dynamodb-pool-tables = bk_config
</code></pre>
<p>The following databases are supported with the basic db methods: <code>Sqlite, PostgreSQL, DynamoDB, Elasticsearch</code></p>
<p>All public <code>db.get|put|update|del|select|list</code> operations have corresponding promisifed method starting with <code>a</code>, like <code>db.get</code> -&gt; <code>db.aget</code>,...</p>
<p>Multiple pools of the same type can be opened, just add <code>N</code> suffix to all database config parameters where N is a number,
referer to such pools in the code as <code>poolN</code> or by an alias.</p>
<pre class="prettyprint source"><code>db-sqlite1-pool = billing
db-sqlite1-pool-max = 10
db-sqlite1-pool-options-path = /data/db
db-sqlite1-pool-options-journal_mode = OFF
db-sqlite1-pool-alias = billing
</code></pre>
<p>and in the Javascript:</p>
<pre class="prettyprint source lang-js"><code> db.select(&quot;bills&quot;, { status: &quot;ok&quot; }, { pool: &quot;billing&quot; }, lib.log)
 await db.aselect(&quot;bills&quot;, { status: &quot;ok&quot; }, { pool: &quot;billing&quot; })
</code></pre>
<p>To enable stats collection for a pool it must be explicitly set via config options,
additionally collect stats individually for a list of tables</p>
<pre class="prettyprint source"><code>db-dynamodb-pool-options-metrics = 1
db-dynamodb-pool-metrics-tables = bk_config, bk_user
</code></pre></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>



    <h5 class="subsection-title">Properties:</h5>

    

<table class="props">
    <thead>
    <tr>
        
        <th>Name</th>
        

        <th>Type</th>

        

        

        <th class="last">Description</th>
    </tr>
    </thead>

    <tbody>
    

        <tr>
            
                <td class="name"><code>roles</code></td>
            

            <td class="type">
            
                
<span class="param-type">Array.&lt;string></span>



            
            </td>

            

            

            <td class="description last"><p>additional roles to be used for DB config</p></td>
        </tr>

    
    </tbody>
</table>

































            
        
        </div>
    

    

    

    
        <h3 class="subsection-title">Classes</h3>

        <dl>
            <dt><a href="module-db.db.Pool.html">db.Pool</a></dt>
            <dd></dd>
        
            <dt><a href="module-db.db.SqlPool.html">db.SqlPool</a></dt>
            <dd></dd>
        </dl>
    

    
        <h3 class="subsection-title">Type Definitions</h3>

        
                
<h4 class="name" id="~DBRequest">DBRequest</h4>





<dl class="details">
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>



    <h5 class="subsection-title">Properties:</h5>

    

<table class="props">
    <thead>
    <tr>
        
        <th>Name</th>
        

        <th>Type</th>

        
        <th>Attributes</th>
        

        

        <th class="last">Description</th>
    </tr>
    </thead>

    <tbody>
    

        <tr>
            
                <td class="name"><code>op</code></td>
            

            <td class="type">
            
                
<span class="param-type">string</span>



            
            </td>

            
                <td class="attributes">
                

                
                </td>
            

            

            <td class="description last"><p>DB operation, one of get, put, incr, update, select, ...</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>pool</code></td>
            

            <td class="type">
            
                
<span class="param-type">string</span>



            
            </td>

            
                <td class="attributes">
                

                
                </td>
            

            

            <td class="description last"><p>a DB pool used for this operation</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>table</code></td>
            

            <td class="type">
            
                
<span class="param-type">string</span>



            
            </td>

            
                <td class="attributes">
                

                
                </td>
            

            

            <td class="description last"><p>a DB table name</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>text</code></td>
            

            <td class="type">
            
                
<span class="param-type">string</span>



            
            </td>

            
                <td class="attributes">
                
                    &lt;optional><br>
                

                
                </td>
            

            

            <td class="description last"><p>native DB query, SQL or etc...</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>obj</code></td>
            

            <td class="type">
            
                
<span class="param-type">object</span>



            
            </td>

            
                <td class="attributes">
                

                
                </td>
            

            

            <td class="description last"><p>a query object</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options</code></td>
            

            <td class="type">
            
                
<span class="param-type">object</span>



            
            </td>

            
                <td class="attributes">
                

                
                </td>
            

            

            <td class="description last"><p>an object with optional properties for the operation</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>keys</code></td>
            

            <td class="type">
            
                
<span class="param-type">Array.&lt;string></span>



            
            </td>

            
                <td class="attributes">
                

                
                </td>
            

            

            <td class="description last"><p>a list of table primary keys</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>custom</code></td>
            

            <td class="type">
            
                
<span class="param-type">object</span>



            
            </td>

            
                <td class="attributes">
                

                
                </td>
            

            

            <td class="description last"><p>an object for custom columns</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>columns</code></td>
            

            <td class="type">
            
                
<span class="param-type">object</span>



            
            </td>

            
                <td class="attributes">
                

                
                </td>
            

            

            <td class="description last"><p>an object with table's columns</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>column</code></td>
            

            <td class="type">
            
                
<span class="param-type">function</span>



            
            </td>

            
                <td class="attributes">
                

                
                </td>
            

            

            <td class="description last"><p>returns a column object by name</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>now</code></td>
            

            <td class="type">
            
                
<span class="param-type">int</span>



            
            </td>

            
                <td class="attributes">
                

                
                </td>
            

            

            <td class="description last"><p>timestamp when this is created, ms</p></td>
        </tr>

    
    </tbody>
</table>








    <h5 class="h5-types">Type:</h5>
    <ul>
        <li>
            
<span class="param-type">object</span>



        </li>
    </ul>






            
                
<h4 class="name" id="~DBRequestOptions">DBRequestOptions</h4>





<dl class="details">
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>







    <h5 class="h5-types">Type:</h5>
    <ul>
        <li>
            
<span class="param-type">object</span>



        </li>
    </ul>






            
                

    

    <h4 class="name" id="~DBResultCallback"><span class="type-signature"></span>DBResultCallback<span class="signature">(err, rows, info)</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>This callback is called by all DB methods</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>











    <h5 class="h5-parameters">Parameters:</h5>
    

<table class="params">
    <thead>
    <tr>
        
        <th>Name</th>
        

        <th>Type</th>

        

        

        <th class="last">Description</th>
    </tr>
    </thead>

    <tbody>
    

        <tr>
            
                <td class="name"><code>err</code></td>
            

            <td class="type">
            
                
<span class="param-type">Error</span>



            
            </td>

            

            

            <td class="description last"><p>and error object or null i fno errors</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>rows</code></td>
            

            <td class="type">
            
                
<span class="param-type">Array.&lt;object></span>



            
            </td>

            

            

            <td class="description last"><p>a list of result rows, in case of error it is an empty list</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>info</code></td>
            

            <td class="type">
            
                
<span class="param-type">object</span>



            
            </td>

            

            

            <td class="description last"><p>an object with information about the last query:</p>
                <h6>Properties</h6>
                

<table class="params">
    <thead>
    <tr>
        
        <th>Name</th>
        

        <th>Type</th>

        
        <th>Attributes</th>
        

        

        <th class="last">Description</th>
    </tr>
    </thead>

    <tbody>
    

        <tr>
            
                <td class="name"><code>inserted_oid</code></td>
            

            <td class="type">
            
                
<span class="param-type">string</span>



            
            </td>

            
                <td class="attributes">
                
                    &lt;optional><br>
                

                

                
                </td>
            

            

            <td class="description last"><p>new generated ID</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>affected_rows</code></td>
            

            <td class="type">
            
                
<span class="param-type">int</span>



            
            </td>

            
                <td class="attributes">
                
                    &lt;optional><br>
                

                

                
                </td>
            

            

            <td class="description last"><p>how many rows were affected by this operation</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>next_token</code></td>
            

            <td class="type">
            
                
<span class="param-type">string</span>



            
            </td>

            
                <td class="attributes">
                
                    &lt;optional><br>
                

                

                
                </td>
            

            

            <td class="description last"><p>next to ken to pass for pagination</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>consumed_capacity</code></td>
            

            <td class="type">
            
                
<span class="param-type">int</span>



            
            </td>

            
                <td class="attributes">
                
                    &lt;optional><br>
                

                

                
                </td>
            

            

            <td class="description last"><p>DynamoDB specific about capacity consumed</p></td>
        </tr>

    
    </tbody>
</table>

            </td>
        </tr>

    
    </tbody>
</table>























            
    
    
    

     

    

    
        <h3 class="subsection-title">Members</h3>

        
            
<h4 class="name" id=".db.aadd"><span class="type-signature type-signature-static">(static) </span>db.aadd<span class="type-signature"></span></h4>





<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Async version of db.add, throws exception on error</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>





<div class="description usertext">
    <p>Async version of db.add, throws exception on error</p>
</div>








        
            
<h4 class="name" id=".db.abatch"><span class="type-signature type-signature-static">(static) </span>db.abatch<span class="type-signature"></span></h4>





<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Async version of db.batch, throws exception on error</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>





<div class="description usertext">
    <p>Async version of db.batch, throws exception on error</p>
</div>








        
            
<h4 class="name" id=".db.abulk"><span class="type-signature type-signature-static">(static) </span>db.abulk<span class="type-signature"></span></h4>





<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Async version of db.bulk, throws exception on error</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>





<div class="description usertext">
    <p>Async version of db.bulk, throws exception on error</p>
</div>








        
            
<h4 class="name" id=".db.acopy"><span class="type-signature type-signature-static">(static) </span>db.acopy<span class="type-signature"></span></h4>





<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Async version of db.copy, throws exception on error</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>





<div class="description usertext">
    <p>Async version of db.copy, throws exception on error</p>
</div>








        
            
<h4 class="name" id=".db.acreate"><span class="type-signature type-signature-static">(static) </span>db.acreate<span class="type-signature"></span></h4>





<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Async version of db.create, throws exception on error</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>





<div class="description usertext">
    <p>Async version of db.create, throws exception on error</p>
</div>








        
            
<h4 class="name" id=".db.adel"><span class="type-signature type-signature-static">(static) </span>db.adel<span class="type-signature"></span></h4>





<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Async version of db.del, throws exception on error</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>





<div class="description usertext">
    <p>Async version of db.del, throws exception on error</p>
</div>








        
            
<h4 class="name" id=".db.adelAll"><span class="type-signature type-signature-static">(static) </span>db.adelAll<span class="type-signature"></span></h4>





<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Async version of db.delAll, throws exception on error</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>





<div class="description usertext">
    <p>Async version of db.delAll, throws exception on error</p>
</div>








        
            
<h4 class="name" id=".db.adrop"><span class="type-signature type-signature-static">(static) </span>db.adrop<span class="type-signature"></span></h4>





<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Async version of db.drop, throws exception on error</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>





<div class="description usertext">
    <p>Async version of db.drop, throws exception on error</p>
</div>








        
            
<h4 class="name" id=".db.aget"><span class="type-signature type-signature-static">(static) </span>db.aget<span class="type-signature"></span></h4>





<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Async version of db.get, throws exception on error</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>





<div class="description usertext">
    <p>Async version of db.get, throws exception on error</p>
</div>








        
            
<h4 class="name" id=".db.aincr"><span class="type-signature type-signature-static">(static) </span>db.aincr<span class="type-signature"></span></h4>





<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Async version of db.incr, throws exception on error</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>





<div class="description usertext">
    <p>Async version of db.incr, throws exception on error</p>
</div>








        
            
<h4 class="name" id=".db.ajoin"><span class="type-signature type-signature-static">(static) </span>db.ajoin<span class="type-signature"></span></h4>





<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Async version of db.join, throws exception on error</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>





<div class="description usertext">
    <p>Async version of db.join, throws exception on error</p>
</div>








        
            
<h4 class="name" id=".db.alist"><span class="type-signature type-signature-static">(static) </span>db.alist<span class="type-signature"></span></h4>





<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Async version of db.list, throws exception on error</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>





<div class="description usertext">
    <p>Async version of db.list, throws exception on error</p>
</div>








        
            
<h4 class="name" id=".db.aput"><span class="type-signature type-signature-static">(static) </span>db.aput<span class="type-signature"></span></h4>





<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Async version of db.put, throws exception on error</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>





<div class="description usertext">
    <p>Async version of db.put, throws exception on error</p>
</div>








        
            
<h4 class="name" id=".db.ascan"><span class="type-signature type-signature-static">(static) </span>db.ascan<span class="type-signature"></span></h4>





<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Async version of db.scan, throws exception on error</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>





<div class="description usertext">
    <p>Async version of db.scan, throws exception on error</p>
</div>








        
            
<h4 class="name" id=".db.asearch"><span class="type-signature type-signature-static">(static) </span>db.asearch<span class="type-signature"></span></h4>





<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Async version of db.search, throws exception on error</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>





<div class="description usertext">
    <p>Async version of db.search, throws exception on error</p>
</div>








        
            
<h4 class="name" id=".db.aselect"><span class="type-signature type-signature-static">(static) </span>db.aselect<span class="type-signature"></span></h4>





<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Async version of db.select, throws exception on error</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>





<div class="description usertext">
    <p>Async version of db.select, throws exception on error</p>
</div>








        
            
<h4 class="name" id=".db.asql"><span class="type-signature type-signature-static">(static) </span>db.asql<span class="type-signature"></span></h4>





<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Async version of db.sql, throws exception on error</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>





<div class="description usertext">
    <p>Async version of db.sql, throws exception on error</p>
</div>








        
            
<h4 class="name" id=".db.atransaction"><span class="type-signature type-signature-static">(static) </span>db.atransaction<span class="type-signature"></span></h4>





<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Async version of db.transaction, throws exception on error</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>





<div class="description usertext">
    <p>Async version of db.transaction, throws exception on error</p>
</div>








        
            
<h4 class="name" id=".db.aupdate"><span class="type-signature type-signature-static">(static) </span>db.aupdate<span class="type-signature"></span></h4>





<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Async version of db.update, throws exception on error</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>





<div class="description usertext">
    <p>Async version of db.update, throws exception on error</p>
</div>








        
            
<h4 class="name" id=".db.aupdateAll"><span class="type-signature type-signature-static">(static) </span>db.aupdateAll<span class="type-signature"></span></h4>





<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Async version of db.updateAll, throws exception on error</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>





<div class="description usertext">
    <p>Async version of db.updateAll, throws exception on error</p>
</div>








        
            
<h4 class="name" id=".db.aupgrade"><span class="type-signature type-signature-static">(static) </span>db.aupgrade<span class="type-signature"></span></h4>





<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Async version of db.upgrade, throws exception on error</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>





<div class="description usertext">
    <p>Async version of db.upgrade, throws exception on error</p>
</div>








        
    

    
        <h3 class="subsection-title">Methods</h3>

        
            

    

    <h4 class="name" id=".aquery"><span class="type-signature type-signature-static">(static) </span>aquery<span class="signature">(req, options<span class="signature-attributes">opt</span>)</span><span class="type-signature"> &rarr; {Promise}</span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Async version of <a href="module-db.html#.query">module:db.query</a> with the same parameters</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>











    <h5 class="h5-parameters">Parameters:</h5>
    

<table class="params">
    <thead>
    <tr>
        
        <th>Name</th>
        

        <th>Type</th>

        
        <th>Attributes</th>
        

        

        <th class="last">Description</th>
    </tr>
    </thead>

    <tbody>
    

        <tr>
            
                <td class="name"><code>req</code></td>
            

            <td class="type">
            
                
<span class="param-type">DBRequest</span>



            
            </td>

            
                <td class="attributes">
                

                

                
                </td>
            

            

            <td class="description last"></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options</code></td>
            

            <td class="type">
            
                
<span class="param-type">DBRequestOptions</span>



            
            </td>

            
                <td class="attributes">
                
                    &lt;optional><br>
                

                

                
                </td>
            

            

            <td class="description last"></td>
        </tr>

    
    </tbody>
</table>
















<h5 class="h5-returns">Returns:</h5>

        


<dl class="param-type">
    <dt>
        Type
    </dt>
    <dd>
        
<span class="param-type">Promise</span>



    </dd>
</dl>

    




    <h5 class="h5-examples">Example</h5>
    
    <pre class="prettyprint"><code>await db.aquery({ text: "SELECT ....." }, { pool: "sqlite" });</code></pre>





        
            

    

    <h4 class="name" id=".db.add"><span class="type-signature type-signature-static">(static) </span>db.add<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Insert new object into the database</p>
<ul>
<li>obj - an JavaScript object with properties for the record, primary key properties must be supplied</li>
<li>options may contain the following properties:</li>
</ul></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>











    <h5 class="h5-parameters">Parameters:</h5>
    

<table class="params">
    <thead>
    <tr>
        
        <th>Name</th>
        

        <th>Type</th>

        

        

        <th class="last">Description</th>
    </tr>
    </thead>

    <tbody>
    

        <tr>
            
                <td class="name"><code>options.no_columns</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>do not check for actual columns defined in the pool tables and add all properties from the obj, only will work for NoSQL dbs,
by default all properties in the obj not described in the table definition for the given table will be ignored.</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.skip_columns</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>ignore properties by name listed in the this array, the most use case is to skip autogeneratd columns like &quot;now&quot;</p>
<p>On return the <code>obj</code> will contain all new columns generated before adding the record</p>
<p>Note: SQL, DynamoDB, MongoDB, Redis drivers are fully atomic but other drivers may be subject to race conditions</p>
<p>Example</p>
<pre><code>  db.add(&quot;bk_user&quot;, { id: '123', login: 'admin', name: 'test' }, function(err, rows, info) {
  });

  await db.aadd(&quot;bk_user&quot;, { id: '123', login: 'admin', name: 'test' })
</code></pre></td>
        </tr>

    
    </tbody>
</table>























        
            

    

    <h4 class="name" id=".db.batch"><span class="type-signature type-signature-static">(static) </span>db.batch<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Perform a batch of operations at the same time, all operations for the same table will be run
together one by one but different tables will be updated in parallel.</p>
<ul>
<li><code>list</code> an array of objects to get/put/delete from the database in the format:</li>
</ul></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>











    <h5 class="h5-parameters">Parameters:</h5>
    

<table class="params">
    <thead>
    <tr>
        
        <th>Name</th>
        

        <th>Type</th>

        

        

        <th class="last">Description</th>
    </tr>
    </thead>

    <tbody>
    

        <tr>
            
                <td class="name"><code>options.op</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>is one of get, add, incr, put, update, del</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.table</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>which table to use</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.obj</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>an object with data</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.options</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>params for the operation, optional</p>
<ul>
<li>options can have the following:</li>
</ul></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.concurrency</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>number of how many operations to run at the same time, 1 means sequential</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.no_errors</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>will stop on first error, because operations will be run in parallel some operations still may be performed</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.factorCapacity</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>a capacity factor to apply to the write capacity if present, by default it is used write capacity at 100%</p>
<p>On return the second arg to the callback is a list of records with errors as the input record with added property <code>errstatus</code> and <code>errmsg</code>,
for get ops the result will be retrieved record if exists.</p>
<p>One advantage using this with op: get over db.list is caching, db.get may use both local and remote caches but db.list always hits the database.</p>
<p>Example:</p>
<pre><code>     var ops = [ { op: &quot;add&quot;, table: &quot;bk_counter&quot;, obj: { id:1, like:1 } },
                 { op: &quot;add&quot;, table: &quot;bk_user&quot;, obj: { login: &quot;test&quot;, id:1, name:&quot;test&quot; }]
     db.batch(ops, { factorCapacity: 0.5 }, lib.log);
</code></pre></td>
        </tr>

    
    </tbody>
</table>























        
            

    

    <h4 class="name" id=".db.bulk"><span class="type-signature type-signature-static">(static) </span>db.bulk<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Bulk operations, it will be noop if the driver does not support it.
The input format is the same as for the <code>db.batch</code> method.</p>
<p>On return the second arg to the callback is a list of records with errors, same input record with added property <code>errstatus</code> and <code>errmsg</code></p>
<p>NOTE: DynamoDB only supports add/put/del only and 25 at a time, if more specified it will send multiple batches</p>
<p>Example</p>
<pre><code>     var ops = [ { op: &quot;add&quot;, table: &quot;bk_counter&quot;, obj: { id:1, like:1 } },
                 { op: &quot;del&quot;, table: &quot;bk_user&quot;, obj: { login: &quot;test1&quot; } },
                 { op: &quot;incr&quot;, table: &quot;bk_counter&quot;, obj: { id:2, like:1 } },
                 { op: &quot;add&quot;, table: &quot;bk_user&quot;, obj: { login: &quot;test2&quot;, id:2, name:&quot;test2&quot; } }]
     db.bulk(ops, { pool: &quot;elasticsearch&quot; }, lib.log);
</code></pre></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>
































        
            

    

    <h4 class="name" id=".db.cacheColumns"><span class="type-signature type-signature-static">(static) </span>db.cacheColumns<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Reload all columns into the cache for the pool, options can be a pool name or an object like <code>{ pool: name }</code>.
if <code>tables</code> property is an arary it asks to refresh only specified tables if that is possible.</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>
































        
            

    

    <h4 class="name" id=".db.configTypes"><span class="type-signature type-signature-static">(static) </span>db.configTypes<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Build a list of all config types we want to retrieve, based on the <code>db-config-map</code> parameters that defines which fields to use for config types.</p>
<ul>
<li>for each <code>top</code> item it create a mix of all main items below</li>
<li>for each <code>main</code> item it creates a mix of all `other`` items</li>
</ul>
<p>top... -&gt; each of top-main... -&gt; each of top-main-other...</p>
<p>Most common config parameters: runMode, appName, role, roles, tag, region</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>





























    <h5 class="h5-examples">Example</h5>
    
    <pre class="prettyprint"><code>top is runMode(prod), main is role(shell),tag(local), other is region(none)
 - prod
 - prod-shell
 - prod-shell-none
 - prod-local
 - prod-local-none</code></pre>





        
            

    

    <h4 class="name" id=".db.copy"><span class="type-signature type-signature-static">(static) </span>db.copy<span class="signature">(table, query, options)</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Copy records from one table to another between different DB pools or regions</p>
<p>Parameters:</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>











    <h5 class="h5-parameters">Parameters:</h5>
    

<table class="params">
    <thead>
    <tr>
        
        <th>Name</th>
        

        <th>Type</th>

        

        

        <th class="last">Description</th>
    </tr>
    </thead>

    <tbody>
    

        <tr>
            
                <td class="name"><code>table</code></td>
            

            <td class="type">
            
                
<span class="param-type">string</span>



            
            </td>

            

            

            <td class="description last"><p>name of the table to copy</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>query</code></td>
            

            <td class="type">
            
                
<span class="param-type">object</span>



            
            </td>

            

            

            <td class="description last"><p>a query condition for the table</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options</code></td>
            

            <td class="type">
            
                
<span class="param-type">object</span>



            
            </td>

            

            

            <td class="description last">
                <h6>Properties</h6>
                

<table class="params">
    <thead>
    <tr>
        
        <th>Name</th>
        

        <th>Type</th>

        

        

        <th class="last">Description</th>
    </tr>
    </thead>

    <tbody>
    

        <tr>
            
                <td class="name"><code>sort</code></td>
            

            <td class="type">
            
                
<span class="param-type">string</span>



            
            </td>

            

            

            <td class="description last"><p>index to use for query</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>minCapacity</code></td>
            

            <td class="type">
            
                
<span class="param-type">int</span>



            
            </td>

            

            

            <td class="description last"><p>capacity minimum for read/writes, it will override actual DB capacity</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>factorCapacity</code></td>
            

            <td class="type">
            
                
<span class="param-type">int</span>



            
            </td>

            

            

            <td class="description last"><p>factor the actual capacity for reads/writes</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>stopOnError</code></td>
            

            <td class="type">
            
                
<span class="param-type">boolean</span>



            
            </td>

            

            

            <td class="description last"><p>stop the copy on first DB error, otherwise ignore errors</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>region</code></td>
            

            <td class="type">
            
                
<span class="param-type">string</span>



            
            </td>

            

            

            <td class="description last"><p>other region where to copy</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>sourcePool</code></td>
            

            <td class="type">
            
                
<span class="param-type">string</span>



            
            </td>

            

            

            <td class="description last"><p>original pool, default if not provided</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>pool</code></td>
            

            <td class="type">
            
                
<span class="param-type">string</span>



            
            </td>

            

            

            <td class="description last"><p>other DB pool</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>file</code></td>
            

            <td class="type">
            
                
<span class="param-type">string</span>



            
            </td>

            

            

            <td class="description last"><p>dump the data into a file as JSON</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>preprocess</code></td>
            

            <td class="type">
            
                
<span class="param-type">function</span>



            
            </td>

            

            

            <td class="description last"><p>a function(table, row, options) to be called before the update, if it returns true the record will be skipped</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>posprocess</code></td>
            

            <td class="type">
            
                
<span class="param-type">function</span>



            
            </td>

            

            

            <td class="description last"><p>a function(table, row, options, next) to be called after the record is copied, for recursive or joined cases</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>reget</code></td>
            

            <td class="type">
            
                
<span class="param-type">boolean</span>



            
            </td>

            

            

            <td class="description last"><p>if set the actual record will read using db.get, for cases when db.scan returns only partial record as in DynamoDB cases with indexes</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>incremental</code></td>
            

            <td class="type">
            
                
<span class="param-type">boolean</span>



            
            </td>

            

            

            <td class="description last"><p>if set, try to read the latest record in the other table and continue from there, uses <code>sort</code> index in desc order</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>batch</code></td>
            

            <td class="type">
            
                
<span class="param-type">int</span>



            
            </td>

            

            

            <td class="description last"><p>a number of records to copy at once using the bulk operation</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>syncMode</code></td>
            

            <td class="type">
            
                
<span class="param-type">boolean</span>



            
            </td>

            

            

            <td class="description last"><p>if set enabled the update mode in which all values are preserved and not pre-processed, default is 1</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>queryOptions</code></td>
            

            <td class="type">
            
                
<span class="param-type">object</span>



            
            </td>

            

            

            <td class="description last"><p>pass options to scan operations</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>updateOptions</code></td>
            

            <td class="type">
            
                
<span class="param-type">object</span>



            
            </td>

            

            

            <td class="description last"><p>pass options to update/bulk operations
Returns stats how many copied or errors</p></td>
        </tr>

    
    </tbody>
</table>

            </td>
        </tr>

    
    </tbody>
</table>























        
            

    

    <h4 class="name" id=".db.create"><span class="type-signature type-signature-static">(static) </span>db.create<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Create a table using column definitions represented as a list of objects. Each column definition may
contain the following properties:</p>
<ul>
<li><code>name</code> - column name</li>
<li><code>type</code> - column type: int, bigint, real, string, now, counter or other supported type</li>
<li><code>primary</code> - column is part of the primary key</li>
<li><code>unique</code> - column is part of an unique key</li>
<li><code>index</code> - column is part of an index, the value is a number for the column position in the index</li>
<li><code>indexN</code> - additonal inxdexes where N is 1..5</li>
<li><code>value</code> - default value for the column</li>
<li><code>len</code> - column length</li>
<li><code>max</code> - ignore the column if a <code>text</code>, <code>json</code> or <code>obj</code> value is greater than specified limit, unless <code>trunc</code> is provided</li>
<li><code>trunc</code> - truncate the column value, the value will be truncated before saving into the DB, uses the <code>max</code> as the limit</li>
<li><code>maxlist</code> - max number of items in the <code>list</code> or <code>array</code> column types</li>
<li><code>pub</code> - columns is public, <em>this is very important property because it allows anybody to see it when used in the default API functions, i.e. anybody with valid
credentials can retrieve all public columns from all other tables, and if one of the other tables is user table this may expose some personal information,
so by default only a few columns are marked as public in the <code>bk_user</code> table</em></li>
<li><code>pub_admin</code> - a generic read permission requires <code>options.isAdmin</code> when used with <code>api.cleanResult</code></li>
<li><code>pub_staff</code> - a generic read permission requires <code>options.isStaff</code> when used with <code>api.cleanResult</code></li>
<li><code>pub_types</code> - a role or a list of roles which further restrict access to a public column to only users with specified roles</li>
<li><code>priv_types</code> - a role or a list of roles which excplicitely deny access to a column for users with specified roles</li>
<li><code>priv</code> - an opposite for the pub property, if defined this property should never be returned to the client by the API handlers</li>
<li><code>internal</code> - if set then this property can only be updated by admin/root or with `isInternal`` property</li>
<li><code>hidden</code> - completely ignored by all update operations but could be used by the public columns cleaning procedure, if it is computed and not stored in the db
it can contain pub property to be returned to the client</li>
<li><code>readonly</code> - only add/put operations will use the value, incr/update will not affect the value</li>
<li><code>writeonly</code> - only incr/update can change this value, add/put will ignore it</li>
<li><code>noresult</code> - delete this property from the result, mostly for joined artificial columns which used for indexes only</li>
<li><code>random</code> - add a random number between 0 and this value, useful with type: &quot;now&quot;</li>
<li><code>lower</code> - make string value lowercase</li>
<li><code>upper</code> - make string value uppercase</li>
<li><code>strip</code> - if a regexp perform replace on the column value before saving</li>
<li><code>trim</code> - strim string value of whitespace</li>
<li><code>cap</code> - capitalize into a title with lib.toTitle</li>
<li><code>word</code> - if a number only save nth word from the value, split by <code>separator</code></li>
<li><code>clock</code> - for <code>now</code> type use high resolution clock in nanoseconds</li>
<li><code>epoch</code> - for <code>now</code> type save as seconds since the Epoch, not milliseconds</li>
<li><code>multiplier</code> - for numeric columns apply this multipliers before saving</li>
<li><code>increment</code> - for numeric columns add this value before saving</li>
<li><code>decimal</code> - for numeric columns convert into fixed number using this number of decimals</li>
<li><code>format</code> - a function (val, req) =&gt; {} that must return new value for the given column, for custom formatting</li>
<li><code>prefix</code> - prefix to be prepended for autogenerated columns: <code>uuid</code>, <code>suud</code>, <code>tuud</code></li>
<li><code>separator</code> - to be used as a separator in join or split depending on the column properties</li>
<li><code>list</code> - splits the column value into an array, optional <code>separator</code> property can be used, default separator is <code>,|</code></li>
<li><code>autoincr</code> - for counter tables, mark the column to be auto-incremented by the connection API if the connection type has the same name as the column name</li>
<li><code>join</code> - a list with property names that must be joined together before performing a db operation, it will use the given record to produce new property,
this will work both ways, to the db and when reading a record from the db it will split joined property and assign individual
properties the value from the joined value. See <code>db.joinColumns</code> for more options.</li>
<li><code>unjoin</code> - split the join column into respective columns on retrieval</li>
<li><code>keepjoined</code> - keep the joined column value, if not specified the joined column is deleted after unjoined</li>
<li><code>notempty</code> - do not allow empty columns, if not provided it is filled with the default value</li>
<li><code>skip_empty</code> - ignore the column if the value is empty, i.e. null or empty string</li>
<li><code>fail_ifempty</code> - returtn an error if there is no  value for the column, this is checked during record preprocessing</li>
<li><code>values</code> - an array with allowed values, ignore the column if not present</li>
<li><code>values_map</code> - an array of pairs to be checked for exact match and be replaced with the next item, [&quot;&quot;, null, &quot;&quot;, undefined, &quot;null&quot;, &quot;&quot;]</li>
</ul>
<p><em>Some properties may be defined multiple times with number suffixes like: <code>unique1, unique2, index1, index2</code> to create more than one index for the table, same
properties define a composite key in the order of definition or sorted by the property value, for example: <code>{ a: { index:2 }, b: { index:1 } }</code> will create index (b,a)
because of the <code>index:</code> property value being not the same. If all index properties are set to 1 then a composite index will use the order of the properties.</em></p>
<p><em>Special column types</em>:</p>
<ul>
<li><code>uuid</code> - autogenerate the column value with UUID, optional <code>prefix</code> property will be prepended, <code>{ type: &quot;uuid&quot;, prefix: &quot;u_&quot; }</code></li>
<li><code>now</code> - defines a column to be automatically filled with the current timestamp, <code>{ type: &quot;now&quot; }</code></li>
<li><code>counter</code> - defines a columns that will be automatically incremented by the <code>db.incr</code> command, on creation it is set with 0</li>
<li><code>uid</code> - defines a columns to be automatically filled with the current user id, this assumes that user object is passed in the options from the API level</li>
<li><code>uname</code> - defines a columns to be automatically filled with the current user name, this assumes that user object is passed in the options from the API level</li>
<li><code>ttl</code> - mark the column to be auto expired, can be set directly to time in the future or use one of: <code>days</code>, <code>hours</code>, <code>minutes</code> as a interval in the future</li>
</ul>
<p>NOTE: Index creation is not required and all index properties can be omitted, it can be done more effectively using native tools for any specific database,
this format is for simple and common use cases without using any other tools but it does not cover all possible variations for every database. But all indexes and
primary keys created outside of the backend application will be detected properly by <code>db.cacheColumns</code> and by each pool <code>cacheIndexes</code> methods.</p>
<p>Each database pool also can support native options that are passed directly to the driver in the options, these properties are
defined in the object with the same name as the db driver, all properties are combined, for example to define provisioned throughput for the DynamoDB index:</p>
<pre><code>     db.create(&quot;test_table&quot;, { id: { primary: 1, type: &quot;int&quot;, index: 1, dynamodb: { readCapacity: 50, writeCapacity: 50 } },
                               type: { primary: 1, pub: 1, projections: 1 },
                               name: { index: 1, pub: 1 } }
                             });
</code></pre>
<p>Create DynamoDB table with global secondary index, the first index property if not the same as primary key hash defines global index, if it is the same then local,
or if the second key column contains <code>global</code> property then it is a global index as well, below we create global secondary index on property 'name' only,
in the example above it was local secondary index for id and name. Also a local secondary index is created on <code>id,title</code>.</p>
<p>DynamoDB projection is defined by a <code>projections</code> property, can be a number/boolean or an array with index numbers for regular columns
but the hash property can provide its own projections for whole index at once, can be ALL or a list of attributes.</p>
<pre><code>     db.create(&quot;test_table&quot;, { id: { primary: 1, type: &quot;int&quot;, index1: 1 },
                               type: { primary: 1, projections: [0] },
                               name: { index: 1, projections: 1 },
                               title: { index1: 1, projections: [1] } },
                               descr: { index: 1, projections: [0, 1] },
                             });
</code></pre>
<p>When using real DynamoDB creating a table may take some time, for such cases if <code>options.waitTimeout</code> is not specified it defaults to 1min,
so the callback is called as soon as the table is active or after the timeout whichever comes first.</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>
































        
            

    

    <h4 class="name" id=".db.createTables"><span class="type-signature type-signature-static">(static) </span>db.createTables<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Create or upgrade the tables for the given pool</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>
































        
            

    

    <h4 class="name" id=".db.del"><span class="type-signature type-signature-static">(static) </span>db.del<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Delete an object in the database, no error if the object does not exist</p>
<ul>
<li>obj - an object with primary key properties only, other properties will be ignored</li>
<li>options - same properties as for <code>db.update</code> method</li>
</ul>
<p>Example</p>
<pre><code>  db.del(&quot;bk_user&quot;, { login: '123' }, function(err, rows, info) {
      console.log('updated:', info.affected_rows);
  });
</code></pre></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>
































        
            

    

    <h4 class="name" id=".db.delAll"><span class="type-signature type-signature-static">(static) </span>db.delAll<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Delete all records that match given condition, one by one, the input is the same as for <code>db.select</code> and every record
returned will be deleted using <code>db.del</code> call. The callback will receive on completion the err and all rows found and deleted.
Special properties that can be in the options for this call:</p>
<ul>
<li>ops - query operations to retrieve records to be deleted</li>
<li>count - how many matching records to delete</li>
<li>delScan - if true force to use db.scan instead of native <code>delAll</code> for the given pool</li>
<li>delOptions - options to be passed to the db.del if needed, this is useful so select and del options will not be mixed up</li>
<li>delCollect - if true return all deleted rows in the callback, oherwise just the number of rows deleted</li>
<li>factorCapacity - write capqcity factor for delete operations, default is 0.35</li>
<li>concurrency - how many delete requests to execute at the same time by using lib.forEachLimit.</li>
<li>ignore_error - continue deleting records even after an error</li>
<li>delProcess - a function callback that will be called for each row before deleting it, this is for some transformations of the record properties
in case of complex columns that may contain concatenated values as in the case of using DynamoDB. The callback will be called
as <code>options.delProcess(row, options, info)</code>. If it returns non-empty value the scan will stop and return it as the error.</li>
<li>delFilter - a function that must return something to the callback in order to skip the current record. <code>options.delFilter(row, options, (skip) =&gt; {})</code></li>
<li>batch - delete using bulk operations, all functions must accept an array of rows instead</li>
</ul>
<p>If no <code>options.select</code> is specified only the primary keys will be returned or collected</p>
<p>If <code>db-skip-drop</code> matches the table name and there is no query provided it will exit with error</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>
































        
            

    

    <h4 class="name" id=".db.describeTables"><span class="type-signature type-signature-static">(static) </span>db.describeTables<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Define new tables or extend/customize existing tables. Table definitions are used with every database operation,
on startup, the backend read all existing table columns from the database and cache them in the memory but some properties
like public columns are only specific to the backend so to mark such columns the table with such properties must be described
using this method. Only columns with changed properties need to be specified, other columns will be left as it is.</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>





























    <h5 class="h5-examples">Example</h5>
    
    <pre class="prettyprint"><code>db.describeTables({
             bk_user: { name: { pub: 1 },
                        test: { id: { primary: 1, type: "int" },
                        name: { pub: 1, index: 1 }
         }});</code></pre>





        
            

    

    <h4 class="name" id=".db.drop"><span class="type-signature type-signature-static">(static) </span>db.drop<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Drop a table</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>
































        
            

    

    <h4 class="name" id=".db.dropTables"><span class="type-signature type-signature-static">(static) </span>db.dropTables<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Delete all specified tables from the specific pool or all active pools if <code>options.pool</code> is empty, <code>tables</code> can be a list of tables or an
object with table definitions</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>
































        
            

    

    <h4 class="name" id=".db.get"><span class="type-signature type-signature-static">(static) </span>db.get<span class="signature">(table, query, options<span class="signature-attributes">opt</span>, callback)</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Retrieve one record from the database by primary key, returns found record or null if not found</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>











    <h5 class="h5-parameters">Parameters:</h5>
    

<table class="params">
    <thead>
    <tr>
        
        <th>Name</th>
        

        <th>Type</th>

        
        <th>Attributes</th>
        

        

        <th class="last">Description</th>
    </tr>
    </thead>

    <tbody>
    

        <tr>
            
                <td class="name"><code>table</code></td>
            

            <td class="type">
            
                
<span class="param-type">string</span>



            
            </td>

            
                <td class="attributes">
                

                

                
                </td>
            

            

            <td class="description last"><p>table to read</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>query</code></td>
            

            <td class="type">
            
                
<span class="param-type">object</span>



            
            </td>

            
                <td class="attributes">
                

                

                
                </td>
            

            

            <td class="description last"><p>an object with primary key(s)</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options</code></td>
            

            <td class="type">
            
                
<span class="param-type">DBRequestOptions</span>



            
            </td>

            
                <td class="attributes">
                
                    &lt;optional><br>
                

                

                
                </td>
            

            

            <td class="description last"></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>callback</code></td>
            

            <td class="type">
            
                
<span class="param-type">DBResultCallback</span>



            
            </td>

            
                <td class="attributes">
                

                

                
                </td>
            

            

            <td class="description last"><p>NOTE: On return the <code>info.cached</code> will be set to</p>
<ul>
<li>1 if retrieved from top level cache</li>
<li>2 if retrieved from level 2 cache</li>
<li>0 if retrieved from db and put in the cache</li>
</ul></td>
        </tr>

    
    </tbody>
</table>




















    <h5 class="h5-examples">Example</h5>
    
    <pre class="prettyprint"><code>db.get("bk_user", { login: '12345' }, function(err, row) {
   if (row) console.log(row.name);
});
const user = await db.aget("bk_user", { login: '12345' });</code></pre>





        
            

    

    <h4 class="name" id=".db.getPool"><span class="type-signature type-signature-static">(static) </span>db.getPool<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Return database pool by name or default pool, options can be a pool name or an object with { pool: name } to return
the pool by given name. This call always returns a valid pool object, in case no requested pool found, it returns
the default pool, in case of invalid pool name it returns <code>none</code> pool.
A special pool <code>none</code> always returns empty result and no errors.</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>
































        
            

    

    <h4 class="name" id=".db.incr"><span class="type-signature type-signature-static">(static) </span>db.incr<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Counter operation, increase or decrease column values, similar to update but all specified columns except primary
key will be incremented, use negative value to decrease the value.</p>
<p>If no <code>options.updateOps</code> object specified or no 'incr' operations are provided then
all columns with type 'counter' will be used for the action <code>incr</code></p>
<p><em>Note: The record must exist already for SQL databases, for DynamoDB and Cassandra a new record will be created
if does not exist yet.</em> To disable upsert pass <code>noupsert</code> in the options.</p>
<p>Example</p>
<pre><code>  db.incr(&quot;bk_counter&quot;, { id: '123', like0: 1, invite0: 1 }, (err, rows, info) =&gt; {
  });

  await db.aincr(&quot;bk_counter&quot;, { id: '123', like0: 1, invite0: 1 })
</code></pre></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>
































        
            

    

    <h4 class="name" id=".db.init"><span class="type-signature type-signature-static">(static) </span>db.init<span class="signature">(callback)</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Initialize all database pools. the options may containt the following properties:</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>











    <h5 class="h5-parameters">Parameters:</h5>
    

<table class="params">
    <thead>
    <tr>
        
        <th>Name</th>
        

        <th>Type</th>

        
        <th>Attributes</th>
        

        

        <th class="last">Description</th>
    </tr>
    </thead>

    <tbody>
    

        <tr>
            
                <td class="name"><code>options.createTables</code></td>
            

            <td class="type">
            
                
<span class="param-type">boolean</span>



            
            </td>

            
                <td class="attributes">
                
                    &lt;optional><br>
                

                

                
                </td>
            

            

            <td class="description last"><p>if true then create new tables or upgrade tables with new columns</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.localTables</code></td>
            

            <td class="type">
            
                
<span class="param-type">boolean</span>



            
            </td>

            
                <td class="attributes">
                
                    &lt;optional><br>
                

                

                
                </td>
            

            

            <td class="description last"><p>if true only enable local, default and config pools</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>callback</code></td>
            

            <td class="type">
            
                
<span class="param-type">function</span>



            
            </td>

            
                <td class="attributes">
                

                

                
                </td>
            

            

            <td class="description last"></td>
        </tr>

    
    </tbody>
</table>























        
            

    

    <h4 class="name" id=".db.initColumns"><span class="type-signature type-signature-static">(static) </span>db.initColumns<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Merge cached columns into tables</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>
































        
            

    

    <h4 class="name" id=".db.initConfig"><span class="type-signature type-signature-static">(static) </span>db.initConfig<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Load configuration from the config database, must be configured with <code>db-config</code> pointing to the database pool where bk_config table contains
configuration parameters.</p>
<p>The priority of the parameters goes from the most broad to the most specific, most specific always wins, this allows
for very flexible configuration policies defined by the app or place where instances running and separated by the run mode.
See `db.getConfigTypes`` for more details.</p>
<p>The options takes the following properties:</p>
<ul>
<li>force - if true then force to refresh and reopen all db pools</li>
<li>table - a table where to read the config parameters, default is bk_config</li>
</ul>
<p>Do not create/upgrade tables and indexes when reloading the config, this is to
avoid situations when maintenance is being done and any process reloading the config may
create indexes/columns which are not missing but being provisioned or changed.</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>
































        
            

    

    <h4 class="name" id=".db.initTables"><span class="type-signature type-signature-static">(static) </span>db.initTables<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Merge all tables from all modules</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>
































        
            

    

    <h4 class="name" id=".db.join"><span class="type-signature type-signature-static">(static) </span>db.join<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Join the given list of records with the records from other table by primary key.
The properties from the joined table will be merged with the original rows preserving the existing properties</p>
<ul>
<li>options.keys defines custom primary key to use instead of table's primary key</li>
<li>options.keysMap - an object that defines which property should be used for a key in the given rows, this is
for cases when actual primary keys in the table are different from the rows properties.</li>
<li>options.columnsMap - save properties with a different name using this mapping object</li>
<li>options.existing is 1 then return only joined records.</li>
<li>options.override - joined table properties will replace the original table existing properties</li>
<li>options.attach - specifies a property name which will be used to attach joined record to the original record, no merging will occur, for
non-existing records an empty object will be attached</li>
<li>options.incr can be a list of property names that need to be summed up with each other, not overriden</li>
<li>options.nomerge - do not merge lists, just return new rows as is</li>
</ul>
<p>A special case when table is empty <code>db.join</code> just returns same rows to the callback, this is
for convenience of doing joins on some conditions and trigger it by setting the table name or skip the join completely.</p>
<p>Example:</p>
<pre><code>     db.join(&quot;bk_user&quot;, [{id:&quot;123&quot;,key1:1},{id:&quot;234&quot;,key1:2}], lib.log)
     db.join(&quot;bk_user&quot;, [{aid:&quot;123&quot;,key1:1},{aid:&quot;234&quot;,key1:2}], { keysMap: { id: &quot;aid&quot; }}, lib.log)
     db.join(&quot;bk_user&quot;, [{id:&quot;123&quot;,state:&quot;NY&quot;},{id:&quot;234&quot;,state:&quot;VA&quot;}], { columnsMap: { state: &quot;astate&quot; }}, lib.log)
</code></pre></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>
































        
            

    

    <h4 class="name" id=".db.list"><span class="type-signature type-signature-static">(static) </span>db.list<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Convenient helper to retrieve all records by primary key, the obj must be a list with key property or a string with list of primary key column
Example</p>
<pre><code> db.list(&quot;bk_user&quot;, [&quot;id1&quot;, &quot;id2&quot;], function(err, rows) { console.log(err, rows) });
 db.list(&quot;bk_user&quot;, &quot;id1,id2&quot;, function(err, rows) { console.log(err, rows) });
</code></pre></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>
































        
            

    

    <h4 class="name" id=".db.prepare"><span class="type-signature type-signature-static">(static) </span>db.prepare<span class="signature">()</span><span class="type-signature"> &rarr; {DBRequest}</span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Prepare for execution for the given operation: add, del, put, update,...
Returns prepared object to be passed to the driver's .query method. This method is a part of the driver
helpers and is not used directly in the applications.</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>

























<h5 class="h5-returns">Returns:</h5>

        
<div class="param-desc">
    <ul>
<li>a request object</li>
</ul>
</div>



<dl class="param-type">
    <dt>
        Type
    </dt>
    <dd>
        
<span class="param-type">DBRequest</span>



    </dd>
</dl>

    







        
            

    

    <h4 class="name" id=".db.prepareColumn"><span class="type-signature type-signature-static">(static) </span>db.prepareColumn<span class="signature">()</span><span class="type-signature"> &rarr; {object}</span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Prepare a column for an operation, convert aliases, types and ops according to the request and pool mapping</p>
<p>Op in the name after _$ takes precedence</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>

























<h5 class="h5-returns">Returns:</h5>

        
<div class="param-desc">
    <ul>
<li>an object with final column details: { name, type, op, value, join }</li>
</ul>
</div>



<dl class="param-type">
    <dt>
        Type
    </dt>
    <dd>
        
<span class="param-type">object</span>



    </dd>
</dl>

    




    <h5 class="h5-examples">Example</h5>
    
    <pre class="prettyprint"><code>{ name_$contains: "cat" } // means use the `contains` op for the column `name`</code></pre>





        
            

    

    <h4 class="name" id=".db.prepareForUpdate"><span class="type-signature type-signature-static">(static) </span>db.prepareForUpdate<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Keep only columns from the table definition if we have it
Go over all properties in the object and makes sure the types of the values correspond to the column definition types,
this is for those databases which are very sensitive on the types like DynamoDB.</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>
































        
            

    

    <h4 class="name" id=".db.prepareReq"><span class="type-signature type-signature-static">(static) </span>db.prepareReq<span class="signature">()</span><span class="type-signature"> &rarr; {DBRequest}</span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Prepare a DB request object with required properties</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>

























<h5 class="h5-returns">Returns:</h5>

        
<div class="param-desc">
    <ul>
<li>a request object</li>
</ul>
</div>



<dl class="param-type">
    <dt>
        Type
    </dt>
    <dd>
        
<span class="param-type">DBRequest</span>



    </dd>
</dl>

    







        
            

    

    <h4 class="name" id=".db.put"><span class="type-signature type-signature-static">(static) </span>db.put<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Add/update an object in the database, if object already exists it will be replaced with all new properties from the obj</p>
<ul>
<li>obj - an object with record properties, primary key properties must be specified</li>
<li>options - same properties as for <code>db.add</code> method</li>
</ul>
<p>Example</p>
<pre><code>  db.put(&quot;bk_user&quot;, { id: '123', login: 'test', name: 'test' }, function(err, rows, info) {
  });

  await db.aput(&quot;bk_user&quot;, { id: '123', login: 'test', name: 'test' })
</code></pre></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>
































        
            

    

    <h4 class="name" id=".db.queryProcessSync"><span class="type-signature type-signature-static">(static) </span>db.queryProcessSync<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Post process hook to be used for replicating records to another pool, this is supposed to be used as this:</p>
<p>The conditions when to use it is up to the application logic.</p>
<p>It does not deal with the destination pool to be overloaded, all errors will be ignored, this is for simple and light load only</p>
<p>The destination poll must have tables to be synced configured:</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>





























    <h5 class="h5-examples">Example</h5>
    
    <pre class="prettyprint"><code>db-elasticsearch-pool-tables=table1,table2
db.setProcessRow("post", "*", (req, row) => { db.queryProcessSync("elasticsearch", req, row) });</code></pre>





        
            

    

    <h4 class="name" id=".db.refreshColumns"><span class="type-signature type-signature-static">(static) </span>db.refreshColumns<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Refresh columns for all pools which need it</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>
































        
            

    

    <h4 class="name" id=".db.scan"><span class="type-signature type-signature-static">(static) </span>db.scan<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Convenient helper for scanning a table for some processing, rows are retrieved in batches and passed to the callback until there are no more
records matching given criteria. The obj is the same as passed to the <code>db.select</code> method which defined a condition which records to get.
The rowCallback must be present and is called for every row or batch retrieved and second parameter which is the function to be called
once the processing is complete. At the end, the callback will be called just with 1 argument, err, this indicates end of scan operation.
Basically, db.scan is the same as db.select but can be used to retrieve large number of records in batches and allows async processing of such records.
To hint a driver that scanning is in progress the <code>options.scanning</code> will be set to true.</p>
<p>Parameters:</p>
<ul>
<li>table - table to scan</li>
<li>query - an object with query conditions, same as in <code>db.select</code></li>
<li>options - same as in <code>db.select</code>, with the following additions:</li>
</ul></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>











    <h5 class="h5-parameters">Parameters:</h5>
    

<table class="params">
    <thead>
    <tr>
        
        <th>Name</th>
        

        <th>Type</th>

        

        

        <th class="last">Description</th>
    </tr>
    </thead>

    <tbody>
    

        <tr>
            
                <td class="name"><code>options.count</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>size of every batch, default is 100</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.limit</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>total number of records to scan</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.start</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>the primary key to start the scan from</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.search</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>use search instead of select, for ElasticSearch,...</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.batch</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>if true rowCallback will be called with all rows from the batch, not every row individually, batch size is defined by the count property</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.sync</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>as batch mode but the rowCallback is called synchronously as <code>rowCallback(row, info)</code></p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.concurrency</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>how many rows to process at the same time, if not given process sequentially</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.noscan</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>if 1 no scan will be performed if no primary keys are specified</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.emptyscan</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>if 0 no empty scan will be performed when no table columns in the query to be used as a filter</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.fullscan</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>if 1 force to scan full table without using any primary key conditons, use all query properties for all records (DynamoDB)</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.useCapacity</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>triggers to use specific capacity, default is <code>read</code></p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.factorCapacity</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>a factor to apply for the read capacity limit and triggers the capacity check usage, default is <code>0.9</code></p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.tableCapacity</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>use a different table for capacity throttling instead of the <code>table</code>, useful for cases when the row callback performs
writes into that other table and capacity is different</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.capacity</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>a full capacity object to pass to select calls</p>
<ul>
<li>rowCallback - process records when called like this `callback(rows, next, info)</li>
<li>endCallback - end of scan when called like this: `callback(err)</li>
</ul>
<p>Example:</p>
<pre><code>     db.scan(&quot;bk_user&quot;, {}, { count: 10, pool: &quot;dynamodb&quot; }, function(row, next) {
         // Copy all user from one db into another
         db.add(&quot;bk_user&quot;, row, { pool: &quot;pg&quot; }, next);
     }, function(err) { });
</code></pre></td>
        </tr>

    
    </tbody>
</table>























        
            

    

    <h4 class="name" id=".db.search"><span class="type-signature type-signature-static">(static) </span>db.search<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Perform full text search on the given table, the database implementation may ignore table name completely
in case of global text index.</p>
<p>Query in general is a text string with the format that is supported by the underlying driver,
the db module <em>DOES NOT PARSE</em> the query at all if the driver supports full text search, otherwise it behaves like <code>select</code>.</p>
<p>Options make take the same properties as in the <code>select</code> method.</p>
<p>A special query property <code>q</code> may be used for generic search in all fields.</p>
<p>Without full text search support in the driver this may return nothing or an error.</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>





























    <h5 class="h5-examples">Example</h5>
    
    <pre class="prettyprint"><code>db.search("bk_user", { type: "admin", q: "john*" }, { pool: "elasticsearch" }, lib.log);
 db.search("bk_user", "john*", { pool: "elasticsearch" }, lib.log);
 await db.asearch("bk_user", "john*", { pool: "elasticsearch" });</code></pre>





        
            

    

    <h4 class="name" id=".db.select"><span class="type-signature type-signature-static">(static) </span>db.select<span class="signature">(table, query, options<span class="signature-attributes">opt</span>, callback)</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Select objects from the database that match supplied conditions.</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>











    <h5 class="h5-parameters">Parameters:</h5>
    

<table class="params">
    <thead>
    <tr>
        
        <th>Name</th>
        

        <th>Type</th>

        
        <th>Attributes</th>
        

        

        <th class="last">Description</th>
    </tr>
    </thead>

    <tbody>
    

        <tr>
            
                <td class="name"><code>table</code></td>
            

            <td class="type">
            
                
<span class="param-type">string</span>



            
            </td>

            
                <td class="attributes">
                

                

                
                </td>
            

            

            <td class="description last"><p>table to read</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>query</code></td>
            

            <td class="type">
            
                
<span class="param-type">object</span>



            
            </td>

            
                <td class="attributes">
                

                

                
                </td>
            

            

            <td class="description last"><p>an object with properties for the condition, all matching records will be returned.
Columns may contain deep property path can be used as well, like <code>prop.subprop</code>,
the top level column must be defined to work, this is for DBs that support JSON objects like DymamoDB, Elasticsearch.</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options</code></td>
            

            <td class="type">
            
                
<span class="param-type">DBRequestOptions</span>



            
            </td>

            
                <td class="attributes">
                
                    &lt;optional><br>
                

                

                
                </td>
            

            

            <td class="description last"></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>callback</code></td>
            

            <td class="type">
            
                
<span class="param-type">DBResultCallback</span>



            
            </td>

            
                <td class="attributes">
                

                

                
                </td>
            

            

            <td class="description last"></td>
        </tr>

    
    </tbody>
</table>




















    <h5 class="h5-examples">Example</h5>
    
    <pre class="prettyprint"><code>// get by primary key

db.select("bk_message", { id: '123' }, { count: 2 }, (err, rows) => {  });

// async version
const rows = await db.aselect("bk_message", { id: '123' }, { count: 2 });

// get all icons with type greater or equal to 2

db.select("bk_icon", { id: '123', type: '2' }, { select: 'id,type', ops: { type: 'ge' } }, (err, rows) => { });

// get unread msgs sorted by time, recent first

db.select("bk_message", { id: '123', status: 'N:' }, { sort: "status", desc: 1, ops: { status: "begins_with" } }, (err, rows) => { });

// scan users with custom filter, not by primary key: by exact zipcode

db.select("bk_user", { zipcode: '20000' }, (err, rows) => { });

// select users by type for the last day

db.select("bk_user", { type: 'admin', mtime: Date.now()-86400000 }, { ops: { type: "contains", mtime: "gt" } }, (err, rows) => { });

// select users by JSON sub property using Elasticsearch

db.select("bk_user", { "settings.status": "ok" }, { pool: "elasticsearch" }, (err, rows) => { });</code></pre>





        
            

    

    <h4 class="name" id=".db.setConfig"><span class="type-signature type-signature-static">(static) </span>db.setConfig<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Update and create a DB config record for the given name/type, updates the last record only</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>
































        
            

    

    <h4 class="name" id=".db.sql"><span class="type-signature type-signature-static">(static) </span>db.sql<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Execute arbitrary SQL-like statement if the pool supports it, values must be an Array with query parameters or can be omitted.</p>
<p>Example:</p>
<pre><code>  db.sql(&quot;SELECT * FROM bk_property WHERE value=? LIMIT 1&quot;, [1], { pool: &quot;sqlite&quot;, count: 10 }, lib.log)
  db.sql(&quot;SELECT * FROM bk_property&quot;, { pool: &quot;dynamodb&quot; }, lib.log)
  db.sql(&quot;SELECT * FROM bk_property&quot;, { pool: &quot;dynamodb&quot;, count: 10 }, lib.log)
</code></pre></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>
































        
            

    

    <h4 class="name" id=".db.sqlCreate"><span class="type-signature type-signature-static">(static) </span>db.sqlCreate<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Create SQL table using table definition</p>
<ul>
<li>table - name of the table to create</li>
<li>obj - object with properties as column names and each property value is an object:
<ul>
<li>name - column name</li>
<li>type - type of the column, default is TEXT, options: int, real or other supported types</li>
<li>value - default value for the column</li>
<li>primary - part of the primary key</li>
<li>index - indexed column, part of the composite index</li>
<li>unique - must be combined with index property to specify unique composite index</li>
<li>len - max length of the column</li>
<li>notnull - true if should be NOT NULL</li>
<li>auto - true for AUTO_INCREMENT column</li>
<li>hidden - skip column completely</li>
</ul>
</li>
<li>options may contains:
<ul>
<li>upgrade - perform alter table instead of create</li>
<li>typesMap - type mapping, convert lowercase type into other type supported by any specific database</li>
<li>noDefaults - ignore default value if not supported (Cassandra)</li>
<li>noNulls - NOT NULL restriction is not supported (Cassandra)</li>
<li>noMultiSQL - return as a list, the driver does not support multiple SQL commands</li>
<li>noLengths - ignore column length for columns (Cassandra)</li>
<li>noIfExists - do not support IF EXISTS on table or indexes</li>
<li>noCompositeIndex - does not support composite indexes (Cassandra)</li>
<li>noAuto - no support for auto increment columns</li>
<li>skipNull - object with operations which dont support null(empty) values (DynamoDB cannot add/put empty/null values)</li>
</ul>
</li>
</ul></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>
































        
            

    

    <h4 class="name" id=".db.sqlExpr"><span class="type-signature type-signature-static">(static) </span>db.sqlExpr<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Build SQL expressions for the column and value
options may contain the following properties:</p>
<ul>
<li>op - SQL operator, default is =</li>
<li>type - can be data, string, number, float, expr, default is string</li>
<li>value - default value to use if passed value is null or empty</li>
<li>min, max - are used for numeric values for validation of ranges</li>
<li>expr - for op=expr, contains sprintf-like formatted expression to be used as is with all '%s' substituted with actual value</li>
</ul></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>
































        
            

    

    <h4 class="name" id=".db.sqlWhere"><span class="type-signature type-signature-static">(static) </span>db.sqlWhere<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Build SQL where condition from the keys and object values, returns SQL statement to be used in WHERE</p>
<ul>
<li>query - properties for the condition, in case of an array the primary keys for IN condition will be used only,
a property named or$ or and$ will be treated as a sub-expression if it is an object. Add a number if need multiple OR/AND conditions like
or$$, or$$,...</li>
<li>keys - a list of columns to use for the condition, other properties will be ignored</li>
<li>options may contains the following properties:
<ul>
<li>pool - pool to be used for driver specific functions</li>
<li>ops - an object for comparison operators for primary key, default is equal operator</li>
<li>aliases - an object with column aliases, for cases when more than one time the same column mut be used</li>
</ul>
</li>
<li>join - how to join all expressions, default is AND</li>
</ul></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>
































        
            

    

    <h4 class="name" id=".db.transaction"><span class="type-signature type-signature-static">(static) </span>db.transaction<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Same as the <code>db.bulk</code> but in transaction mode, all operations must succeed or fail. Not every driver can support it,
in DynamoDB case only 10 operations can be done at the same time, if the list is larger then it will be sequentially run with batches of 25 records.</p>
<p>In case of error the second arg will contain the records of the failed batch</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>
































        
            

    

    <h4 class="name" id=".db.update"><span class="type-signature type-signature-static">(static) </span>db.update<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Update existing object in the database.</p>
<ul>
<li>obj - is an actual record to be updated, primary key properties must be specified</li>
<li>options - same properties as for <code>db.add</code> method with the following additional properties:</li>
</ul></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>











    <h5 class="h5-parameters">Parameters:</h5>
    

<table class="params">
    <thead>
    <tr>
        
        <th>Name</th>
        

        <th>Type</th>

        

        

        <th class="last">Description</th>
    </tr>
    </thead>

    <tbody>
    

        <tr>
            
                <td class="name"><code>options.ops</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>object for comparison operators for primary key, default is equal operator</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.opsMap</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>operator mapping into supported by the database</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.typesMap</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>type mapping for properties to be used in the condition</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.aliases</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>an object to map column aliases in the query in case the same column is used ultiple times</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.expected</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>an object with the condition for the update, it is used in addition to the primary keys condition from the <code>obj</code>,
a property named or_$/and_$ will be treated as a sub-expression if it is an object. For multiple OR/AND use
or_$$, or_$$$,...</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.expectedJoin</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>how to join expected expressions: OR, AND, default is AND</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.upsert</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>create a new record if it does not exist</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.syncMode</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>skip columns preprocessing and dynamic values for pool sync and backup restore</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.updateOps</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>an object with column names and operations to be performed on the named column</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.incr</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>increment by given value</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.add</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>add an item to the list</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.del</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>remove an item from the list</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.set</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>to update as it is, for reseting counters forexample</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.concat</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>concatenate given value, for strings if the database supports it</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.append</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>append to the list of values, only for lists if the database supports it</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.prepend</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>insert at the beginning of the list, depends on the database</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.not_exists</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>only update if not exists or null</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.typesOps</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>an object that defines updateOps operation by column type, for example <code>typesOps: { list: &quot;add&quot; }</code> will
make sure all lists will have updateOps set as add if not specified explicitly</p>
<p>Note: not all database drivers support atomic update with conditions, all drivers for SQL, DynamoDB, MongoDB, Redis fully atomic, but other drivers
perform get before put and so subject to race conditions</p>
<p>Example</p>
<pre><code>     db.update(&quot;bk_user&quot;, { login: 'test', id: '123' }, (err, rows, info) =&gt; {
         console.log('updated:', info.affected_rows);
     });

     await db.aupdate(&quot;bk_user&quot;, { login: 'test', name: 'Test')

     db.update(&quot;bk_user&quot;, { login: 'test', id: '123', first_name: 'Mr' }, { pool: pg' }, (err, rows, info) =&gt; {
         console.log('updated:', info.affected_rows);
     });

     db.update(&quot;bk_user&quot;, { login: 'test', first_name: 'John' }, { expected: { first_name: &quot;Carl&quot; } }, (err, rows, info) =&gt; {
         console.log('updated:', info.affected_rows);
     });

     db.update(&quot;bk_user&quot;, { login: 'test', first_name: 'John' }, { expected: { or$: { first_name: &quot;Carl&quot;, g1: null }, aliases: { g1: &quot;first_name&quot; } }, (err, rows, info) =&gt; {
         console.log('updated:', info.affected_rows);
     });
</code></pre></td>
        </tr>

    
    </tbody>
</table>























        
            

    

    <h4 class="name" id=".db.updateAll"><span class="type-signature type-signature-static">(static) </span>db.updateAll<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Update all records that match given condition in the <code>query</code>, one by one, the input is the same as for <code>db.select</code> and every record
returned will be updated using <code>db.update</code> call by the primary key, so make sure options.select include the primary key for every row found by the select.</p>
<p>All properties from the <code>obj</code> will be set in every matched record.</p>
<p>The callback will receive on completion the err and all rows found and updated. This is mostly for non-SQL databases and for very large range it may take a long time
to finish due to sequential update every record one by one.
Special properties that can be in the options for this call:</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>











    <h5 class="h5-parameters">Parameters:</h5>
    

<table class="params">
    <thead>
    <tr>
        
        <th>Name</th>
        

        <th>Type</th>

        

        

        <th class="last">Description</th>
    </tr>
    </thead>

    <tbody>
    

        <tr>
            
                <td class="name"><code>options.updateOptions</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>options to be passed to the db.update if needed, this is useful so select and update options will not be mixed up</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.updateCollect</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>if true return all updated rows in the callback otherwise just the number of updated rows</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.factorCapacity</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>write capacity factor for update operations, default is 0.25</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.op</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>by default it uses db.update but the <code>op</code> can be set to <code>put</code> or <code>add</code></p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.updateProcess</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>a function callback that will be called for each row before updating it, this is for some transformations of the record properties
in case of complex columns that may contain concatenated values as in the case of using DynamoDB. The callback will be called
as <code>options.updateProcess(row, options)</code>. If it returns non-empty value the update will stop and return it as the error.</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options.updateFilter</code></td>
            

            <td class="type">
            
            </td>

            

            

            <td class="description last"><p>a function that must return something to the callback in order to skip the current record. <code>options.updateFilter(row, options, (skip) =&gt; {})</code></p>
<p>If no <code>options.select</code> is specified only the primary keys will be returned or collected</p>
<p>Example, update birthday format if not null</p>
<pre><code>     db.updateAll(&quot;bk_user&quot;,
                 { birthday: 1 },
                 { mtime: Date.now() },
                 { ops: { birthday: &quot;not null&quot; },
                   updateProcess: function(r, o) {
                      r.birthday = lib.strftime(new Date(r.birthday, &quot;%Y-%m-D&quot;));
                   },
                   updateFilter: function(r, o, cb) {
                      cb(r.status == 'ok');
                   } },
     function(err, count) {
        console.log(count, &quot;rows updated&quot;);
     });
</code></pre></td>
        </tr>

    
    </tbody>
</table>























        
            

    

    <h4 class="name" id=".db.upgrade"><span class="type-signature type-signature-static">(static) </span>db.upgrade<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Upgrade a table with missing columns from the definition list, if after the upgrade new columns must be re-read from the database
then <code>info.affected_rows</code> must be non zero.</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>
































        
            

    

    <h4 class="name" id=".query"><span class="type-signature type-signature-static">(static) </span>query<span class="signature">(req, options<span class="signature-attributes">opt</span>, callback<span class="signature-attributes">opt</span>)</span><span class="type-signature"></span></h4>

    




<dl class="details">
    
    <dt class="tag-description">Description:</dt>
    <dd class="tag-description"><ul class="dummy"><li><p>Execute query using native database driver, the query is passed directly to the driver.</p></li></ul></dd>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>











    <h5 class="h5-parameters">Parameters:</h5>
    

<table class="params">
    <thead>
    <tr>
        
        <th>Name</th>
        

        <th>Type</th>

        
        <th>Attributes</th>
        

        

        <th class="last">Description</th>
    </tr>
    </thead>

    <tbody>
    

        <tr>
            
                <td class="name"><code>req</code></td>
            

            <td class="type">
            
                
<span class="param-type">DBRequest</span>



            
            </td>

            
                <td class="attributes">
                

                

                
                </td>
            

            

            <td class="description last"><p>an object with request required data</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>options</code></td>
            

            <td class="type">
            
                
<span class="param-type">DBRequestOptions</span>



            
            </td>

            
                <td class="attributes">
                
                    &lt;optional><br>
                

                

                
                </td>
            

            

            <td class="description last"><p>optional properties customizations</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>callback</code></td>
            

            <td class="type">
            
                
<span class="param-type">DBResultCallback</span>



            
            </td>

            
                <td class="attributes">
                
                    &lt;optional><br>
                

                

                
                </td>
            

            

            <td class="description last"><p>an error or result</p></td>
        </tr>

    
    </tbody>
</table>




















    <h5 class="h5-examples">Example</h5>
    
    <pre class="prettyprint"><code>db.query({ text: "SELECT a.id,c.type FROM bk_user a,bk_icon c WHERE a.id=c.id and a.id=?", values: ['123'] }, { pool: 'pg' }, (err, rows, info) => {
    ...
});</code></pre>





        
    

    
</article>

</section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>