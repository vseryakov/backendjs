<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>Tutorial: README - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Counter.html">Counter</a><ul class='typedefs'></ul></li><li><a href="Pool.html">Pool</a><ul class='typedefs'></ul></li><li><a href="WebpushClient.html">WebpushClient</a><ul class='typedefs'></ul></li><li><a href="module-Fetch.FetchRequest.html">FetchRequest</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-Fetch.FetchRequest.html#parseCookies">parseCookies</a></li><li data-type='method' style='display: none;'><a href="module-Fetch.FetchRequest.html#toJSON">toJSON</a></li></ul><ul class='typedefs'></ul></li><li><a href="module-cache.CacheClient.html">CacheClient</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-cache.CacheClient.html#applyOptions">applyOptions</a></li><li data-type='method' style='display: none;'><a href="module-cache.CacheClient.html#clear">clear</a></li><li data-type='method' style='display: none;'><a href="module-cache.CacheClient.html#close">close</a></li><li data-type='method' style='display: none;'><a href="module-cache.CacheClient.html#del">del</a></li><li data-type='method' style='display: none;'><a href="module-cache.CacheClient.html#get">get</a></li><li data-type='method' style='display: none;'><a href="module-cache.CacheClient.html#incr">incr</a></li><li data-type='method' style='display: none;'><a href="module-cache.CacheClient.html#limiter">limiter</a></li><li data-type='method' style='display: none;'><a href="module-cache.CacheClient.html#lock">lock</a></li><li data-type='method' style='display: none;'><a href="module-cache.CacheClient.html#put">put</a></li><li data-type='method' style='display: none;'><a href="module-cache.CacheClient.html#stats">stats</a></li><li data-type='method' style='display: none;'><a href="module-cache.CacheClient.html#unlock">unlock</a></li></ul><ul class='typedefs'></ul></li><li><a href="module-cache.LocalClient.html">LocalClient</a><ul class='typedefs'></ul></li><li><a href="module-cache.RedisClient.html">RedisClient</a><ul class='typedefs'></ul></li><li><a href="module-cache.WorkerClient.html">WorkerClient</a><ul class='typedefs'></ul></li><li><a href="module-db.DBPool.html">DBPool</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-db.DBPool.html#bindValue">bindValue</a></li><li data-type='method' style='display: none;'><a href="module-db.DBPool.html#cacheColumns">cacheColumns</a></li><li data-type='method' style='display: none;'><a href="module-db.DBPool.html#cacheIndexes">cacheIndexes</a></li><li data-type='method' style='display: none;'><a href="module-db.DBPool.html#close">close</a></li><li data-type='method' style='display: none;'><a href="module-db.DBPool.html#configure">configure</a></li><li data-type='method' style='display: none;'><a href="module-db.DBPool.html#convertError">convertError</a></li><li data-type='method' style='display: none;'><a href="module-db.DBPool.html#exists">exists</a></li><li data-type='method' style='display: none;'><a href="module-db.DBPool.html#nextToken">nextToken</a></li><li data-type='method' style='display: none;'><a href="module-db.DBPool.html#open">open</a></li><li data-type='method' style='display: none;'><a href="module-db.DBPool.html#prepare">prepare</a></li><li data-type='method' style='display: none;'><a href="module-db.DBPool.html#prepareOptions">prepareOptions</a></li><li data-type='method' style='display: none;'><a href="module-db.DBPool.html#prepareRow">prepareRow</a></li><li data-type='method' style='display: none;'><a href="module-db.DBPool.html#query">query</a></li><li data-type='method' style='display: none;'><a href="module-db.DBPool.html#shutdown">shutdown</a></li></ul><ul class='typedefs'></ul></li><li><a href="module-db.SqlPool.html">SqlPool</a><ul class='typedefs'></ul></li><li><a href="module-db_elasticsearch.ElasticsearchPool.html">ElasticsearchPool</a><ul class='typedefs'></ul></li><li><a href="module-queue.EventBridgeClient.html">EventBridgeClient</a><ul class='typedefs'></ul></li><li><a href="module-queue.JSONClient.html">JSONClient</a><ul class='typedefs'></ul></li><li><a href="module-queue.LocalClient.html">LocalClient</a><ul class='typedefs'></ul></li><li><a href="module-queue.NatsClient.html">NatsClient</a><ul class='typedefs'></ul></li><li><a href="module-queue.QueueClient.html">QueueClient</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-queue.QueueClient.html#channel">channel</a></li><li data-type='method' style='display: none;'><a href="module-queue.QueueClient.html#monitor">monitor</a></li><li data-type='method' style='display: none;'><a href="module-queue.QueueClient.html#schedule">schedule</a></li></ul><ul class='typedefs'></ul></li><li><a href="module-queue.RedisClient.html">RedisClient</a><ul class='typedefs'></ul></li><li><a href="module-queue.SNSClient.html">SNSClient</a><ul class='typedefs'></ul></li><li><a href="module-queue.SQSClient.html">SQSClient</a><ul class='typedefs'></ul></li><li><a href="module-queue.WorkerClient.html">WorkerClient</a><ul class='typedefs'></ul></li></ul><h3>Modules</h3><ul><li><a href="module-Fetch.html">Fetch</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-Fetch.html#~Fetch">Fetch</a></li></ul><ul class='typedefs'></ul></li><li><a href="module-api.html">api</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api.html#.api.checkProxy">api.checkProxy</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.checkRateLimits">api.checkRateLimits</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.checkRedirectPlaceholders">api.checkRedirectPlaceholders</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.cleanupHeaders">api.cleanupHeaders</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.cleanupResult">api.cleanupResult</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.createServer">api.createServer</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.getResultPage">api.getResultPage</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.getTokenSecret">api.getTokenSecret</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.handleBody">api.handleBody</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.handleCleanup">api.handleCleanup</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.handleMetrics">api.handleMetrics</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.handleMultipart">api.handleMultipart</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.init">api.init</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.prepareOptions">api.prepareOptions</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.prepareRequest">api.prepareRequest</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.registerPreHeaders">api.registerPreHeaders</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.registerRateLimits">api.registerRateLimits</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.sendFile">api.sendFile</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.sendFormatted">api.sendFormatted</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.sendJSON">api.sendJSON</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.sendReply">api.sendReply</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.sendStatus">api.sendStatus</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.shutdown">api.shutdown</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.startMetrics">api.startMetrics</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.api.toParams">api.toParams</a></li></ul><ul class='typedefs'></ul></li><li><a href="module-app.html">app</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-app.html#.app.addModule">app.addModule</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.checkConfig">app.checkConfig</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.createRepl">app.createRepl</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.fetch">app.fetch</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.init">app.init</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.isOk">app.isOk</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.killBackend">app.killBackend</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.loadModules">app.loadModules</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.loadPackages">app.loadPackages</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.parseArgs">app.parseArgs</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.parseConfig">app.parseConfig</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.processArg">app.processArg</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.processArgs">app.processArgs</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.processEnvArgs">app.processEnvArgs</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.processName">app.processName</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.runMethods">app.runMethods</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.setHome">app.setHome</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.setHost">app.setHost</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.setLogInspect">app.setLogInspect</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.showHelp">app.showHelp</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.shutdown">app.shutdown</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.sortModules">app.sortModules</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.start">app.start</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.startRepl">app.startRepl</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.app.watchTmp">app.watchTmp</a></li></ul><ul class='typedefs'></ul></li><li><a href="module-aws.html">aws</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.cwGetMetricData">aws.cwGetMetricData</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.cwListMetrics">aws.cwListMetrics</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.cwPutLogEvents">aws.cwPutLogEvents</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.cwPutMetricAlarm">aws.cwPutMetricAlarm</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.cwPutMetricData">aws.cwPutMetricData</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.cwlFilterLogEvents">aws.cwlFilterLogEvents</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.ddbBatchGetItem">aws.ddbBatchGetItem</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.ddbBatchWriteItem">aws.ddbBatchWriteItem</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.ddbCreateTable">aws.ddbCreateTable</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.ddbDeleteItem">aws.ddbDeleteItem</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.ddbDeleteTable">aws.ddbDeleteTable</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.ddbDescribeTable">aws.ddbDescribeTable</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.ddbGetItem">aws.ddbGetItem</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.ddbPutItem">aws.ddbPutItem</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.ddbQueryTable">aws.ddbQueryTable</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.ddbScanTable">aws.ddbScanTable</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.ddbTransactWriteItems">aws.ddbTransactWriteItems</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.ddbUpdateItem">aws.ddbUpdateItem</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.ddbUpdateTable">aws.ddbUpdateTable</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.ddbUpdateTimeToLive">aws.ddbUpdateTimeToLive</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.ddbWaitForTable">aws.ddbWaitForTable</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.queryCW">aws.queryCW</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.queryCWL">aws.queryCWL</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.querySQS">aws.querySQS</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.sqsReceiveMessage">aws.sqsReceiveMessage</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.sqsSendMessage">aws.sqsSendMessage</a></li></ul><ul class='typedefs'></ul></li><li><a href="module-cache.html">cache</a><ul class='typedefs'></ul></li><li><a href="module-db.html">db</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-db.html#.aadd">aadd</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.abatch">abatch</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.abulk">abulk</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.acopy">acopy</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.acreate">acreate</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.add">add</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.adel">adel</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.adelAll">adelAll</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.adrop">adrop</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.aget">aget</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.aincr">aincr</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.ajoin">ajoin</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.alist">alist</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.applyPoolOptions">applyPoolOptions</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.aput">aput</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.aquery">aquery</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.ascan">ascan</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.asearch">asearch</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.aselect">aselect</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.asql">asql</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.atransaction">atransaction</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.aupdate">aupdate</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.aupdateAll">aupdateAll</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.aupgrade">aupgrade</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.batch">batch</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.bulk">bulk</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.cacheColumns">cacheColumns</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.configTypes">configTypes</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.convertError">convertError</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.convertRows">convertRows</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.copy">copy</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.create">create</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.createTables">createTables</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.del">del</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.delAll">delAll</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.describeTables">describeTables</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.drop">drop</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.dropTables">dropTables</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.get">get</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.getCached">getCached</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.getConfig">getConfig</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.getPool">getPool</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.getPoolTables">getPoolTables</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.getPools">getPools</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.getProcessRows">getProcessRows</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.incr">incr</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.init">init</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.initColumns">initColumns</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.initConfig">initConfig</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.initTables">initTables</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.join">join</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.list">list</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.prepare">prepare</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.prepareColumn">prepareColumn</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.prepareReq">prepareReq</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.prepareRow">prepareRow</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.put">put</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.query">query</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.queryProcessSync">queryProcessSync</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.refreshColumns">refreshColumns</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.runProcessRows">runProcessRows</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.scan">scan</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.search">search</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.select">select</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.setConfig">setConfig</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.setProcessColumns">setProcessColumns</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.setProcessRow">setProcessRow</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.sql">sql</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.sqlCacheColumns">sqlCacheColumns</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.sqlColumn">sqlColumn</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.sqlCreate">sqlCreate</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.sqlDelete">sqlDelete</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.sqlDrop">sqlDrop</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.sqlExpr">sqlExpr</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.sqlGet">sqlGet</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.sqlInsert">sqlInsert</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.sqlLimit">sqlLimit</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.sqlPrepare">sqlPrepare</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.sqlQuery">sqlQuery</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.sqlQuote">sqlQuote</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.sqlSelect">sqlSelect</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.sqlTime">sqlTime</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.sqlUpgrade">sqlUpgrade</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.sqlUpgrade">sqlUpgrade</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.sqlValue">sqlValue</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.sqlValueIn">sqlValueIn</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.sqlWhere">sqlWhere</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.transaction">transaction</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.update">update</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.updateAll">updateAll</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.upgrade">upgrade</a></li></ul><ul class='typedefs'><li data-type='typedef' style='display: none;'><a href="module-db.html#~DBColumn">DBColumn</a></li><li data-type='typedef' style='display: none;'><a href="module-db.html#~DBRequest">DBRequest</a></li><li data-type='typedef' style='display: none;'><a href="module-db.html#~DBRequestOptions">DBRequestOptions</a></li><li data-type='typedef' style='display: none;'><a href="module-db.html#~DBResultCallback">DBResultCallback</a></li><li data-type='typedef' style='display: none;'><a href="module-db.html#~DBTable">DBTable</a></li></ul></li><li><a href="module-db_elasticsearch.html">db/elasticsearch</a><ul class='typedefs'></ul></li><li><a href="module-events.html">events</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-events.html#.events.putEvent">events.putEvent</a></li></ul><ul class='typedefs'></ul></li><li><a href="module-ipc.html">ipc</a><ul class='typedefs'></ul></li><li><a href="module-jobs.html">jobs</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-jobs.html#~_badJob">_badJob</a></li></ul><ul class='typedefs'></ul></li><li><a href="module-lib.html">lib</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-lib.html#.lib.configParse">lib.configParse</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.lib.jsonParse">lib.jsonParse</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.lib.xmlParse">lib.xmlParse</a></li></ul><ul class='typedefs'></ul></li><li><a href="module-logger.html">logger</a><ul class='typedefs'></ul></li><li><a href="module-logwatcher.html">logwatcher</a><ul class='typedefs'></ul></li><li><a href="module-metrics.html">metrics</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-metrics.html#.toJSON">toJSON</a></li></ul><ul class='typedefs'></ul></li><li><a href="module-push.html">push</a><ul class='typedefs'></ul></li><li><a href="module-queue.html">queue</a><ul class='typedefs'></ul></li><li><a href="module-sendmail.html">sendmail</a><ul class='typedefs'></ul></li><li><a href="module-stats.html">stats</a><ul class='typedefs'></ul></li><li><a href="module-ws.html">ws</a><ul class='typedefs'></ul></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-README.html">README</a><ul class='typedefs'></ul></li><li><a href="tutorial-configureModules.html">configureModules</a><ul class='typedefs'></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#ExponentiallyMovingWeightedAverage">ExponentiallyMovingWeightedAverage</a></li><li><a href="global.html#Meter">Meter</a></li><li><a href="global.html#_skip32table">_skip32table</a></li><li><a href="global.html#lib">lib</a></li><li><a href="global.html#mod">mod</a></li><li><a href="global.html#net">net</a></li><li><a href="global.html#perf_hooks">perf_hooks</a></li><li><a href="global.html#runMethod">runMethod</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">Tutorial: README</h1>
    

    <section>

<header>
    

    <h2>README</h2>
</header>

<article>
    <h1>Quick start</h1>
<ul>
<li>
<p>To start a bare-bone server</p>
<pre><code>  npm run watch
</code></pre>
<p>Now point your browser to http://localhost:8000/doc.html</p>
<p>The server is running with default configuration, while no custom code is loaded it still can serve internal API requests
described below and serve static assets from the web/ folder.</p>
</li>
<li>
<p>Programmatic way to start the server</p>
<pre><code>  $ node
  &gt; const { server, api } = require('backendjs')
  &gt; server.start({ api: 1 })
</code></pre>
</li>
<li>
<p>By default access is allowed only with valid session or signature, to see all public urls type in the node shell above:</p>
<pre><code>  &gt; api.allowPath
</code></pre>
<p>This property of the api module corresponds to the the <code>-api-allow-path</code> config parameter, see it in your browser
at <a href="http://localhost:8000/doc.html#module-api">docs</a>.</p>
</li>
<li>
<p>No database driver is enabled by default so here are examples to load local PostgreSQL, DynamoDB or ElasticSearch</p>
<pre><code>  bkjs run -api -db-pool sqlite -db-sqlite-pool
  bkjs run -api -db-pool pg -db-pg-pool
  bkjs run -api -db-pool dynamodb -db-dynamodb-pool
  bkjs run -api -db-pool elasticsearch -db-elasticsearch-pool
</code></pre>
</li>
<li>
<p>All command line parameters from the above can be saved in the <code>~.bkjs/etc/config.local</code> making pg the default database</p>
<pre><code>  db-pool=sqlite
  db-sqlite-pool=default
  db-pg-pool=default
  db-dynamdb-pool=default
  db-elasticsearch-pool=default
</code></pre>
</li>
<li>
<p>To start Node.js shell with backendjs loaded and initialized, all internal modules in shell are global for convenience</p>
<pre><code>  bkjs shell
</code></pre>
</li>
<li>
<p>Here is preview how the database can be accessed using internal DB methods with native Sqlite module:</p>
<pre><code>  bkjs shell -db-sqlite-pool -db-pool sqlite -db-create-tables

  &gt; db.select(&quot;bk_user&quot;, {}, lib.log);
  &gt; db.add(&quot;bk_user&quot;, { login: 'test2', name: 'Test2 name' }, lib.log);
  &gt; db.select(&quot;bk_user&quot;, { login: 'test2' }, lib.log);
  &gt; db.select(&quot;bk_user&quot;, { login: ['test1','test2'] }, { ops: { login: &quot;in&quot; } }, lib.log);
</code></pre>
</li>
</ul>
<p>or the same using async/await, same methods with <code>a</code> prepended to the name</p>
<pre><code>    &gt; await db.aselect(&quot;bk_user&quot;, {});
    &gt; await db.aadd(&quot;bk_user&quot;, { login: 'test2', name: 'Test2 name' });
    &gt; await db.aselect(&quot;bk_user&quot;, { login: 'test2' });
</code></pre>
<ul>
<li>
<p>To search using Elasticsearch full text capabilities</p>
<pre><code>  &gt; await db.aselect(&quot;bk_user&quot;, { q: 'test' }, { pool: &quot;elasticsearch&quot; });
</code></pre>
</li>
</ul>
<h2>To run an example</h2>
<ul>
<li>
<p>The library is packaged with copies of Bootstrap, jQuery, Knockout.js, Alpine.js for quick Web prototyping
in web/js and web/css directories, all scripts are available from the browser with /js or /css paths.</p>
</li>
<li>
<p>Go to <code>examples</code> directory, it has several apps with README.md explaining how to run each.</p>
</li>
<li>
<p>Go to an application directory and run:</p>
<pre><code>  ./app.sh
</code></pre>
</li>
<li>
<p>When the web server is started with <code>-watch</code> parameter or as <code>bkjs watch</code> then any change in the source files will make the server restart automatically
letting you focus on the source code and not server management, this mode is only enabled by default in development mode,
check <code>app.sh</code> for parameters before running it in production.</p>
</li>
</ul>
<h1>Dependencies</h1>
<p>Only core required dependencies are installed but there are many modules which require a module to work correctly.</p>
<p>All optional dependencies are listed in the package.json under &quot;optionalDependencies&quot; so npm cannot use it, only manual install of required modules is supported or
it is possible to install all optional dependencies for development purposes.</p>
<p>Here is the list of modules for each internal feature:</p>
<ul>
<li><code>pg</code> - PostgreSQL database access</li>
<li><code>redis</code> - for Redis queue and cache driver</li>
<li><code>unix-dgram</code> - for Linux to use local syslog via Unix domain</li>
<li><code>web-push</code> - for Web push notifications</li>
<li><code>@parse/node-apn</code> - for Apple push notifications</li>
<li><code>sharp</code> - scaling images in uploads using VPS imaging</li>
<li><code>nats</code> - NATS driver for queue and events</li>
</ul>
<p>The command below will show all core and optional dependencies, <code>npm install</code> will install only the core dependencies</p>
<pre><code>npm install --include=optional
</code></pre>
<h1>Configuration</h1>
<p>Almost everything in the backend is configurable using config files or a config database.
The whole principle behind it is that once deployed in production, sometimes even quick restarts are impossible to do so
there should be a way to push config changes to the processes without restarting.</p>
<p>Every module defines a set of config parameters that defines the behavior of the code, due to the single threaded
nature of the Node.js. It is simple to update any config parameter to a new value so the code can operate differently.
To achieve this the code must be written in a special way, like driven by configuration which can be changed at
any time.</p>
<p>All configuration goes through the configuration process that checks all inputs and produces valid output which
is applied to the module variables. Config file or database table with configuration can be loaded on demand or
periodically, for example all local config files are watched for modification and reloaded automatically, the
config database is loaded periodically which is defined by another config parameter.</p>
<h1>Backend runtime</h1>
<p>When the backendjs server starts it spawns several processes that perform different tasks.</p>
<p>There are 2 major tasks of the backend that can be run at the same time or in any combination:</p>
<ul>
<li>a Web server (server) with Web workers (web)</li>
<li>a job scheduler (master)</li>
</ul>
<p>This is the typical output from the ps command on Linux server:</p>
<pre><code>ec2-user    899  0.0  0.6 1073844 52892 ?  Sl   14:33   0:01 bkjs: master
ec2-user    917  0.0  0.7 1072820 59008 ?  Sl   14:33   0:01 bkjs: web
ec2-user    919  0.0  0.7 1072820 60792 ?  Sl   14:33   0:02 bkjs: web
ec2-user    921  0.0  0.7 1072120 40721 ?  Sl   14:33   0:02 bkjs: worker
</code></pre>
<p>To enable any task a command line parameter must be provided, it cannot be specified in the config file. The <code>bkjs</code> utility supports several
commands that simplify running the backend in different modes.</p>
<ul>
<li><code>bkjs start</code> - this command is supposed to be run at the server startup as a service, it runs in the background and the monitors all tasks,
the env variable <code>BKJS_SERVER</code> must be set in the profile to <code>master</code> to start the server</li>
<li><code>bkjs watch</code> - runs the master and Web server in wather mode checking all source files for changes, this is the common command to be used
in development, it passes the command line switches: <code>-watch -master</code></li>
<li><code>bkjs master</code> - this command is supposed to be run at the server startup, it runs in the background and the monitors all processes,
the command line parameters are: <code>-daemon -master -syslog</code>, web server and workers are started by default</li>
<li><code>bkjs run</code> - this command runs without other parameters, all additional parameters can be added in the command line, this command
is a barebone helper to be used with any other custom settings.</li>
<li><code>bkjs run -api</code> - this command runs a single process as web server, sutable for Docker</li>
<li><code>bkjs run -worker</code> - this command runs a single process worker, suatable for Docker</li>
<li><code>bkjs shell</code> or <code>bksh</code> - start backendjs shell, no API or Web server is initialized, only the database pools</li>
</ul>
<h1>Application structure</h1>
<p>The main purpose of the backendjs is to provide API to access the data, the data can be stored in the database or some other way
but the access to that data will be over HTTP and returned back as JSON. This is default functionality but any custom application
may return data in whatever format is required.</p>
<p>Basically the backendjs is a Web server with ability to perform data processing using local or remote jobs which can be scheduled similar to Unix cron or
requested on demand.</p>
<p>The principle behind the system is that the API services just return data and Web or mobiles apps can render it to
the user without the backend involved. It does not mean this is simple gateway between the database, in many cases it is but if special
processing of the data is needed before sending it to the user, it is possible to do and backendjs provides many convenient helpers and tools for it.</p>
<p>When the API layer is initialized, the api module contains <code>app</code> object which is an Express server.</p>
<p>Special empty module <code>app</code> is designated to be used for quick application development/prototyping. This module is available in the same way as <code>api</code> and <code>core</code> which makes it easy to refer and extend with additional methods and structures.</p>
<p>An example structure of a generic single file application, app.js</p>
<pre class="prettyprint source lang-javascript"><code>    const { core, api, db, server } = require(&quot;backendjs&quot;);

    const mymod = {
        name: &quot;mymod&quot;,
        args: [
            { name: &quot;types&quot;, type: &quot;list&quot;, descr: &quot;Types allowed&quot; },
            { name: &quot;size&quot;, type: &quot;int&quot;, descr: &quot;Records in one page&quot; },
        ],
        tables: {
            mytable: {
                id: { type: &quot;int&quot;, primary: 1 },
                name: { primary: 2 },
                type: { type: &quot;list&quot; },
                descr: {}
            }
        }
    };
    exports.module = mymod;
    app.addModule(mymod);

    mymod.configureWeb = function(options, callback)
    {
        api.app.all(&quot;/listTypes&quot;, async (req, res) => {
            var query = api.getQuery(req, {
                id: { required: 1 },
                type: { required: 1, values: mod.types },
            });
            if (typeof query == &quot;string&quot;) return api.sendReply(res, 400, query);

            const rows = await db.aselect(&quot;mymod&quot;, query, { ops: { type: &quot;in&quot; }, count: mod.size });
            api.sendJSON(req, null, rows);
        });
    }

    server.start();
</code></pre>
<p>To run it:</p>
<pre><code>    node app.js -api -mymod-size 20 -mymod-types t1,t2,t3
</code></pre>
<p>As with any Node.js application, node modules are the way to build and extend the functionality, backendjs does not restrict how
the application is structured but has predefined conventions to make it easy.</p>
<h2>Modules</h2>
<p>The primary way to add functionality to the backend is via external modules specific to the backend, these modules are loaded on startup from the backend
home subdirectory <code>modules/</code>. The format is the same as for regular Node.js modules and only top level .js files are loaded on the backend startup.</p>
<p>Once loaded they have the same access to the backend as the rest of the code, the only difference is that they reside in the backend home and
can be shipped regardless of the npm, node modules and other env setup.</p>
<p>All modules are exposed in the top level <code>modules</code> module. This is a way for global access to modules by name.</p>
<p>By having module names contain dots it is possible to create a module hierarchy, for example
modules with names <code>billing.invoices</code>, <code>billing.payable</code>, <code>billing.stripe</code> can be accessed like this:</p>
<pre><code>  const { modules } = require(&quot;backendjs&quot;);
  modules.billing.invoices....
  modules.billing.payable...
  modules.billing.stripe...
</code></pre>
<p>Let's assume the <code>modules/</code> contains file facebook.js which implements custom FB logic:</p>
<pre class="prettyprint source lang-javascript"><code>    const { core } = require(&quot;backendjs&quot;);

    const mod = {
        name: &quot;facebook&quot;,
        args: [
            { name: &quot;token&quot;, descr: &quot;API token&quot; },
        ]
    }
    module.exports = mod;

    mod.configureWeb = function(options, callback) {
       ...
    }

    mod.makeRequest = function(options, callback) {
         app.fetch({ url: options.path, query: { access_token: fb.token } }, callback);
    }
</code></pre>
<p>This is the main app code:</p>
<pre class="prettyprint source lang-javascript"><code>    const { api, modules, server } = require(&quot;backendjs&quot;);

    // Using facebook module in the main app
    api.app.get(&quot;/me&quot;, (req, res) => {

       modules.facebook.makeRequest({ path: &quot;/me&quot; }, (err, data) => {
          api.sendJSON(req, err, data);
       });
    });

    server.start();
</code></pre>
<p>To run:</p>
<pre><code>    node app.js -api -modules-path $(pwd)/modules
</code></pre>
<h2>NPM packages as modules</h2>
<p>In case different modules is better keep separately for maintenance or development purposes they can be split into
separate NPM packages, the structure is the same, modules must be in the <code>modules/</code> folder and the package must be loadable
via require as usual. In most cases just empty index.js is enough. Such modules will not be loaded via require though but
by the backendjs <code>app.loadModule</code> machinery, the NPM packages are just keep different module directories separate from each other.</p>
<p>The config parameter <code>import-packages</code> can be used to specify NPM package names to be loaded separated by comma, as with the default
application structure all subfolders inside each NPM package will be added to the core:</p>
<ul>
<li>modules will be loaded from the modules/ folder</li>
<li>files in the web/ folder will be added to the static search path</li>
<li>all templates from views/ folder will be used for rendering</li>
</ul>
<p>If there is a config file present as <code>etc/config</code> it will be loaded as well, this way each package can maintain its default config parameters if necessary
without touching other or global configuration. Although such config files will not be reloaded on changes, when NPM installs or updates packages it
moves files around so watching the old config is no point because the updated config file will be different.</p>
<h1>Database schema definition</h1>
<p>The backend support multiple databases and provides the same db layer for access. Common operations are supported and all other
specific usage can be achieved by using SQL directly or other query language supported by any particular database.</p>
<p>The database operations supported in the unified way provide simple actions like <code>db.get, db.put, db.update, db.del, db.select</code>.
The <code>db.query</code> method provides generic access to the database driver and executes given query directly by the db driver,
it can be SQL or other driver specific query request.</p>
<p>Before the tables can be queried the schema must be defined and created, the backend db layer provides simple functions to do it:</p>
<ul>
<li>first the table needs to be described, this is achieved by creating a JavaScript object with properties describing each column, multiple tables can be described
at the same time, for example lets define album table and make sure it exists when we run our application:</li>
</ul>
<pre class="prettyprint source lang-javascript"><code>        db.describeTables({
           album: {
               id: { primary: 1 },                         // Primary key for an album
               name: { pub: 1 },                           // Album name, public column
               mtime: { type: &quot;now&quot; },                     // Modification timestamp
           },
           photo: {
               album_id: { primary: 1 },                   // Combined primary key
               id: { primary: 1 },                         // consisting of album and photo id
               name: { pub: 1, index: 1 },                 // Photo name or description, public column with the index for faster search
               mtime: { type: &quot;now&quot; }
           }
        });
</code></pre>
<ul>
<li>the system will automatically create the album and photos tables, this definition must remain in the app source code
and be called on every app startup. This allows 1) to see the db schema while working with the app and 2) easily maintain it by adding new columns if
necessary, all new columns will be detected and the database tables updated accordingly. And it is all JavaScript, no need to learn one more language or syntax
to maintain database tables.</li>
</ul>
<p>Each database may restrict how the schema is defined and used, the db layer does not provide an artificial layer hiding all specifics,
it just provides the same API and syntax, for example, DynamoDB tables must have only hash primary key or combined hash and range
key, so when creating table to be used with DynamoDB, only one or two columns can be marked with primary property while for SQL
databases the composite primary key can consist of more than 2 columns.</p>
<p>The backendjs always creates several tables in the configured database pools by default, these tables are required to support
default API functionality and some are required for backend operations. Refer below for the JavaScript modules documentation
that described which tables are created by default. In the custom applications the <code>db.describeTables</code> method can modify columns
in the default table and add more columns if needed.</p>
<p>The cleanup of the public columns is done by the <code>api.cleanupResult</code> inside <code>api.sendJSON</code> which is used by all API routes when ready to send data back
to the client. If any post-process hooks are registered and return data itself then it is the hook responsibility to cleanup non-public columns.</p>
<pre class="prettyprint source lang-javascript"><code>    db.describeTables({
        bk_user: {
            birthday: { pub: 1 },
            occupation: { pub: 1 },
        });

    app.configureWeb = function(options, callback)
    {
        db.setProcessRow(&quot;post&quot;, &quot;bk_user&quot;, (req, row, options) => {
            if (row.birthday) {
                row.age = Math.floor((Date.now() - lib.toDate(row.birthday))/(86400000*365));
            }
        }
        ...
        callback();
    }
</code></pre>
<p>To define tables inside a module just provide a <code>tables</code> property in the module object, it will be picked up by database initialization automatically.</p>
<pre class="prettyprint source lang-javascript"><code>    const mod = {
        name: &quot;billing&quot;,
        tables: {
            invoices: {
                id: { type: &quot;int&quot;, primary: 1 },
                name: {},
                price: { type: &quot;real&quot; },
                mtime: { type: &quot;now&quot; }
            }
        }
    }
    module.exports = mod;

    // Run db setup once all the DB pools are configured, for example produce dynamic icon property
    // for each record retrieved
    mod.configureModule = function(options, callback)
    {
        db.setProcessRows(&quot;post&quot;, &quot;invoices&quot;, function(req, row, opts) {
           if (row.id) row.icon = &quot;/images/&quot; + row.id + &quot;.png&quot;;
        });

        callback();
    }
</code></pre>
<h2>Tables can have aliases</h2>
<p>This is useful for easier naming conventions or switching to a different table name on the fly without changinbf the code,
access to the table by it is real name is always available.</p>
<p>For example:</p>
<pre><code>bksh -db-aliases-bk_user users

&gt; await db.aget(&quot;bk_user&quot;, { login: &quot;u1&quot; })
&gt; { login: &quot;u1&quot;, name: &quot;user&quot;, .... }

&gt; await db.aget(&quot;users&quot;, { login: &quot;u1&quot; })
&gt; { login: &quot;u1&quot;, name: &quot;user&quot;, .... }
</code></pre>
<h1>API requests handling</h1>
<p>All methods will put input parameters in the <code>req.query</code>, GET or POST.</p>
<p>One way to verify input values is to use <code>api.getQuery</code>, only specified parameters will be returned and converted according to
the type or ignored.</p>
<p>Example:</p>
<pre class="prettyprint source lang-javascript"><code>   var params = {
      test1: { id: { type: &quot;text&quot; },
               count: { type: &quot;int&quot; },
               email: { regexp: /^[^@]+@[^@]+$/ }
      }
   };

   api.app.all(&quot;/endpoint/test1&quot;, function(req, res) {
      const query = api.getQuery(req, params.test1);
      if (typeof query == &quot;string&quot;) return api.sendReply(res, 400, query);
      ...
   });
</code></pre>
<h1>Example of TODO application</h1>
<p>Here is an example how to create simple TODO application using any database supported by the backend. It supports basic
operations like add/update/delete a record, show all records.</p>
<p>Create a file named <code>app.js</code> with the code below.</p>
<pre class="prettyprint source lang-javascript"><code>    const { api, lib, app, db, server } = require('backendjs');

    // Describe the table to store todo records
    db.describeTables({
       todo: {
           id: { type: &quot;uuid&quot;, primary: 1 },  // Store unique task id
           due: { type: &quot;mtime&quot; },            // Due date
           name: { strip: lib.rxXss },        // Short task name
           descr: { strip: lib.rxXss },       // Full description
           mtime: { type: &quot;now&quot; }             // Last update time in ms
       }
    });

    // API routes
    app.configureWeb = function(options, callback)
    {
        api.app.get(/^\/todo\/([a-z]+)$/, async (req, res) => {
           var options = api.getOptions(req), query;

           switch (req.params[0]) {
             case &quot;get&quot;:
                if (!req.query.id) return api.sendReply(res, 400, &quot;id is required&quot;);
                const row = await db.aget(&quot;todo&quot;, { id: req.query.id }, options);
                api.sendJSON(req, null, row);
                break;

             case &quot;select&quot;:
                // Get input, use defaults to check size limits (see api.queryDefault)
                query = api.getQuery(req, {
                    id: {},
                    name: {},
                    due: {},
                });
                // Query condition by column
                options.ops = {
                    id: &quot;in&quot;,
                    name: &quot;contains&quot;,
                    due: &quot;gt&quot;,
                }
                // Allow empty scan of the whole table if no query is given, disabled by default
                options.noscan = 0;

                const rows = await db.aselect(&quot;todo&quot;, query, options);
                api.sendJSON(req, null, rows);
                break;

            case &quot;add&quot;:
                // By default due date is tomorrow
                query = api.getQuery(req, {
                    name: { required: 1 },
                    due: { type: &quot;mtime&quot;, dflt: Date.now() + 86400000 },
                    descr: {}
                });
                if (typeof query == &quot;string&quot;) return api.sendReply(res, 400, query);

                db.add(&quot;todo&quot;, query, options, (err, rows) => {
                    api.sendJSON(req, err, rows);
                });
                break;

            case &quot;update&quot;:
                query = api.getQuery(req, {
                    id: { required: 1 },
                    due: { type: &quot;mtime&quot; },
                    name: {},
                    descr: {}
                });
                if (typeof query == &quot;string&quot;) return api.sendReply(res, 400, query);

                const rows = await db.aupdate(&quot;todo&quot;, query, options);
                api.sendJSON(req, null, rows);
                break;

            case &quot;del&quot;:
                if (!req.query.id) return api.sendReply(res, 400, &quot;id is required&quot;);
                db.del(&quot;todo&quot;, { id: req.query.id }, options, (err, rows) => {
                    api.sendJSON(req, err, rows);
                });
                break;
            }
        });

        callback();
     }

     server.start();
</code></pre>
<p>Now run it with an option to allow API access without a user:</p>
<pre><code>node app.js -log debug -api -api-allow-path /todo -db-create-tables
</code></pre>
<p>To use a different database, for example PostgresSQL(running localy) or DynamoDB(assuming EC2 instance),
all config parametetrs can be stored in the etc/config as well</p>
<pre><code>node app.js -log debug -api -api-allow-path /todo -db-pool dynamodb -db-dynamodb-pool default -db-create-tables
node app.js -log debug -api -api-allow-path /todo -db-pool pg -db-pg-pool default -db-create-tables
</code></pre>
<p>API commands can be executed in the browser or using <code>curl</code>:</p>
<pre><code>curl 'http://localhost:8000/todo?name=TestTask1&amp;descr=Descr1&amp;due=2015-01-01`
curl 'http://localhost:8000/todo/select'
</code></pre>
<h1>Backend directory structure</h1>
<p>When the backend server starts and no -home argument passed in the command line the backend uses the current directory.
It is also possible to set the default home using BKJS_HOME environment variable.</p>
<p>The backend directory structure is the following:</p>
<ul>
<li>
<p><code>etc</code> - configuration directory, all config files are there</p>
<ul>
<li>
<p><code>etc/bkjs.local</code> - shell script loaded by the bkjs utility to customize env variables</p>
</li>
<li>
<p><code>etc/config</code> - config parameters, same as specified in the command line but without leading -, each config parameter per line:</p>
<p>Example:</p>
<pre><code>  debug=1
  db-pool=dynamodb
  db-dynamodb-pool=http://localhost:9000
  db-pg-pool=postgresql://postgres@127.0.0.1/backend

  To specify other config file: bkjs shell -config-file file
</code></pre>
</li>
<li>
<p><code>etc/config.local</code> - same as the config but for the cases when local environment is different than the production or for dev specific parameters</p>
</li>
<li>
<p>on startup the following local config files will be loaded if present: <code>etc/config.runMode</code> and <code>etc/config.instance.tag</code>. These will be loaded after the main config but before config.local. The runMode is set to <code>dev</code> by default and can be changed with <code>-run-mode</code> config parameter, the instance tag is set with <code>-instance-tag</code> config parameter.</p>
</li>
<li>
<p>config files support sections that can be used for conditions, see <code>lib.configParse</code> description for details</p>
</li>
<li>
<p><code>etc/crontab</code> - jobs to be run with intervals, JSON file with a list of cron jobs objects:</p>
<p>Example:</p>
<ol>
<li>
<p>Create file in ~/.backend/etc/crontab with the following contents:</p>
<pre><code> [ { &quot;cron&quot;: &quot;0 1 1 * * 1,3&quot;, &quot;job&quot;: { &quot;app.cleanSessions&quot;: { &quot;interval&quot;: 3600000 } } } ]
</code></pre>
</li>
<li>
<p>Define the function that the cron will call with the options specified, callback must be called at the end, create this app.js file</p>
<pre><code> const { app, db } = require(&quot;backendjs&quot;);
 app.cleanSessions = function(options, callback) {
      db.delAll(&quot;session&quot;, { mtime: options.interval + Date.now() }, { ops: &quot;le&quot; }, callback);
 }
 server.start()
</code></pre>
</li>
<li>
<p>Start the jobs queue and the web server at once</p>
<pre><code> node app.js -master -jobs-workers 1 -jobs-cron
</code></pre>
</li>
</ol>
</li>
<li>
<p>etc/crontab.local - additional local crontab that is read after the main one, for local or dev environment</p>
</li>
</ul>
</li>
<li>
<p><code>modules</code> - loadable modules with specific functionality</p>
</li>
<li>
<p><code>var</code> - database files created by the server</p>
</li>
<li>
<p><code>tmp</code> - temporary files</p>
</li>
<li>
<p><code>web</code> - Web pages served by the static Express middleware</p>
</li>
</ul>
<h1>Environment variables</h1>
<p>On startup some env variable will be used for initial configuration:</p>
<ul>
<li>BKJS_HOME - home directory where to cd and find files, <code>-home</code> config parameter overrides it</li>
<li>BKJS_RUNMODE - initial run mode, <code>-run-mode</code> overrides it</li>
<li>BKJS_CONFIG - config file to use instead of 'etc/config', <code>-config</code> overrides it</li>
<li>BKJS_PACKAGES - packags to use, <code>-import-packages</code> overrieds it</li>
<li>BKJS_DB_POOL - default db pool, <code>-db-pool</code> overrides it</li>
<li>BKJS_DB_CONFIG - config db pool, <code>-db-config</code> overrides it</li>
<li>BKJS_ROLES - additonal roles to use for config, <code>-roles</code> overrides it</li>
<li>BKJS_APP_NAME - default app name</li>
<li>BKJS_APP_PACKAGE - default app package from preloaded packages</li>
<li>BKJS_TAG - initial instance tag, <code>-instance-tag</code> overrides it, it may be also overridden by AWS instance tag</li>
<li>BKJS_LOG_OPTIONS - logger options, <code>-log-options</code> overrides it</li>
<li>BKJS_PORT - port for web server</li>
<li>BKJS_WSPORT - port for web sockets</li>
</ul>
<h1>Cache configurations</h1>
<p>Database layer support caching of the responses using <code>db.getCached</code> call, it retrieves exactly one record from the configured cache, if no record exists it
will pull it from the database and on success will store it in the cache before returning to the client. When dealing with cached records, there is a special option
that must be passed to all put/update/del database methods in order to clear local cache, so next time the record will be retrieved with new changes from the database
and refresh the cache, that is <code>{ cached: true }</code> can be passed in the options parameter for the db methods that may modify records with cached contents. In any case
it is required to clear cache manually there is <code>db.clearCache</code> method for that.</p>
<p>Also there is a configuration option <code>-db-caching</code> to make any table automatically cached for all requests.</p>
<h2>Local</h2>
<p>If no cache is configured the local driver is used, it keeps the cache on the master process in the LRU pool and any worker or Web process
communicate with it via internal messaging provided by the <code>cluster</code> module. This works only for a single server.</p>
<h2>Redis</h2>
<p>Set <code>cache-NAME=redis://HOST[:PORT]</code> that points to the server running Redis server.</p>
<p>The config option <code>max_attempts</code> defines maximum number of times to reconnect before giving up. Any other <code>node-redis</code> module parameter can be passed as well in
the options or url, the system supports special parameters that start with <code>bk-</code>, it will extract them into options automatically.</p>
<p>For example:</p>
<pre><code>cache-default=redis://host1?bk-max_attempts=3
cache-backup=redis://host2
cache-backup-options-max_attempts=3
</code></pre>
<h1>PUB/SUB or Queue configurations</h1>
<h2>Redis system bus</h2>
<p>If configured all processes subscribe to it and listen for system messages, it must support PUB/SUB and does not need to be reliable. Websockets
in the API server also use the system bus to send broadcasts between multiple api instances.</p>
<pre><code>queue-system=redis://
ipc-system-queue=system
</code></pre>
<h2>Redis Queue</h2>
<p>To configure the backend to use Redis for job processing set <code>cache-redis=redis://HOST</code> where HOST is IP address or hostname of the single Redis server.
This driver implements reliable Redis queue, with <code>visibilityTimeout</code> config option works similar to AWS SQS.</p>
<p>Once configured, then all calls to <code>jobs.submitJob</code> will push jobs to be executed to the Redis queue, starting somewhere a backend master
process with <code>-jobs-workers 2</code> will launch 2 worker processes which will start pulling jobs from the queue and execute.</p>
<p>The naming convention is that any function defined as <code>function(options, callback)</code> can be used as a job to be executed in one of the worker processes.</p>
<p>An example of how to perform jobs in the API routes:</p>
<pre class="prettyprint source lang-javascript"><code>
    app.describeArgs('app', [
        { name: &quot;queue&quot;, descr: &quot;Queue for jobs&quot; },
    ]);
    app.queue = &quot;somequeue&quot;;

    app.processUsers = function(options, callback) {
        db.select(&quot;bk_user&quot;, { type: options.type || &quot;user&quot; }, (err, rows) => {
          ...
          callback();
        });
    }

    api.all(&quot;/process/users&quot;, (req, res) => {
        jobs.submitJob({ job: { &quot;app.processUsers&quot;: { type: req.query.type } } }, { queueName: app.queue }, (err) => {
            api.sendReply(res, err);
        });
    });

</code></pre>
<h2>SQS</h2>
<p>To use AWS SQS for job processing set <code>cache-default=https://sqs.amazonaws.com....</code>, this queue system will poll SQS for new messages on a worker
and after successful execution will delete the message. For long running jobs it will automatically extend visibility timeout if it is configured.</p>
<h2>Local</h2>
<p>The local queue run in the process.</p>
<h2>NATS</h2>
<p>To use NATS (https://nats.io) configure a queue like cache-nats=nats://HOST:PORT, it supports broadcasts and job queues only, visibility timeout is
supported as well.</p>
<h2>RabbitMQ</h2>
<p>To configure the backend to use RabbitMQ for messaging set <code>cache-rabbit=amqp://HOST</code> and optionally <code>cache-rabbit-options=JSON</code> with options to the amqp module.
Additional objects from the config JSON are used for specific AMQP functions: { queueParams: {}, subscribeParams: {}, publishParams: {} }. These
will be passed to the corresponding AMQP methods: <code>amqp.queue, amqp.queue.subcribe, amqp.publish</code>. See AMQP Node.js module for more info.</p>
<h1>Security configurations</h1>
<h2>API only</h2>
<p>This is default setup of the backend when all API requests except must provide valid signature and all HTML, JavaScript, CSS and image files
are available to everyone. This mode assumes that Web development will be based on 'single-page' design when only data is requested from the Web server and all rendering is done using JavaScript.</p>
<p>To see current default config parameters run any of the following commands:</p>
<pre><code>    bkjs sh -help
</code></pre>
<h2>Secure Web site, client verification</h2>
<p>This is a mode when the whole Web site is secure by default, even access to the HTML files must be authenticated.</p>
<p>The typical client JavaScript verification for the html page may look like this, it will redirect to login page if needed,
this assumes the default path '/public' still allowed without the signature:</p>
<pre class="prettyprint source lang-javascript"><code>   &lt;link href=&quot;/css/bkjs.bundle.css&quot; rel=&quot;stylesheet&quot;>
   &lt;script src=&quot;/js/bkjs.bundle.js&quot; type=&quot;text/javascript&quot;>&lt;/script>
   &lt;script>
    $(function () {
       app.on(&quot;nologin&quot;, () => { window.location='/public/index.html'; });
       app.login();
   });
   &lt;/script>
</code></pre>
<h2>Secure Web site, backend verification</h2>
<p>On the backend side in your application app.js it needs more secure settings defined i.e. no html except /public will be accessible and
in case of error will be redirected to the login page by the server.</p>
<ol>
<li>We disable all allowed paths to the html and registration:</li>
</ol>
<pre class="prettyprint source lang-javascript"><code>   app.configureMiddleware = function(options, callback) {
       this.allowPath.splice(this.allow.indexOf('^/$'), 1);
       this.allowPath.splice(this.allow.indexOf('\\.html$'), 1);
       callback();
   }
</code></pre>
<ol start="2">
<li>We define an auth callback in the app and redirect to login if the request has no valid signature, we check all html pages, all allowed html pages from the /public
will never end up in this callback because it is called after the signature check but allowed pages are served before that:</li>
</ol>
<pre class="prettyprint source lang-javascript"><code>   api.registerPreProcess('', /^\/$|\.html$/, (req, status, callback) => {
       if (status.status != 200) {
           status.status = 302;
           status.url = '/public/index.html';
       }
       callback(status);
   });
</code></pre>
<h1>WebSockets connections</h1>
<p>The simplest way is to configure <code>api-ws-port</code> to the same value as the HTTP port. This will run WebSockets server along the regular Web server.</p>
<p>In the browser the connection config is stored in the <code>app.wsconf</code> and by default it connects to the local server on port 8000.</p>
<p>There are two ways to send messages via Websockets to the server from a browser:</p>
<ul>
<li>
<p>as urls, eg. <code>app.wsSend('/project/update?id=1&amp;name=Test2')</code></p>
<p>In this case the url will be parsed and checked for access and authorization before letting it pass via Express routes. This method allows to
share the same route handlers between HTTP and Websockets requests, the handlers will use the same code and all responses will be sent back,
only in the Websockets case the response will arrived in the message listener (see an example below)</p>
</li>
</ul>
<pre class="prettyprint source lang-javascript"><code>    app.wsConnect({ path: &quot;/ws?id=1&quot; });

    app.on(&quot;ws:message&quot;, (msg) => {
        switch (msg.op) {
        case &quot;/users/update&quot;:
            app.wsSend(&quot;/ws/user&quot;);
            break;

        case &quot;/project/update&quot;:
            for (const p in msg.project) app.project[p] = msg.project[p];
            break;

        case &quot;/message/new&quot;:
            app.showAlert(&quot;info&quot;, `New message: ${msg.msg}`);
            break;
        }
    });
</code></pre>
<ul>
<li>
<p>as JSON objects, eg. <code>app.wsSend({ op: &quot;/project/update&quot;, project: { id: 1, name: &quot;Test2&quot; } })</code></p>
<p>In this case the server still have to check for access so it treats all JSON messages as coming from the path which was used during the connect,
i.e. the one stored in the <code>app.wsconf.path</code>. The Express route handler for this path will receive all messages from Websocket clients, the response will be
received in the event listener the same way as for the first use case.</p>
</li>
</ul>
<pre class="prettyprint source lang-javascript"><code>    // Notify all clients who is using the project being updated
    api.app.all(&quot;/project/ws&quot;, (req, res) => {
        switch (req.query.op) {
        case &quot;/project/update&quot;:
           //  some code ....
           api.ws.notify({ query: { id: req.query.project.id } }, { op: &quot;/project/update&quot;, project: req.query.project });
           break;
       }
       res.send(&quot;&quot;);
    });
</code></pre>
<p>In any case all Websocket messages sent from the server will arrive in the event handler and must be formatted properly in order to distinguish what is what, this is
the application logic. If the server needs to send a message to all or some specific clients for example due to some updates in the DB, it must use the
<code>ws.notify</code> function.</p>
<pre class="prettyprint source lang-javascript"><code>    // Received a new message for a user from external API service, notify all websocket clients by user id
    api.app.post(&quot;/api/message&quot;, (req, res) => {
        ....
        ... processing logic
        ....
        api.ws.notify({ user_id: req.query.uid }, { op: &quot;/message/new&quot;, msg: req.query.msg });
    });
</code></pre>
<h1>The backend tool: bkjs</h1>
<p>The purpose of the <code>bkjs</code> shell script is to act as a helper tool in configuring and managing the backend environment
and as well to be used in operations on production systems. It is not required for the backend operations and provided as a convenience tool
which is used in the backend development and can be useful for others running or testing the backend.</p>
<p>Run <code>bkjs help</code> to see description of all available commands.</p>
<p>The tool is multi-command utility where the first argument is the command to be executed with optional additional arguments if needed.</p>
<p>On Linux, when started the bkjs tries to load and source the following global config files:</p>
<pre><code>    /etc/conf.d/bkjs
    /etc/sysconfig/bkjs
</code></pre>
<p>Then it try to source all local config files:</p>
<pre><code>    $BKJS_ENV/../etc/profile
    $BKJS_HOME/etc/profile
    $BKJS_ENV/../etc/profile.local
    $BKJS_HOME/etc/profile.local
</code></pre>
<p>Any of the following config files can redefine any environment variable thus pointing to the correct backend environment directory or
customize the running environment, these should be regular shell scripts using bash syntax.</p>
<p>To check all env variables inside bkjs just run the command <code>bkjs env</code></p>
<p>The tool provides some simple functions to parse comamndline arguments,
the convention is that argument name must start with a single dash followed by a value.</p>
<ul>
<li>
<p><code>get_arg(name, dflt)</code> - returns the value for the arg <code>name</code> or default value if specified</p>
</li>
<li>
<p><code>get_flag(name, dflt)</code> - returns 1 if there is a command lione arg with the <code>name</code> or default value
Example:</p>
<pre><code>bkjs shell -log debug
</code></pre>
</li>
<li>
<p><code>concat_arg(name, value)</code> - returns concatenated value from the arg and provided value, to combine values from multiple sources
Example:</p>
<pre><code>ssh=$(concat_arg -ssh $BKJS_SSH_ARGS)
</code></pre>
</li>
<li>
<p><code>get_json(file, name, dflt, realpath)</code> - returns a value from the json file, <code>name</code> can be path deep into object, <code>realpath</code> flag if nonempty will treat all values as paths and convert each into actual real path (this is used by the internal web bundler)</p>
</li>
<li>
<p><code>get_json_flat</code> - similar to get_json but property names are flattened for deep access
Example:</p>
<pre><code>$(get_json package.json config.sync.path)
$(get_json package.json name)
</code></pre>
</li>
<li>
<p><code>get_all_args(except)</code> - returns all args not present in the <code>except</code> list, this is to pass all arguments to other script, for command development
Example:</p>
<pre><code>The script is called: `bkjs cmd1 -skip 1 -filter 2 -log 3`

Your command handler process -skip but must pass all other args to another except -skip

cmd1)
  skip=$(get_arg -skip)
  ...
  other_script $(get_all_args &quot;-skip&quot;)
  ;;
</code></pre>
</li>
</ul>
<h2>Extending bkjs tool</h2>
<p>The utility is extended via external scripts that reside in the <code>tools/</code> folders.</p>
<p>When bkjs is running it treats the first arg as a command:</p>
<ul>
<li><code>$BKJS_CMD</code> set to the whole comamnd</li>
</ul>
<p>if no internal commands match it starts loading external scripts that match with <code>bkjs-PART1-*</code> where
PART1 is the first part of the command before first dash.</p>
<p>For example, when called:</p>
<pre><code>bkjs ec2-check-hostname
</code></pre>
<p>it will check the command in main bkjs cript, not found it will search for all files that
match <code>bkjs-ec2-*</code> in all known folders.</p>
<p>The file are loaded from following directories in this particular order:</p>
<ul>
<li>in the filder specified by the <code>-tools</code> command line argument</li>
<li>$(pwd)/tools</li>
<li><code>$BKJS_TOOLS</code>,</li>
<li><code>BKJS_ENV/../tools</code></li>
<li><code>$BKJS_HOME/tools</code></li>
<li><code>$BKJS_DIR/tools</code></li>
</ul>
<p><code>BKJS_DIR</code> always points to the backendjs installation directory.</p>
<p><code>BLKJS_TOOLS</code> env variable may contain a list of directories separated by <code>spaces</code>, this variable or command line arg <code>-tools</code> is the way to add
custom commands to bkjs. <code>BKJS_TOOLS</code> var is usually set in one of the profile config files mentioned above.</p>
<p>Example of a typical bkjs command:</p>
<p>We need to set BKJS_TOOLS to point to our package(s), on Darwin add it to ~/.bkjs/etc/profile as</p>
<pre><code>BKJS_TOOLS=&quot;$HOME/src/node-pkg/tools&quot;
</code></pre>
<p>Create a file <code>$HOME/tools/bkjs-super</code></p>
<pre><code>#!/bin/sh

case &quot;$BKJS_CMD&quot; in
  super)
   arg1=$(get_arg -arg1)
   arg2=$(get_arg -arg1 1)
   [ -z $arg1 ] &amp;&amp; echo &quot;-arg1 is required&quot; &amp;&amp; exit 1
   ...
   exit

  super-all)
   ...
   exit
   ;;

  help)
   echo &quot;&quot;
   echo &quot;$0 super -arg1 ARG -arg2 ARG ...&quot;
   echo &quot;$0 super-all ....&quot;
   ;;
esac
</code></pre>
<p>Now calling <code>bkjs super</code> or <code>bkjs super-all</code> will use the new <code>$HOME/tools/bkjs-super</code> file.</p>
<h1>Web development notes</h1>
<p>Then run the dev build script to produce web/js/bkjs.bundle.js and web/css/bkjs.bundle.css</p>
<pre><code>cd node_modules/backendjs &amp;&amp; npm run devbuild
</code></pre>
<p>Now instead of including a bunch of .js or css files in the html pages it only needs /js/bkjs.bundle.js and /css/bkjs.bundle.css.</p>
<p>The bundle configuration is in the package.json file.</p>
<p>The list of files to be used in bundles is in the package.json under <code>config.bundles</code>.</p>
<p>To enable auto bundler in your project just add to the local config <code>~/.bkjs/etc/config.local</code> a list of directories to be
watched for changes. For example adding these lines to the local config will enable the watcher and bundle support</p>
<pre><code>watcher-web=web/js,web/css,$HOME/src/js,$HOME/src/css
</code></pre>
<p>The simple script below allows to build the bundle and refresh Chrome tab automatically, saves several clicks:</p>
<pre><code>#!/bin/sh
bkjs bundle -dev -file $2
[ &quot;$?&quot; != &quot;0&quot; ] &amp;&amp; exit
osascript -e &quot;tell application \&quot;Google Chrome\&quot; to reload (tabs of window 1 whose URL contains \&quot;$1\&quot;)&quot;
</code></pre>
<p>To use it, call this script instead in the config.local:</p>
<pre><code>watcher-build=bundle.sh /website
</code></pre>
<p>NOTE: Because the rebuild happens while the watcher is running there are cases like the server is restarting or pulling a large update from the
repository when the bundle build may not be called or called too early. To force rebuild run the command:</p>
<pre><code>bkjs bundle -dev -all -force
</code></pre>
<h1>Deployment use cases</h1>
<h2>AWS instance setup with node and backendjs</h2>
<ul>
<li>
<p>start new AWS instance via AWS console, use Alpine 3.22 or later</p>
</li>
<li>
<p>login as <code>alpine</code></p>
</li>
<li>
<p>install commands</p>
<pre><code>  doas apk add git
  git clone --depth=1 https://github.com/vseryakov/backendjs.git
  doas backendjs/bkjs setup-ec2
  doas reboot
</code></pre>
</li>
<li>
<p>now login as <code>ec2-user</code></p>
</li>
</ul>
<p>NOTE: if running behind a Load balancer and actual IP address is needed set Express option in the command line <code>-api-express-options {&quot;trust%20proxy&quot;:1}</code>. In the config file
replacing spaces with %20 is not required.</p>
<h2>AWS Provisioning examples</h2>
<h3>Make an AMI</h3>
<p>On the running machine which will be used for an image:</p>
<pre><code>bksh -aws-create-image -no-reboot
</code></pre>
<p>Use an instance by tag for an image:</p>
<pre><code>bksh -aws-create-image -no-reboot -instance-id `bkjs ec2-show -tag api -fmt id | head -1`
</code></pre>
<h3>Update Route53 with all IPs from running instances</h3>
<pre><code>bksh -aws-set-route53 -name elasticsearch.ec-internal -filter elasticsearch
</code></pre>
<h2>Configure HTTP port</h2>
<p>The first thing when deploying the backend into production is to change API HTTP port, by default is is 8000, but we would want port 80 so regardless
how the environment is setup it is ultimately 2 ways to specify the port for HTTP server to use:</p>
<ul>
<li>
<p>config file</p>
<p>The config file is always located in the etc/ folder in the backend home directory, how the home is specified depends on the system but basically it can be
defined via command line arguments as <code>-home</code> or via environment variables when using bkjs. See bkjs documentation but on AWS instances created with bkjs
<code>setup-server</code> command, for non-standard home use <code>/etc/sysconfig/bkjs</code> profile, specify <code>BKJS_HOME=/home/backend</code> there and the rest will be taken care of</p>
</li>
<li>
<p>command line arguments</p>
<p>When running node scripts which use the backend, just specify <code>-home</code> command line argument with the directory where your backend should be and the backend will use it</p>
<p>Example:</p>
<pre><code>  node app.js -home $HOME -port 80
</code></pre>
</li>
<li>
<p>config database</p>
<p>If <code>-db-config</code> is specified in the command line or <code>db-config=</code> in the local config file, this will trigger loading additional
config parameters from the specified database pool, it will load all records from the <code>bk_config</code> table on that db pool. Using the database to store
configuration make it easier to maintain dynamic environment for example in case of auto scaling or launching on demand, this way
a new instance will query current config from the database and this eliminates supporting text files and distributing them to all instances.</p>
<p>The config database is refreshed from time to time according to the <code>db-config-map=interval:N</code> parameter. See <code>db/config.js</code> for more details.</p>
</li>
</ul>
<h1>Backend library development (Mac OS X, developers)</h1>
<ul>
<li>
<p><code>git clone https://github.com/vseryakov/backendjs.git</code> or <code>git clone git@github.com:vseryakov/backendjs.git</code></p>
</li>
<li>
<p>cd backendjs</p>
</li>
<li>
<p>if Node.js is already installed skip to the next section</p>
<ul>
<li>
<p>to install binary release run the command, it will install it into ~.bkjs/bin on Darwin</p>
<pre class="prettyprint source"><code>bkjs install-node

# To install into different path
bkjs install-node -home ~/.local
</code></pre>
</li>
</ul>
</li>
<li>
<p>to run local server on port 8000 run command:</p>
<p><code>./bkjs watch</code></p>
</li>
<li>
<p>to start the backend in command line mode, the backend environment is prepared and initialized including all database pools.
This command line access allows you to test and run all functions from all modules of the backend without running full server
similar to Node.js REPL functionality. All modules are accessible from the command line.</p>
<pre class="prettyprint source"><code>$ ./bkjs shell
> app.version
'0.70.0'
> logger.setLevel('info')
</code></pre>
</li>
</ul>
<h2>Authentication and sessions</h2>
<h3>Signature</h3>
<p>All requests to the API server must be signed with user login/secret pair.</p>
<ul>
<li>The algorithm how to sign HTTP requests (Version 1, 2):
<ul>
<li>Split url to path and query parameters with &quot;?&quot;</li>
<li>Split query parameters with &quot;&amp;&quot;</li>
<li>'''ignore parameters with empty names'''</li>
<li>'''Sort''' list of parameters alphabetically</li>
<li>Join sorted list of parameters with &quot;&amp;&quot;
<ul>
<li>Make sure all + are encoded as %2B</li>
</ul>
</li>
<li>Form canonical string to be signed as the following:
<ul>
<li>Line1: The signature version</li>
<li>Line2: The application tag or other opaque data</li>
<li>Line3: The login name</li>
<li>Line4: The HTTP method(GET), followed by a newline.</li>
<li>Line5: The host name, lowercase, followed by a newline.</li>
<li>Line6: The request URI (/), followed by a newline.</li>
<li>Line7: The sorted and joined query parameters as one string, followed by a newline.</li>
<li>Line8: The expiration value in milliseconds, required, followed by a newline</li>
<li>Line9: The Content-Type HTTP header, lowercase, optional, followed by a newline</li>
<li>Line10: The SHA1 checksum of the body content, optional, for JSON and other forms of requests not supported by query parameters</li>
</ul>
</li>
<li>Computed HMAC-SHA1 digest from the canonical string and encode it as BASE64 string, preserve trailing = if any</li>
<li>Form the signature HTTP header as the following:
<ul>
<li>The header string consist of multiple fields separated by pipe |
<ul>
<li>Field1: Signature version:
<ul>
<li>version 1, obsolete, do not use first 3 lines in the canonical string</li>
<li>version 2,3 to be used in session cookies only</li>
<li>version 4</li>
</ul>
</li>
<li>Field2: Application tag or other app specific data</li>
<li>Field3: user login or whatever it might be in the login column</li>
<li>Field4: HMAC-SHA digest from the canonical string, version 1 uses SHA1, other SHA256</li>
<li>Field5: expiration value in milliseconds, same as in the canonical string</li>
<li>Field6: SHA1 checksum of the body content, optional, for JSON and other forms of requests not supported by query parameters</li>
<li>Field7: empty, reserved for future use</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>The resulting signature is sent as HTTP header <code>bk-signature</code> or in the header specified by the <code>api-signature-name</code> config parameter.</p>
<p>For JSON content type, the method must be POST and no query parameters specified, instead everything should be inside the JSON object
which is placed in the body of the request. For additional safety, SHA1 checksum of the JSON payload can be calculated and passed in the signature,
this is the only way to ensure the body is not modified when not using query parameters.</p>
<p>See <a href="https://github.com/vseryakov/backendjs/blob/master/api/auth.js">api.js</a> function <code>api.createSignature</code> for the JavaScript implementation.</p>
<h3>Authentication API</h3>
<ul>
<li>
<p><code>/auth</code></p>
<p>This API request returns the current user record from the <code>bk_user</code> table if the request is verified and the signature provided
is valid. If no signature or it is invalid the result will be an error with the corresponding error code and message.</p>
<p>By default this endpoint is secured, i.e. requires a valid signature.</p>
<p>On successful login, the result contains full user record</p>
</li>
<li>
<p><code>/login</code></p>
<p>Same as the /auth but it uses secret for user authentication, this request does not need a signature, just simple
login and secret query parameters to be sent to the backend. This must be sent over SSL.</p>
<p>Parameters:</p>
<ul>
<li><code>login</code> - user login</li>
<li><code>secret</code> - user secret</li>
</ul>
<p>On successful login, the result contains full user record</p>
<p>Example:</p>
</li>
</ul>
<pre class="prettyprint source lang-javascript"><code>    var res = await fetch(&quot;/login&quot;, { metod: &quot;POST&quot;, body: &quot;login=test123&secret=test123&quot; });
    await res.json()

    > { id: &quot;XXXX...&quot;, name: &quot;Test User&quot;, login: &quot;test123&quot;, ...}
</code></pre>
<ul>
<li>
<p><code>/logout</code></p>
<p>Logout the current user, clear session cookies if exist. For pure API access with the signature this will not do anything on the backend side.</p>
</li>
</ul>
<h3>Health enquiry</h3>
<p>When running with AWS load balancer there should be a url that a load balancer polls all the time and this must be very quick and lightweight request. For this
purpose there is an API endpoint <code>/ping</code> that just responds with status 200. It is open by default in the default <code>api-allow-path</code> config parameter.</p>
<h1>Author</h1>
<p>Vlad Seryakov</p>
</article>

</section>

    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>