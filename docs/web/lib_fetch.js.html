

<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>lib/fetch.js - Backendjs Documentation</title>
    
    <meta name="description" content="A Node.js library to create Web backends with minimal dependencies." />
    
    
    

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>

    
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h3>Tutorials</h3><ul><li><a href="tutorial-start.html">Getting Started</a></li><li><a href="tutorial-modules.html">Modules</a></li><li><a href="tutorial-reference.html">Reference</a></li><li><a href="tutorial-bkjs.html">The bkjs tool</a></li><li><a href="tutorial-config.html">Config parameters</a></li></ul><h3>Modules</h3><ul><li><a href="module-api.html">api</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api.html#.checkProxy">checkProxy</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.checkRateLimits">checkRateLimits</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.checkRedirectPlaceholders">checkRedirectPlaceholders</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.cleanupHeaders">cleanupHeaders</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.cleanupResult">cleanupResult</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.createWebServer">createWebServer</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.getResultPage">getResultPage</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.getTokenSecret">getTokenSecret</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.handleBody">handleBody</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.handleCleanup">handleCleanup</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.handleMetrics">handleMetrics</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.handleMultipart">handleMultipart</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.init">init</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.prepareOptions">prepareOptions</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.prepareRequest">prepareRequest</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.registerPreHeaders">registerPreHeaders</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.registerRateLimits">registerRateLimits</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.replacePath">replacePath</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.sendFile">sendFile</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.sendFormatted">sendFormatted</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.sendJSON">sendJSON</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.sendReply">sendReply</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.sendStatus">sendStatus</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.shutdown">shutdown</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.startMetrics">startMetrics</a></li><li data-type='method' style='display: none;'><a href="module-api.html#.toParams">toParams</a></li></ul></li><li><a href="module-api_access.html">api/access</a></li><li><a href="module-api_acl.html">api/acl</a></li><li><a href="module-api_csrf.html">api/csrf</a></li><li><a href="module-api_files.html">api/files</a></li><li><a href="module-api_hooks.html">api/hooks</a></li><li><a href="module-api_images.html">api/images</a></li><li><a href="module-api_passkeys.html">api/passkeys</a></li><li><a href="module-api_redirect.html">api/redirect</a></li><li><a href="module-api_routing.html">api/routing</a></li><li><a href="module-api_session.html">api/session</a></li><li><a href="module-api_signature.html">api/signature</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_signature.html#.create">create</a></li><li data-type='method' style='display: none;'><a href="module-api_signature.html#.fromRequest">fromRequest</a></li><li data-type='method' style='display: none;'><a href="module-api_signature.html#.get">get</a></li><li data-type='method' style='display: none;'><a href="module-api_signature.html#.verify">verify</a></li></ul></li><li><a href="module-api_users.html">api/users</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_users.html#.aadd">aadd</a></li><li data-type='method' style='display: none;'><a href="module-api_users.html#.add">add</a></li><li data-type='method' style='display: none;'><a href="module-api_users.html#.adel">adel</a></li><li data-type='method' style='display: none;'><a href="module-api_users.html#.aget">aget</a></li><li data-type='method' style='display: none;'><a href="module-api_users.html#.aupdate">aupdate</a></li><li data-type='method' style='display: none;'><a href="module-api_users.html#.del">del</a></li><li data-type='method' style='display: none;'><a href="module-api_users.html#.get">get</a></li><li data-type='method' style='display: none;'><a href="module-api_users.html#.update">update</a></li></ul></li><li><a href="module-api_ws.html">api/ws</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_ws.html#.broadcast">broadcast</a></li><li data-type='method' style='display: none;'><a href="module-api_ws.html#.notify">notify</a></li></ul></li><li><a href="module-app.html">app</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-app.html#.addModule">addModule</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.ainit">ainit</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.arunMethods">arunMethods</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.checkConfig">checkConfig</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.createRepl">createRepl</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.describeArgs">describeArgs</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.init">init</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.isOk">isOk</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.killBackend">killBackend</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.loadModules">loadModules</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.loadPackages">loadPackages</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.mime">mime</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.parseArgs">parseArgs</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.parseConfig">parseConfig</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.processArg">processArg</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.processArgs">processArgs</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.processEnvArgs">processEnvArgs</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.processName">processName</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.runMethod">runMethod</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.runMethods">runMethods</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.setHome">setHome</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.setHost">setHost</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.setLogInspect">setLogInspect</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.setRole">setRole</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.sortModules">sortModules</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.start">start</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.startRepl">startRepl</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.stop">stop</a></li><li data-type='method' style='display: none;'><a href="module-app.html#.watchTmp">watchTmp</a></li></ul></li><li><a href="module-aws.html">aws</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.cwGetMetricData">aws.cwGetMetricData</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.cwListMetrics">aws.cwListMetrics</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.cwPutLogEvents">aws.cwPutLogEvents</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.cwPutMetricAlarm">aws.cwPutMetricAlarm</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.cwPutMetricData">aws.cwPutMetricData</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.cwlFilterLogEvents">aws.cwlFilterLogEvents</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.ddbBatchGetItem">aws.ddbBatchGetItem</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.ddbBatchWriteItem">aws.ddbBatchWriteItem</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.ddbDeleteItem">aws.ddbDeleteItem</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.ddbGetItem">aws.ddbGetItem</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.ddbScanTable">aws.ddbScanTable</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.ddbTransactWriteItems">aws.ddbTransactWriteItems</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.queryCW">aws.queryCW</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.queryCWL">aws.queryCWL</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.querySQS">aws.querySQS</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.sqsReceiveMessage">aws.sqsReceiveMessage</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.aws.sqsSendMessage">aws.sqsSendMessage</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.ddbCreateTable">ddbCreateTable</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.ddbDeleteTable">ddbDeleteTable</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.ddbDescribeTable">ddbDescribeTable</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.ddbDescribeTimeToLive">ddbDescribeTimeToLive</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.ddbListTables">ddbListTables</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.ddbPutItem">ddbPutItem</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.ddbQueryTable">ddbQueryTable</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.ddbUpdateItem">ddbUpdateItem</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.ddbUpdateTable">ddbUpdateTable</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.ddbUpdateTimeToLive">ddbUpdateTimeToLive</a></li><li data-type='method' style='display: none;'><a href="module-aws.html#.ddbWaitForTable">ddbWaitForTable</a></li></ul></li><li><a href="module-cache.html">cache</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-cache.html#.aclear">aclear</a></li><li data-type='method' style='display: none;'><a href="module-cache.html#.adel">adel</a></li><li data-type='method' style='display: none;'><a href="module-cache.html#.aget">aget</a></li><li data-type='method' style='display: none;'><a href="module-cache.html#.aincr">aincr</a></li><li data-type='method' style='display: none;'><a href="module-cache.html#.alock">alock</a></li><li data-type='method' style='display: none;'><a href="module-cache.html#.aput">aput</a></li><li data-type='method' style='display: none;'><a href="module-cache.html#.astats">astats</a></li><li data-type='method' style='display: none;'><a href="module-cache.html#.aunlock">aunlock</a></li><li data-type='method' style='display: none;'><a href="module-cache.html#.checkConfig">checkConfig</a></li><li data-type='method' style='display: none;'><a href="module-cache.html#.checkLimiter">checkLimiter</a></li><li data-type='method' style='display: none;'><a href="module-cache.html#.clear">clear</a></li><li data-type='method' style='display: none;'><a href="module-cache.html#.createClient">createClient</a></li><li data-type='method' style='display: none;'><a href="module-cache.html#.del">del</a></li><li data-type='method' style='display: none;'><a href="module-cache.html#.get">get</a></li><li data-type='method' style='display: none;'><a href="module-cache.html#.getClient">getClient</a></li><li data-type='method' style='display: none;'><a href="module-cache.html#.incr">incr</a></li><li data-type='method' style='display: none;'><a href="module-cache.html#.initClients">initClients</a></li><li data-type='method' style='display: none;'><a href="module-cache.html#.limiter">limiter</a></li><li data-type='method' style='display: none;'><a href="module-cache.html#.localLimiter">localLimiter</a></li><li data-type='method' style='display: none;'><a href="module-cache.html#.lock">lock</a></li><li data-type='method' style='display: none;'><a href="module-cache.html#.put">put</a></li><li data-type='method' style='display: none;'><a href="module-cache.html#.shutdown">shutdown</a></li><li data-type='method' style='display: none;'><a href="module-cache.html#.stats">stats</a></li><li data-type='method' style='display: none;'><a href="module-cache.html#.unlock">unlock</a></li></ul></li><li><a href="module-db.html">db</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-db.html#.aadd">aadd</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.abatch">abatch</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.abulk">abulk</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.acopy">acopy</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.acreate">acreate</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.add">add</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.adel">adel</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.adelAll">adelAll</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.adrop">adrop</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.aget">aget</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.aincr">aincr</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.alist">alist</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.applyPoolOptions">applyPoolOptions</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.aput">aput</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.aquery">aquery</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.ascan">ascan</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.asearch">asearch</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.aselect">aselect</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.asql">asql</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.atransaction">atransaction</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.aupdate">aupdate</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.aupdateAll">aupdateAll</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.aupgrade">aupgrade</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.batch">batch</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.bulk">bulk</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.cacheColumns">cacheColumns</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.configTypes">configTypes</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.convertError">convertError</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.convertRows">convertRows</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.copy">copy</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.create">create</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.createTables">createTables</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.del">del</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.delAll">delAll</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.describeTables">describeTables</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.drop">drop</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.get">get</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.getCached">getCached</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.getConfig">getConfig</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.getPool">getPool</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.getPoolTables">getPoolTables</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.getPools">getPools</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.getProcessRows">getProcessRows</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.incr">incr</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.init">init</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.initColumns">initColumns</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.initConfig">initConfig</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.initTables">initTables</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.list">list</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.prepare">prepare</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.prepareColumn">prepareColumn</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.prepareQuery">prepareQuery</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.put">put</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.query">query</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.queryProcessSync">queryProcessSync</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.refreshColumns">refreshColumns</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.runProcessRows">runProcessRows</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.scan">scan</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.search">search</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.select">select</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.setConfig">setConfig</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.setProcessColumns">setProcessColumns</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.setProcessRow">setProcessRow</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.sql">sql</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.transaction">transaction</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.update">update</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.updateAll">updateAll</a></li><li data-type='method' style='display: none;'><a href="module-db.html#.upgrade">upgrade</a></li></ul></li><li><a href="module-events.html">events</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-events.html#.putEvent">putEvent</a></li></ul></li><li><a href="module-ipc.html">ipc</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-ipc.html#.broadcast">broadcast</a></li><li data-type='method' style='display: none;'><a href="module-ipc.html#.emitMsg">emitMsg</a></li><li data-type='method' style='display: none;'><a href="module-ipc.html#.initServer">initServer</a></li><li data-type='method' style='display: none;'><a href="module-ipc.html#.initWorker">initWorker</a></li><li data-type='method' style='display: none;'><a href="module-ipc.html#.newMsg">newMsg</a></li><li data-type='method' style='display: none;'><a href="module-ipc.html#.sendMsg">sendMsg</a></li></ul></li><li><a href="module-jobs.html">jobs</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-jobs.html#.cancelJob">cancelJob</a></li><li data-type='method' style='display: none;'><a href="module-jobs.html#.isCancelled">isCancelled</a></li><li data-type='method' style='display: none;'><a href="module-jobs.html#.loadCronjobs">loadCronjobs</a></li><li data-type='method' style='display: none;'><a href="module-jobs.html#.markCancelled">markCancelled</a></li><li data-type='method' style='display: none;'><a href="module-jobs.html#.scheduleCronjob">scheduleCronjob</a></li><li data-type='method' style='display: none;'><a href="module-jobs.html#.scheduleCronjobs">scheduleCronjobs</a></li><li data-type='method' style='display: none;'><a href="module-jobs.html#.submitJob">submitJob</a></li></ul></li><li><a href="module-lib.html">lib</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-lib.html#.__">__</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.afetch">afetch</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.base64ToJson">base64ToJson</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.call">call</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.clock">clock</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.configParse">configParse</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.daysInMonth">daysInMonth</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.decodeURIComponent">decodeURIComponent</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.deferCallback">deferCallback</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.deferInterval">deferInterval</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.deferShutdown">deferShutdown</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.encodeURIComponent">encodeURIComponent</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.entityToText">entityToText</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.escapeUnicode">escapeUnicode</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.fetch">fetch</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.fromBase32">fromBase32</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.fromBase62">fromBase62</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.fromBase64url">fromBase64url</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.getArg">getArg</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.getArgInt">getArgInt</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.getHashid">getHashid</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.getWorkers">getWorkers</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.hash">hash</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.isArg">isArg</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.isDST">isDST</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.isTimeRange">isTimeRange</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.jsonFormat">jsonFormat</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.jsonFormatPreset">jsonFormatPreset</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.jsonParse">jsonParse</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.jsonToBase64">jsonToBase64</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.killWorkers">killWorkers</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.loadLocale">loadLocale</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.localEpoch">localEpoch</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.log">log</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.murmurHash3">murmurHash3</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.newError">newError</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.notifyWorkers">notifyWorkers</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.now">now</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.objClone">objClone</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.objSize">objSize</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.parseCookies">parseCookies</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.parseTime">parseTime</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.runCallback">runCallback</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.shuffle">shuffle</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.sleep">sleep</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.slug">slug</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.sortByVersion">sortByVersion</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.strftimeMap">strftimeMap</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.stringify">stringify</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.suuid">suuid</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.textToEntity">textToEntity</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.textToXml">textToXml</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.toAge">toAge</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.toBase32">toBase32</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.toBase62">toBase62</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.toBase64url">toBase64url</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.toBool">toBool</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.toCamel">toCamel</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.toClamp">toClamp</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.toDate">toDate</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.toDigits">toDigits</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.toDuration">toDuration</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.toEmail">toEmail</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.toFlags">toFlags</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.toFormat">toFormat</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.toMtime">toMtime</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.toNumber">toNumber</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.toParams">toParams</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.toPrice">toPrice</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.toRFC3339">toRFC3339</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.toRegexp">toRegexp</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.toRegexpMap">toRegexpMap</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.toRegexpObj">toRegexpObj</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.toSize">toSize</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.toString">toString</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.toTemplate">toTemplate</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.toTitle">toTitle</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.toUncamel">toUncamel</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.toUrl">toUrl</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.toValue">toValue</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.toVersion">toVersion</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.traceError">traceError</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.tryCall">tryCall</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.tryCatch">tryCatch</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.tryLater">tryLater</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.tzName">tzName</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.unescape">unescape</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.unicode2Ascii">unicode2Ascii</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.uuid">uuid</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.weekDate">weekDate</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.weekOfYear">weekOfYear</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#.xmlParse">xmlParse</a></li><li data-type='method' style='display: none;'><a href="module-lib.html#~onDeferCallback">onDeferCallback</a></li></ul><ul class='typedefs'><li data-type='typedef' style='display: none;'><a href="module-lib.html#.ParamsOptions">ParamsOptions</a></li></ul></li><li><a href="module-lib_JWT.html">lib/JWT</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-lib_JWT.html#.importPrivateKey">importPrivateKey</a></li><li data-type='method' style='display: none;'><a href="module-lib_JWT.html#.importPublicKey">importPublicKey</a></li><li data-type='method' style='display: none;'><a href="module-lib_JWT.html#.sign">sign</a></li><li data-type='method' style='display: none;'><a href="module-lib_JWT.html#.verify">verify</a></li></ul></li><li><a href="module-logger.html">logger</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-logger.html#.debug">debug</a></li><li data-type='method' style='display: none;'><a href="module-logger.html#.dev">dev</a></li><li data-type='method' style='display: none;'><a href="module-logger.html#.error">error</a></li><li data-type='method' style='display: none;'><a href="module-logger.html#.info">info</a></li><li data-type='method' style='display: none;'><a href="module-logger.html#.log">log</a></li><li data-type='method' style='display: none;'><a href="module-logger.html#.logger">logger</a></li><li data-type='method' style='display: none;'><a href="module-logger.html#.none">none</a></li><li data-type='method' style='display: none;'><a href="module-logger.html#.prefix">prefix</a></li><li data-type='method' style='display: none;'><a href="module-logger.html#.registerLevel">registerLevel</a></li><li data-type='method' style='display: none;'><a href="module-logger.html#.setDebugFilter">setDebugFilter</a></li><li data-type='method' style='display: none;'><a href="module-logger.html#.setFile">setFile</a></li><li data-type='method' style='display: none;'><a href="module-logger.html#.setLevel">setLevel</a></li><li data-type='method' style='display: none;'><a href="module-logger.html#.setOptions">setOptions</a></li><li data-type='method' style='display: none;'><a href="module-logger.html#.setSyslog">setSyslog</a></li><li data-type='method' style='display: none;'><a href="module-logger.html#.trace">trace</a></li><li data-type='method' style='display: none;'><a href="module-logger.html#.warn">warn</a></li></ul></li><li><a href="module-logwatcher.html">logwatcher</a></li><li><a href="module-metrics.html">metrics</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-metrics.html#.incr">incr</a></li><li data-type='method' style='display: none;'><a href="module-metrics.html#.take">take</a></li><li data-type='method' style='display: none;'><a href="module-metrics.html#.toJSON">toJSON</a></li></ul></li><li><a href="module-modules.html">modules</a></li><li><a href="module-push.html">push</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-push.html#.configureModule">configureModule</a></li><li data-type='method' style='display: none;'><a href="module-push.html#.init">init</a></li><li data-type='method' style='display: none;'><a href="module-push.html#.parseDevice">parseDevice</a></li><li data-type='method' style='display: none;'><a href="module-push.html#.send">send</a></li><li data-type='method' style='display: none;'><a href="module-push.html#.shutdown">shutdown</a></li></ul></li><li><a href="module-queue.html">queue</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-queue.html#.apublish">apublish</a></li><li data-type='method' style='display: none;'><a href="module-queue.html#.asubmit">asubmit</a></li><li data-type='method' style='display: none;'><a href="module-queue.html#.checkConfig">checkConfig</a></li><li data-type='method' style='display: none;'><a href="module-queue.html#.createClient">createClient</a></li><li data-type='method' style='display: none;'><a href="module-queue.html#.drop">drop</a></li><li data-type='method' style='display: none;'><a href="module-queue.html#.getClient">getClient</a></li><li data-type='method' style='display: none;'><a href="module-queue.html#.initClients">initClients</a></li><li data-type='method' style='display: none;'><a href="module-queue.html#.listen">listen</a></li><li data-type='method' style='display: none;'><a href="module-queue.html#.monitor">monitor</a></li><li data-type='method' style='display: none;'><a href="module-queue.html#.publish">publish</a></li><li data-type='method' style='display: none;'><a href="module-queue.html#.shutdown">shutdown</a></li><li data-type='method' style='display: none;'><a href="module-queue.html#.stats">stats</a></li><li data-type='method' style='display: none;'><a href="module-queue.html#.submit">submit</a></li><li data-type='method' style='display: none;'><a href="module-queue.html#.subscribe">subscribe</a></li><li data-type='method' style='display: none;'><a href="module-queue.html#.unlisten">unlisten</a></li><li data-type='method' style='display: none;'><a href="module-queue.html#.unsubscribe">unsubscribe</a></li></ul></li><li><a href="module-sendmail.html">sendmail</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-sendmail.html#.send">send</a></li></ul></li><li><a href="module-shell.html">shell</a></li><li><a href="module-sql.html">sql</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-sql.html#.column">column</a></li><li data-type='method' style='display: none;'><a href="module-sql.html#.create">create</a></li><li data-type='method' style='display: none;'><a href="module-sql.html#.delete">delete</a></li><li data-type='method' style='display: none;'><a href="module-sql.html#.drop">drop</a></li><li data-type='method' style='display: none;'><a href="module-sql.html#.expr">expr</a></li><li data-type='method' style='display: none;'><a href="module-sql.html#.get">get</a></li><li data-type='method' style='display: none;'><a href="module-sql.html#.insert">insert</a></li><li data-type='method' style='display: none;'><a href="module-sql.html#.limit">limit</a></li><li data-type='method' style='display: none;'><a href="module-sql.html#.quote">quote</a></li><li data-type='method' style='display: none;'><a href="module-sql.html#.select">select</a></li><li data-type='method' style='display: none;'><a href="module-sql.html#.time">time</a></li><li data-type='method' style='display: none;'><a href="module-sql.html#.update">update</a></li><li data-type='method' style='display: none;'><a href="module-sql.html#.updateExpr">updateExpr</a></li><li data-type='method' style='display: none;'><a href="module-sql.html#.upgrade">upgrade</a></li><li data-type='method' style='display: none;'><a href="module-sql.html#.value">value</a></li><li data-type='method' style='display: none;'><a href="module-sql.html#.valueIn">valueIn</a></li><li data-type='method' style='display: none;'><a href="module-sql.html#.where">where</a></li><li data-type='method' style='display: none;'><a href="module-sql.html#.where">where</a></li></ul></li><li><a href="module-stats.html">stats</a></li><li><a href="module-watcher.html">watcher</a></li></ul><h3>Classes</h3><ul><li><a href="Counter.html">Counter</a></li><li><a href="DbPool.html">DbPool</a><ul class='methods'><li data-type='method' style='display: none;'><a href="DbPool.html#aquery">aquery</a></li><li data-type='method' style='display: none;'><a href="DbPool.html#cacheColumns">cacheColumns</a></li><li data-type='method' style='display: none;'><a href="DbPool.html#cacheIndexes">cacheIndexes</a></li><li data-type='method' style='display: none;'><a href="DbPool.html#closeDb">closeDb</a></li><li data-type='method' style='display: none;'><a href="DbPool.html#configure">configure</a></li><li data-type='method' style='display: none;'><a href="DbPool.html#convertError">convertError</a></li><li data-type='method' style='display: none;'><a href="DbPool.html#exists">exists</a></li><li data-type='method' style='display: none;'><a href="DbPool.html#nextToken">nextToken</a></li><li data-type='method' style='display: none;'><a href="DbPool.html#openDb">openDb</a></li><li data-type='method' style='display: none;'><a href="DbPool.html#prepare">prepare</a></li><li data-type='method' style='display: none;'><a href="DbPool.html#prepareOptions">prepareOptions</a></li><li data-type='method' style='display: none;'><a href="DbPool.html#prepareQuery">prepareQuery</a></li><li data-type='method' style='display: none;'><a href="DbPool.html#query">query</a></li><li data-type='method' style='display: none;'><a href="DbPool.html#shutdown">shutdown</a></li></ul></li><li><a href="DbRequest.html">DbRequest</a><ul class='methods'><li data-type='method' style='display: none;'><a href="DbRequest.html#column">column</a></li></ul></li><li><a href="FakeTrace.html">FakeTrace</a></li><li><a href="FetchRequest.html">FetchRequest</a><ul class='methods'><li data-type='method' style='display: none;'><a href="FetchRequest.html#parseCookies">parseCookies</a></li><li data-type='method' style='display: none;'><a href="FetchRequest.html#toJSON">toJSON</a></li></ul></li><li><a href="Histogram.html">Histogram</a></li><li><a href="LRUCache.html">LRUCache</a><ul class='methods'><li data-type='method' style='display: none;'><a href="LRUCache.html#.clean">clean</a></li><li data-type='method' style='display: none;'><a href="LRUCache.html#.del">del</a></li><li data-type='method' style='display: none;'><a href="LRUCache.html#.get">get</a></li><li data-type='method' style='display: none;'><a href="LRUCache.html#.put">put</a></li></ul></li><li><a href="Meter.html">Meter</a></li><li><a href="Pool.html">Pool</a></li><li><a href="SqlPool.html">SqlPool</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SqlPool.html#nextToken">nextToken</a></li><li data-type='method' style='display: none;'><a href="SqlPool.html#prepare">prepare</a></li><li data-type='method' style='display: none;'><a href="SqlPool.html#prepareUpdateExpr">prepareUpdateExpr</a></li><li data-type='method' style='display: none;'><a href="SqlPool.html#prepareUpsertExpr">prepareUpsertExpr</a></li><li data-type='method' style='display: none;'><a href="SqlPool.html#query">query</a></li></ul></li><li><a href="Timer.html">Timer</a></li><li><a href="TokenBucket.html">TokenBucket</a><ul class='methods'><li data-type='method' style='display: none;'><a href="TokenBucket.html#.configure">configure</a></li><li data-type='method' style='display: none;'><a href="TokenBucket.html#.consume">consume</a></li><li data-type='method' style='display: none;'><a href="TokenBucket.html#.equal">equal</a></li><li data-type='method' style='display: none;'><a href="TokenBucket.html#.toArray">toArray</a></li><li data-type='method' style='display: none;'><a href="TokenBucket.html#.toJSON">toJSON</a></li><li data-type='method' style='display: none;'><a href="TokenBucket.html#.toString">toString</a></li></ul></li><li><a href="Trace.html">Trace</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Trace.html#.destroy">destroy</a></li><li data-type='method' style='display: none;'><a href="Trace.html#.send">send</a></li><li data-type='method' style='display: none;'><a href="Trace.html#.start">start</a></li><li data-type='method' style='display: none;'><a href="Trace.html#.stop">stop</a></li><li data-type='method' style='display: none;'><a href="Trace.html#.toString">toString</a></li></ul></li><li><a href="module.exports.html">exports</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module.exports.html#delay">delay</a></li></ul></li><li><a href="module-cache.CacheClient.html">CacheClient</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-cache.CacheClient.html#applyOptions">applyOptions</a></li><li data-type='method' style='display: none;'><a href="module-cache.CacheClient.html#applyReservedOptions">applyReservedOptions</a></li><li data-type='method' style='display: none;'><a href="module-cache.CacheClient.html#clear">clear</a></li><li data-type='method' style='display: none;'><a href="module-cache.CacheClient.html#close">close</a></li><li data-type='method' style='display: none;'><a href="module-cache.CacheClient.html#del">del</a></li><li data-type='method' style='display: none;'><a href="module-cache.CacheClient.html#get">get</a></li><li data-type='method' style='display: none;'><a href="module-cache.CacheClient.html#incr">incr</a></li><li data-type='method' style='display: none;'><a href="module-cache.CacheClient.html#limiter">limiter</a></li><li data-type='method' style='display: none;'><a href="module-cache.CacheClient.html#lock">lock</a></li><li data-type='method' style='display: none;'><a href="module-cache.CacheClient.html#put">put</a></li><li data-type='method' style='display: none;'><a href="module-cache.CacheClient.html#stats">stats</a></li><li data-type='method' style='display: none;'><a href="module-cache.CacheClient.html#unlock">unlock</a></li></ul></li><li><a href="module-cache.LocalClient.html">LocalClient</a></li><li><a href="module-cache.WorkerClient.html">WorkerClient</a></li><li><a href="module-push.WebpushClient.html">WebpushClient</a></li><li><a href="module-queue.EventBridgeClient.html">EventBridgeClient</a></li><li><a href="module-queue.JSONClient.html">JSONClient</a></li><li><a href="module-queue.LocalClient.html">LocalClient</a></li><li><a href="module-queue.QueueClient.html">QueueClient</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-queue.QueueClient.html#channel">channel</a></li><li data-type='method' style='display: none;'><a href="module-queue.QueueClient.html#monitor">monitor</a></li><li data-type='method' style='display: none;'><a href="module-queue.QueueClient.html#schedule">schedule</a></li></ul></li><li><a href="module-queue.SNSClient.html">SNSClient</a></li><li><a href="module-queue.SQSClient.html">SQSClient</a></li><li><a href="module-queue.WorkerClient.html">WorkerClient</a></li></ul><h3>Global</h3><ul><li><a href="global.html#ConfigOptions">ConfigOptions</a></li><li><a href="global.html#DBConfigOptions">DBConfigOptions</a></li><li><a href="global.html#DbRequestColumn">DbRequestColumn</a></li><li><a href="global.html#DbRequestOptions">DbRequestOptions</a></li><li><a href="global.html#DbResultCallback">DbResultCallback</a></li><li><a href="global.html#DbTable">DbTable</a></li><li><a href="global.html#DbTableColumn">DbTableColumn</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">lib/fetch.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*
 *  Author: Vlad Seryakov vseryakov@gmail.com
 *  backendjs 2018
 */
const url = require("url");
const path = require('path');
const fs = require('fs');
const http = require('http');
const https = require('https');
const qs = require("qs");
const lib = require(__dirname + '/../lib');
const logger = require(__dirname + '/../logger');

/**
 * Make requests using HTTP(S) and pass it to the callback if provided
 *
 * @param {string|object} uri - can be full URL or an object with `url:`
 * @param {FetchRequest} [params] - customize request with options, see {@link module:lib.FetchRequest}
 * @param {function} [callback] - callback as (err, request) where request is {FetchRequest} object combined with input params and updated fields
 *
 * @example
 * lib.fetch("http://api.host.com/user/123", (err, req) => {
 *    if (req.status == 200) console.log(req.obj);
 * });
 * @memberof module:lib
 * @method fetch
 */
lib.fetch = function(uri, params, callback)
{
    logger.dev("fetch:", uri, params, callback);
    if (typeof params == "function") callback = params, params = null;
    if (!params &amp;&amp; uri?.url) params = uri, uri = uri.url;

    if (!(params instanceof FetchRequest)) {
        logger.dev("httpNew:", uri, params, callback);
        params = new FetchRequest(params);
    }

    params.init(uri);
    var opts = params.open(callback);
    if (!opts) return;
    logger.dev("httpStart:", uri, opts);

    try {
        var mod = opts.protocol == "https:" ? https : http;
        var req = mod.request(opts, (res) => {
            if (!params.binary &amp;&amp; !params.stream &amp;&amp; !params.file) {
                res.setEncoding("utf8")
            }
            res.on("data", (chunk) => {
                params.onData(res, chunk);
            });
            res.on("end", () => {
                params.onEnd(res, callback);
            });
            res.on("close", () => {
                if (!res.complete) params.onEnd(res, callback);
            });
        });
        req.on('error', (err) => {
            params.onError(err, callback);
        });
        req.on("timeout", () => {
            req.destroy(lib.newError("timeout", 529, "ETIMEDOUT"));
        });
        req.once('response', () => {
          params.ip = req.socket?.localAddress;
        });
    } catch (e) {
        return params.onError(e, callback);
    }
    if (params.hardTimeout) {
        params._timer = setTimeout(() => { req.destroy(lib.newError("timeout", 529, "ETIMEDOUT")) }, params.hardTimeout);
    }
    if (params.postdata) {
        req.write(params.postdata);
    } else
    if (params.poststream) {
        params.poststream.pipe(req);
        return req;
    }
    req.end();
    return req;
}

/**
 * Request object to support {@link module:lib.fetch}
 * @param {object} options - properties from FetchRequest
 *
 * @property {string} method - GET, POST
 * @property {int} port - port to use for localhost if no full URI is provided
 * @property {object} headers - object with headers to pass to HTTP request, properties must be all lower case
 * @property {object} cookies - an object with cookies to send with request, if even empty rescookies will be set in the response
 * @property {string} file - file name where to save response, in case of error response the error body will be saved as well, it uses sync file operations
 * @property {object} stream - a writable stream where to save data
 * @property {object} formdata - data to be sent with the request as x-www-form-urlencoded
 * @property {object} postdata - data to be sent with the request in the body as JSON
 * @property {string} postfile - file to be uploaded in the POST body, not as multipart
 * @property {int} postsize - file size to be uploaded if obtained separately
 * @property {string} posttype - content type for post data
 * @property {object[]} multipart - an array of objects for multipart/form-data post, { name: "..", data: ".." [ file: ".."] }, for files a Buffer can be used in data
 * @property {boolean} noparse - do not parse known content types like json, xml
 * @property {boolean} chunked - post files using chunked encoding
 * @property {object} qsopts - an object to be passed to `qs.stringify`
 * @property {object} query - additional query parameters to be added to the url as an object or as encoded string
 * @property {function} signer - a function to sign the request signer(this)
 * @property {boolean} checksum - if true the body needs a checksum in the signature
 * @property {Date|int} mtime - a Date or timestamp to be used in conditional requests
 * @property {boolan} conditional - add If-Modified-Since header using `params.mtime` if present or if `file` is given use file last modified timestamp, mtime
 * @property {int} httpTimeout - timeout in milliseconds after which the request is aborted if no data received
 * @property {int} hardTimeout - abort the request after this amount of time in ms, must be big enough to allow for all data to be received
 * @property {int} maxSize - if the content being downloaded becomes greater than this size the request will be aborted
 * @property {int} retryCount - how many times to retry the request on error or timeout
 * @property {int} retryTimeout - timeout in milliseconds for retries, with every subsequent timeout it will be multiplied by `retryMultiplier`
 * @property {boolean|function} retryOnError - retry request if received non 2xx response status,
 *       if this is a function then it must return true in order to retry the request,
 *       otherwise it is treated as a boolean value, if true then retry on all non-2xx responses
 * @property {function} retryPrepare - a function to be called before retrying, it can update any parameter, most related: _uri, retryTimeout, retryMultiplier
 * @property {int} errorCount - how many times to retry on aborted connections, default is retryCount
 * @property {boolean} raise - on not ok status raise and eror on return with JSON body if present or generic message
 * @property {boolean} noredirects - if true then do not follow redirect locations for 30-[1,2,3,7] statuses
 * @property {function} preparse -  a function to be called before parsing the xml/json content, called in the context of the http object
 * @property {string[]} passheaders -  a list of headers to be passed in redirects
 * @property {string} user - authorization user, if also `password`` is provided then it will use Basic authorization, if only user is provided then Bearer
 * @property {string} data - response data if file was not specified
 * @property {object} obj - if the content type is a known type like json or xml this property will hold a reference to the parsed document or null in case or parse error
 * @property {int} status - HTTP response status code
 * @property {Date} date - Date object with the last modified time of the requested file
 * @property {object} resheaders - response headers as an object
 * @property {object} rescookies - parsed cookies from the response if request `cookies`` is not empty
 * @property {int} size - size of the response body or file
 * @property {string} type - response content type
 * @property {boolean} ok - true if the status is between 200 and 299
 */
class FetchRequest {

    constructor(options)
    {
        for (const p in options) this[p] = options[p];
    }

    init(uri)
    {
        this._done = 0;
        this._uri = uri;
        var qtype = lib.typeName(this.query);
        switch (lib.typeName(uri)) {
        case "object":
            uri = url.format(uri);
            break;

        default:
            uri = String(uri);
            var q = qtype == "object" ? qs.stringify(this.query, this.qsopts) : qtype == "string" ? this.query : "";
            if (!q) break;
            uri += (uri.indexOf("?") == -1 ? "?" : "") + (q[0] == "&amp;" ? "" : "&amp;") + q;
        }

        this.uri = uri;
        this.size = 0;
        this.err = null;
        this.fd = 0;
        this.status = 0;
        this.ok = false;
        this.poststream = null;
        this.date = null;
        this.obj = null;
        this.method = this.method || 'GET';
        this.headers = this.headers || {};
        this.resheaders = {};
        this.stime = Date.now();
        this.data = this.binary ? Buffer.alloc(0) : '';
        this.redirects = lib.toNumber(this.redirects, { min: 0 });
        this.retryCount = lib.toNumber(this.retryCount, { min: 0 });
        this.retryTotal = this.retryTotal || this.retryCount;
        this.retryTimeout = lib.toNumber(this.retryTimeout, { min: 0, dflt: 500 });
        this.retryMultiplier = lib.toNumber(this.retryMultiplier, { min: 1, dflt: 2 });
        this.httpTimeout = lib.toNumber(this.httpTimeout, { min: 0, dflt: 60000 });
        this.hardTimeout = lib.toNumber(this.hardTimeout, { min: 0 });
        this.warnTimeout = lib.toNumber(this.warnTimeout, { min: 0, dflt: 30000 });
        this.errorCount = lib.toNumber(this.errorCount, { min: 0, dflt: this.retryCount });
    }

    open(callback)
    {
        var cols = ["protocol","href","pathname","host","hostname","port","search"];

        var opts = {};

        var u = URL.parse(this.uri);
        if (u) {
            for (const c of cols) opts[c] = u[c];
        }

        opts.method = this.method;
        opts.headers = this.headers;
        opts.agent = this.agent || null;
        opts.rejectUnauthorized = false;
        opts.timeout = this.httpTimeout;

        for (const c of cols) this[c] = opts[c];
        for (const p in this.headers) {
            if (lib.isEmpty(this.headers[p])) delete this.headers[p];
        }

        // Use file name from the url when only the path is given
        if (this.file &amp;&amp; this.file[this.file.length - 1] == "/") {
            this.file += path.basename(this.pathname);
        }

        if (this.method == "POST" &amp;&amp; !this.headers["content-type"]) {
            this.headers["content-type"] = this.posttype || "application/x-www-form-urlencoded";
        }
        if (!this.headers.accept) {
            this.headers.accept = '*/*';
        }
        if (this.user) {
            if (this.password) {
                this.headers.authorization = "Basic " + Buffer.from(this.user + ":" + this.password).toString("base64");
            } else {
                this.headers.authorization = "Bearer " + this.user;
            }
        }
        if (this.cookies) {
            this.headers.cookie = lib.objKeys(this.cookies).map((x) => (x + "=" + this.cookies[x])).join("; ");
        }

        if (!this.prepare(callback)) return null;
        opts.method = this.method;

        // Set again if possibly changed
        for (const i in cols) this[cols[i]] = opts[cols[i]];

        logger.dev("httpOpen:", this.method, this.uri, "HDR:", this.headers, "POST:", this.postsize, this.postdata);

        return opts;
    }

    prepare(callback)
    {
        // Data to be sent over in the body
        if (!this.preparePost(callback)) return;

        // Conditional, time related
        if (!this.prepareConditional(callback)) return;

        // Make sure our data is not corrupted
        if (this.checksum) {
            this.checksum = this.postdata ? lib.hash(this.postdata) : null;
        }
        if (typeof this.signer == "function") {
            this.signer.call(this);
        }
        return true;
    }

    preparePost(callback)
    {
        switch (lib.typeName(this.formdata)) {
        case "object":
        case "array":
            this.method = "POST";
            this.postdata = qs.stringify(this.formdata, this.qsopts);
            this.headers['content-type'] = "application/x-www-form-urlencoded";
            break;
        }
        if (lib.isArray(this.multipart)) {
            this.boundary = lib.uuid();
            var buf = [];
            for (const i in this.multipart) {
                var part = this.multipart[i];
                if (!part || !part.name) continue;
                var data = `--${this.boundary}\r\nContent-Disposition: form-data; name="${part.name}"`;
                data += part.file ? `; filename="${path.basename(part.file)}"\r\n` : "\r\n";
                if (Buffer.isBuffer(part.data)) {
                    data += `Content-Type: ${part.type || "application/octet-stream"}\r\n\r\n`;
                    buf.push(Buffer.from(data));
                    buf.push(part.data);
                    buf.push(Buffer.from(`\r\n`));
                } else {
                    data += `\r\n${part.data || ""}\r\n`;
                    buf.push(Buffer.from(data));
                }
            }
            buf.push(Buffer.from(`--${this.boundary}--`));
            this.method = "POST";
            this.postdata = Buffer.concat(buf);
            this.headers["content-type"] = `multipart/form-data; boundary=${this.boundary}`;
            this.headers['content-length'] = this.postdata.length;
        } else
        if (this.postdata) {
            switch (lib.typeName(this.postdata)) {
            case "string":
                this.headers['content-length'] = Buffer.byteLength(this.postdata, 'utf8');
                break;
            case "buffer":
                this.headers['content-length'] = this.postdata.length;
                break;
            case "object":
            case "array":
                this.postdata = lib.stringify(this.postdata);
                this.headers['content-type'] = "application/json; charset=utf-8";
                this.headers['content-length'] = Buffer.byteLength(this.postdata, 'utf8');
                break;
            default:
                this.postdata = String(this.postdata);
                this.headers['content-length'] = Buffer.byteLength(this.postdata, 'utf8');
            }
        } else
        if (this.postfile) {
            if (this.method == "GET") this.method = "POST";
            if (this.chunked) {
                this.headers['transfer-encoding'] = 'chunked';
            } else {
                if (typeof this.postsize != "number") {
                    fs.stat(this.postfile, (err, stats) => {
                        if (err) return callback(err, this);
                        this.mtime = stats.mtime.getTime();
                        this.postsize = stats.size;
                        lib.fetch(this.uri, this, callback);
                    });
                    return;
                }
                this.headers['content-length'] = this.postsize;
            }
            this.poststream = fs.createReadStream(this.postfile);
            this.poststream.on("error", (err) => {
                logger.error('httpStream:', err.stack)
            });
        }
        return true;
    }

    prepareConditional(callback)
    {
        if (this.conditional) {
            delete this.conditional;
            if (this.mtime) {
                this.headers["if-modified-since"] = lib.toDate(this.mtime).toUTCString();
            } else

            if (this.file) {
                fs.stat(this.file, (err, stats) => {
                    if (!err &amp;&amp; stats.size > 0) {
                        this.mtime = stats.mtime.getTime();
                        this.headers["if-modified-since"] = lib.toDate(this.mtime).toUTCString();
                    }
                    lib.fetch(this.uri, this, callback);
                });
                return;
            }
        }
        return true;
    }

    onData(res, chunk)
    {
        if (this.stream) {
            this.writeStream(res, chunk);
        } else
        if (this.file) {
            this.writeFile(res, chunk);
        } else
        if (this.binary) {
            this.data = Buffer.concat([this.data, chunk]);
        } else {
            this.data += chunk.toString();
        }
        this.size += chunk.length;
        logger.dev("httpData:", this.toJSON());
        if (this.maxSize > 0 &amp;&amp; this.size > this.maxSize) res.req.abort();
    }

    writeStream(res, chunk)
    {
        try {
            this.stream.write(chunk);
        } catch (e) {
            this.err = e;
            res.req.abort();
        }
    }

    writeFile(res, chunk)
    {
        try {
            if (!this.fd &amp;&amp; res.statusCode >= 200 &amp;&amp; res.statusCode &lt; 300) {
                this.fd = fs.openSync(this.file, 'w');
            }
            if (this.fd) {
                fs.writeSync(this.fd, chunk, 0, chunk.length, null);
            }
        } catch (e) {
            logger.error("httpWriteFile:", e, this.toJSON());
            this.err = e;
            res.req.abort();
        }
    }

    onError(err, callback)
    {
        this.close();
        if (this._done) return;
        if (!this.quiet) logger.logger(this.errorCount ? "debug" : "error", "httpError:", err, this.toJSON({ query: 1, postdata: 256, data: 256 }));

        if (this.errorCount-- > 0) {
            this.lastError = err;
            if (typeof this.retryPrepare == "function") this.retryPrepare.call(this);
            setTimeout(lib.fetch.bind(null, this._uri, this, callback), lib.objMult(this, "retryTimeout", this.retryMultiplier, "old"));
            if (this.warnTimeout &amp;&amp; this.retryTimeout >= this.warnTimeout) logger.warn("httpRetry:", err, this.toJSON({ query: 1, postdata: 256, data: 256 }));
        } else {
            err.status = this.status = this._done = 529;
            if (typeof callback == "function") callback(err, this);
        }
    }

    onEnd(res, callback)
    {
        this.close();
        if (this._done) return;
        logger.dev("httpEnd:", this.toJSON({ postdata: 256, data: 256 }));

        var headers = this.resheaders = res.headers || {};
        this.status = res.statusCode || 0;
        this.ok = this.status >= 200 &amp;&amp; this.status &lt; 300;
        this.type = (headers['content-type'] || '').split(';')[0];
        this.date = headers.date ? lib.toDate(headers.date) : null;
        if (!this.size) this.size = lib.toNumber(headers['content-length'] || 0);
        if (this.cookies) this.rescookies = this.parseCookies(headers["set-cookie"]);

        // Retry the same request on status codes configured explicitely
        if ((this.status &lt; 200 || this.status >= 400) &amp;&amp;
            ((typeof this.retryOnError == "function" &amp;&amp; this.retryOnError.call(this)) || lib.toBool(this.retryOnError)) &amp;&amp;
            this.retryCount-- > 0) {
            this.lastError = `${this.status}: ${this.data}`;
            if (!this.quiet) logger.debug("httpRetry:", this.toJSON({ query: 1, postdata: 256, data: 256 }));
            if (typeof this.retryPrepare == "function") this.retryPrepare.call(this);
            setTimeout(lib.fetch.bind(null, this._uri, this, callback), lib.objMult(this, "retryTimeout", this.retryMultiplier, "old"));
            if (this.warnTimeout &amp;&amp; this.retryTimeout >= this.warnTimeout) logger.warn("httpRetry:", this.toJSON({ query: 1, postdata: 256, data: 256 }));
            this._done = this.status || 1;
            return;
        }
        if (this.checkRedirect(callback)) return;

        // If the contents are encrypted, decrypt before processing content type
        if (headers['content-encoding'] == "encrypted" &amp;&amp; this.secret) {
            this.data = lib.decrypt(this.secret, this.data);
        }

        if (typeof this.preparse == "function") this.preparse.call(this);

        // Parse JSON and store in the params, set error if cannot be parsed, the caller will deal with it
        if (this.data &amp;&amp; !this.noparse) {
            var opts = { datatype: this.datatype, logger: this.datalogger, url: this.uri };
            switch (this.type) {
            case "text/json":
            case "application/json":
            case "application/x-amz-json-1.0":
            case "application/x-amz-json-1.1":
            case "application/problem+json":
                for (const p in this) if (p.substr(0, 5) == "json_") opts[p.substr(5)] = this[p];
                this.obj = lib.jsonParse(this.data, opts);
                break;

            case "text/xml":
            case "application/xml":
            case "application/rss+xml":
            case "application/problem+xml":
                for (const p in this) if (p.substr(0, 4) == "xml_") opts[p.substr(4)] = this[p];
                this.obj = lib.xmlParse(this.data, opts);
                break;
            }
        }
        logger.debug("httpDone:", this.toJSON());

        // Return an error on status
        if ((this.status &lt; 200 || this.status > 299) &amp;&amp; !this.err &amp;&amp; this.raise) {
            if (this.obj?.message) {
                this.err = this.obj;
                this.err.status = this.status;
            } else
            if (!lib.isEmpty(this.obj)) {
                this.err = { message: lib.objDescr(this.obj), status: this.status };
            } else {
                this.err = { message: "Error " + this.status + (this.data ? ": " + this.data : ""), status: this.status };
            }
            if (this.err.status == 429 &amp;&amp; !this.err.code) this.err.code = "OverCapacity";
        }


        this._done = 1;
        if (typeof callback == "function") callback(this.err, this);
    }

    close()
    {
        this.etime = Date.now();
        this.elapsed = this.etime - this.stime;
        clearTimeout(this._timer);
        delete this._timer;
        if (this.fd) {
            try { fs.closeSync(this.fd); } catch (e) {}
            this.fd = 0;
        }
        if (this.stream) {
            try { this.stream.end(this.onFinish); } catch (e) {}
            delete this.stream;
        }
    }

    /**
     * Return a simplified object for logging purposes
     */
    toJSON(options)
    {
        var rc = {
            role: this.role,
            method: this.method,
            url: this.uri,
            _uri: this._uri,
            status: this.status,
            size: this.size,
            type: this.type,
            elapsed: this.elapsed,
            retryTotal: this.retryTotal,
            retryCount: this.retryCount,
            retryTimeout: this.retryTimeout,
            retryOnError: this.retryOnError ? 1 : 0,
            errorCount: this.errorCount,
            httpTimeout: this.httpTimeout,
            lastError: this.lastError,
            date: this.date,
        };
        if (this.ip) rc.ip = this.ip;
        if (this.file) rc.file = this.file;
        if (this.resheaders.location) rc.location = this.resheaders.location;
        if (options) {
            if (options.postdata > 0 &amp;&amp; typeof this.postdata == "string") {
                rc.postdata = this.postdata.substr(0, options.postdata);
            }
            if (options.query) rc.query = this.query;
            if (options.data > 0 &amp;&amp; typeof this.data == "string") {
                rc.data = this.data.substr(0, options.data);
            }
            if (options.obj &amp;&amp; this.obj) rc.obj = this.obj;
            for (const p in options.headers) rc[options.headers[p]] = this.headers[options.headers[p]];
            for (const p in options.resheaders) rc[options.resheaders[p]] = this.resheaders[options.resheaders[p]];
        }
        return rc;
    }

    checkRedirect(callback)
    {
        switch (this.status) {
        case 301:
        case 302:
        case 303:
        case 307:
        case 308:
            if (this.noredirects) break;
            if (++this.redirects >= 10) break;
            var uri = this.resheaders.location || "";
            if (uri.indexOf("://") == -1) uri = this.uri.split("/").slice(0, 3).join("/") + uri;
            var cols = ['method','query','postdata','postfile','poststream','signer','checksum'];
            for (const c of cols) delete this[c];
            var headers = {};
            for (const i in this.passheaders) headers[this.passheaders[i]] = this.headers[this.passheaders[i]];
            this.headers = headers;
            lib.fetch(uri, this, callback);
            return true;
        }
    }

    /**
     * Parse Set-Cookie header and return an object of cookies: { NAME: { value: VAL, secure: true, expires: N ... } }
     */
    parseCookies(header)
    {
        var cookies = {};
        header = Array.isArray(header) ? header.filter((x) => (typeof x == "string")) :
                 typeof header == "string" ? header.split(/[:](?=\s*[a-zA-Z0-9_-]+\s*[=])/g) : [];
        for (const p of header) {
            const parts = p.split(";");
            let pair = parts[0].match(/([^=]+)=((?:.|\n)*)/);
            if (!pair) continue;
            const name = pair[1], cookie = { value: pair[2] || "" };
            for (let i = 1; i &lt; parts.length; i++) {
                pair = parts[i].match(/([^=]+)(?:=((?:.|\n)*))?/);
                if (!pair) continue;
                const key = pair[1].trim().toLowerCase();
                const value = pair[2] &amp;&amp; pair[2].trim();
                switch (key) {
                case "expires":
                    if (value) cookie.expires = lib.toMtime(value);
                    break;

                case "path":
                case "domain":
                    if (value) cookie[key] = value;
                    break;

                case "samesite":
                    if (value) cookie.sameSite = value;
                    break;

                case "secure":
                    cookie.secure = true;
                    break;

                case "httponly":
                    cookie.httpOnly = true;
                    break;
                }
            }
            cookies[name] = cookie;
        }
        return cookies;
    }

}

/**
 * Async/await version of {@link module:lib.fetch}, never rejects meaning no exceptions
 * @param {string} uri - can be full URL or an object with parts of the url, same format as in url.format
 * @param {FetchRequest} [params] - customize request
 * @return {object} - result as an object `{ err, data, obj, req }` where data/obj are properties fro the req for convenience
 *
 * @example
 * const { err, data } = await lib.afetch("http://api.host.com/file.txt");
 * const { err, obj } = await lib.afetch("http://api.host.com/user/123");
 * const { err, obj } = await lib.afetch({ url: "http://api.host.com/user/123", method: "POST", postdata: { name: "myname" } });
 * @method afetch
 * @memberOf module:lib
 * @async
 */
lib.afetch = function(uri, params)
{
    return new Promise((resolve, reject) => {
        lib.fetch(uri, params, (err, req) => {
            resolve({ err, data: req.data, obj: req.obj, req });
        });
    });
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a> using the <a href="https://github.com/vseryakov/docdash">docdash</a> theme.
</footer>


<script src="scripts/search.js" defer></script>



<script src="scripts/collapse.js" defer></script>



</body>
</html>
